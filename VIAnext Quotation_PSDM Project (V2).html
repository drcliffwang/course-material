<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IC Service AI Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX in-browser transpile -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <!-- Lucide Icons UMD -->
  <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
  <style>
    /* 使用更適合數據顯示的字體 */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    html, body, #root { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      background-color: #f1f5f9; /* 使用柔和的淺灰色背景 */
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
    }
    /* 讓 Lucide Icons 的預設大小更合適 */
    .lucide {
      width: 1em;
      height: 1em;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // --- UI 元件 (UI Primitives) ---
    const Icon = ({ name, className = "" }) => {
      if (!window.lucide || !window.lucide.icons[name]) return null;
      return React.createElement(window.lucide.icons[name], { className });
    };

    const Card = ({ children, className = "" }) => (
      <div className={`bg-white border border-slate-200 rounded-lg shadow-sm ${className}`}>{children}</div>
    );
    const CardHeader = ({ children, className = "" }) => <div className={`p-5 border-b border-slate-200 ${className}`}>{children}</div>;
    const CardTitle = ({ children }) => <h3 className="text-base font-semibold text-slate-800 flex items-center gap-2">{children}</h3>;
    const CardContent = ({ children, className = "" }) => <div className={`p-5 ${className}`}>{children}</div>;

    const Button = ({ children, onClick, variant = 'primary', size = 'md', className = '', disabled = false }) => {
      const base = "inline-flex items-center justify-center gap-2 font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150";
      const variants = {
        primary: 'bg-slate-800 text-white hover:bg-slate-700 focus:ring-slate-500',
        outline: 'border border-slate-300 bg-transparent hover:bg-slate-100 text-slate-700 focus:ring-slate-400',
        ghost: 'bg-transparent hover:bg-slate-100 text-slate-700 focus:ring-slate-400'
      };
      const sizes = {
        sm: 'px-3 py-1.5 text-xs',
        md: 'px-4 py-2 text-sm'
      };
      return <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${sizes[size]} ${className} disabled:opacity-50 disabled:cursor-not-allowed`}>{children}</button>;
    };

    const Input = (props) => <input {...props} className={`block w-full px-3 py-2 text-sm border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition ${props.className||''}`} />;
    const Label = ({ children, ...props }) => <label {...props} className="block text-xs font-medium text-slate-600 mb-1">{children}</label>;
    const Select = ({ children, ...props }) => (
      <select {...props} className="block w-full px-3 py-2 text-sm bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition">
        {children}
      </select>
    );
    const Slider = ({ value, onChange, ...props }) => (
      <input type="range" value={value} onChange={e => onChange([Number(e.target.value)])} {...props} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-700" />
    );
    
    // --- 主應用程式 (App) ---
    function ICBackendQuotationDashboard() {
      // --- 狀態與常數 (與原始檔案相同) ---
      const XLSX = window.XLSX || null;

      const COUNTRIES = ["Taiwan", "China", "United States", "Japan", "Malaysia", "Philippines", "Vietnam", "South Korea", "Thailand", "Singapore"];
      const SEGMENTS = ["AI Accelerator", "FPGA Vision", "Other"];
      const PACKAGES = ["FCBGA", "CoWoS-S", "CoWoS-L", "2.5D + Si Interposer", "FOPLP", "Fan-Out"];

      const labelMap = {
        projectName: "專案名稱", customer: "客戶", segment: "產品別", packageType: "封裝型態",
        dieCount: "Die 數", nodeNm: "製程節點 (nm)", waferCostPerDie: "Wafer 成本/Die (USD)",
        substrateCost: "基板成本 (USD)", interposerCost: "中介層/Si Interposer (USD)",
        bumpingCost: "凸點/鍍錫 (USD)", assemblyCost: "組裝成本 (USD)", testCost: "測試成本 (USD)",
        yieldWafer: "良率-前段 (%)", yieldAssembly: "良率-組裝 (%)", yieldFinal: "良率-最終 (%)",
        outboundLogistics: "出貨物流 (USD)", insurance: "保險 (USD)", otherVariable: "其他變動費 (USD)",
        fxTWDperUSD: "匯率 TWD/USD", paymentTermsDays: "付款條件 (天)", targetGM: "目標毛利率 (%)",
        riskAddon: "風險加成 (%)", incoterm: "Incoterm", hsCode: "HS Code",
        frontEndCountry: "前段國別", assemblyCountry: "封裝國別", testCountry: "測試國別",
        shipToCountry: "出貨目的地", cooOverride: "產地判定 (COO)",
      };

      const DEFAULT_INPUTS = {
        projectName: "Demo_2025Q3", customer: "ACME", segment: "AI Accelerator", packageType: "CoWoS-L",
        dieCount: 2, nodeNm: 5, waferCostPerDie: 1200, substrateCost: 180, interposerCost: 350,
        bumpingCost: 75, assemblyCost: 220, testCost: 110, yieldWafer: 97, yieldAssembly: 95,
        yieldFinal: 98, outboundLogistics: 40, insurance: 5, otherVariable: 0, fxTWDperUSD: 32.5,
        paymentTermsDays: 45, targetGM: 25, riskAddon: 3, incoterm: "FOB", hsCode: "8542.31",
        frontEndCountry: "Taiwan", assemblyCountry: "Taiwan", testCountry: "Taiwan", shipToCountry: "China",
        cooOverride: "auto",
      };
      const DEFAULT_TARIFFS = [
        ["United States", "China", "^8542\\.", "US Section 301 (2025)", 50, "2025-08-01"],
        ["United States", "Taiwan", "^8542\\.", "US MFN (2025)", 0, "2025-01-01"],
        ["United States", "Japan", "^8542\\.", "US MFN (2025)", 0, "2025-01-01"],
        ["China", "China", ".*", "PRC Import (domestic)", 0, "2025-01-01"],
        ["Taiwan", "Taiwan", ".*", "TW Import (domestic)", 0, "2025-01-01"],
      ];
      const DEFAULT_SCENARIOS = [
        { name: "TW-only Backend", frontEndCountry: "Taiwan", assemblyCountry: "Taiwan", testCountry: "Taiwan", shipToCountry: "China", assumedCOO: "auto" },
        { name: "CN Backend (US dest w/China COO)", frontEndCountry: "Taiwan", assemblyCountry: "China", testCountry: "China", shipToCountry: "United States", assumedCOO: "China" },
        { name: "ASEAN via Amkor (US dest, TW COO)", frontEndCountry: "Taiwan", assemblyCountry: "Malaysia", testCountry: "Philippines", shipToCountry: "United States", assumedCOO: "Taiwan" },
      ];

      const [activeTab, setActiveTab] = useState('inputs');
      const [inputs, setInputs] = useState(DEFAULT_INPUTS);
      const [tariffs, setTariffs] = useState(DEFAULT_TARIFFS);
      const [scenarios, setScenarios] = useState(DEFAULT_SCENARIOS);
      const [analysis, setAnalysis] = useState("");
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      
      // --- 核心計算邏輯 (Core Calculation Logic) ---
      const baseCost = useMemo(() => {
        const yW = Math.max(Number(inputs.yieldWafer) / 100, 1e-6);
        const yA = Math.max(Number(inputs.yieldAssembly) / 100, 1e-6);
        const yF = Math.max(Number(inputs.yieldFinal) / 100, 1e-6);
        const mfg = (Number(inputs.waferCostPerDie) / yW)
                  + (Number(inputs.assemblyCost) / yA)
                  + (Number(inputs.testCost) / yF)
                  + Number(inputs.substrateCost)
                  + Number(inputs.interposerCost)
                  + Number(inputs.bumpingCost)
                  + Number(inputs.outboundLogistics)
                  + Number(inputs.insurance)
                  + Number(inputs.otherVariable);
        return Number.isFinite(mfg) ? mfg : 0;
      }, [inputs]);

      const results = useMemo(() => {
        const inferCOO = (frontEnd, override) => (override && override !== "auto") ? override : (frontEnd || "Taiwan");
        const matchTariffRate = (rows, destination, coo, hsCode) => {
          for (const t of rows) {
            const [dest, origin, pattern, , rate] = t;
            if (dest === destination && origin === coo) {
              try { if (new RegExp(pattern).test(hsCode)) return rate; } catch (e) { console.error("Invalid regex:", pattern); }
            }
          }
          return 0;
        };
        
        return scenarios.map(s => {
          const coo = inferCOO(s.frontEndCountry, s.assumedCOO);
          const rate = matchTariffRate(tariffs, s.shipToCountry, coo, inputs.hsCode);
          const tariff = (rate / 100) * baseCost;
          const landed = baseCost + tariff;
          const quoteUSD = landed * (1 + Number(inputs.riskAddon)/100) * (1 / (1 - Number(inputs.targetGM)/100));
          const quoteTWD = quoteUSD * Number(inputs.fxTWDperUSD);
          return { ...s, coo, tariffRate: rate, manufacturingCost: baseCost, tariff, landed, quoteUSD, quoteTWD };
        });
      }, [inputs, tariffs, scenarios, baseCost]);

      const chartData = useMemo(() => results.map(r => ({ name: r.name, USD: Number(r.quoteUSD.toFixed(2)) })), [results]);

      // --- 事件處理器 (Event Handlers) ---
      const handleInputChange = (key, value) => setInputs(p => ({ ...p, [key]: value }));
      const handleTariffChange = (rowIndex, colIndex, value) => {
        setTariffs(prev => {
          const copy = prev.map(r => [...r]);
          copy[rowIndex][colIndex] = value;
          return copy;
        });
      };
      const updateScenario = (idx, field, value) => setScenarios(prev => prev.map((s,i) => i===idx ? { ...s, [field]: value } : s));
      const addScenario = () => setScenarios(prev => ([ ...prev, { name: `New Scenario ${prev.length+1}`, frontEndCountry: inputs.frontEndCountry, assemblyCountry: inputs.assemblyCountry, testCountry: inputs.testCountry, shipToCountry: inputs.shipToCountry, assumedCOO: inputs.cooOverride || 'auto' } ]));
      const resetAll = () => { setInputs(DEFAULT_INPUTS); setTariffs(DEFAULT_TARIFFS); setScenarios(DEFAULT_SCENARIOS); setAnalysis(""); };
      
      const exportXLSX = () => {
        if (!XLSX) { alert("匯出功能尚未就緒（XLSX 未載入）"); return; }
        try {
          const wb = XLSX.utils.book_new();
          const inputsRows = Object.entries(inputs).map(([k,v]) => ({ '項目': (labelMap && labelMap[k]) || k, '數值': v }));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inputsRows), "輸入參數");
          const tHeaders = ["目的地","COO","HS Pattern","方案","稅率%","生效日"];
          const tRows = tariffs.map(t => ({ [tHeaders[0]]: t[0], [tHeaders[1]]: t[1], [tHeaders[2]]: t[2], [tHeaders[3]]: t[3], [tHeaders[4]]: t[4], [tHeaders[5]]: t[5] }));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tRows), "關稅表");
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(scenarios), "場景設定");
          const resultsExport = results.map(r => ({ '場景': r.name, '前段': r.frontEndCountry, '封裝': r.assemblyCountry, '測試': r.testCountry, '目的地': r.shipToCountry, 'COO': r.coo, '關稅率%': r.tariffRate, '製造成本USD': r.manufacturingCost.toFixed(2), '關稅USD': r.tariff.toFixed(2), '到岸成本USD': r.landed.toFixed(2), '建議報價USD': r.quoteUSD.toFixed(2), '建議報價TWD': r.quoteTWD.toFixed(0) }));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(resultsExport), "結果明細");
          XLSX.writeFile(wb, `IC_Backend_Quote_${inputs.projectName || 'Export'}.xlsx`);
        } catch (err) {
          console.error(err);
          alert("匯出失敗：" + (err && err.message ? err.message : err));
        }
      };

      const handleGenerateAnalysis = async () => {
        setIsAnalyzing(true); 
        setAnalysis("");
        const scenariosText = results.map(r => `- 場景: "${r.name}" | 供應鏈: ${r.frontEndCountry}(前段) -> ${r.assemblyCountry}(封裝) -> ${r.testCountry}(測試) -> ${r.shipToCountry}(目的地) | 推定產地(COO): ${r.coo} | 關稅率: ${r.tariffRate}% | 最終報價: $${fmt(r.quoteUSD)} USD`).join('\n');
        const prompt = `作為一名專業的半導體行業市場分析師，請根據以下資訊撰寫市場風險與策略分析。\n專案: ${inputs.projectName} (${inputs.segment}, ${inputs.packageType})\n客戶: ${inputs.customer}\n製造成本: $${fmt(baseCost)} USD\nHS Code: ${inputs.hsCode}\n場景: \n${scenariosText}`;
        
        try {
          const apiKey = ""; 
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
          
          const res = await fetch(apiUrl, { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({ contents: [{ role:'user', parts:[{ text: prompt }] }] }) 
          });
          
          if (!res.ok) {
            const errorBody = await res.json();
            console.error("API Error Response:", errorBody);
            throw new Error(`API 請求失敗，狀態碼: ${res.status}`);
          }
          
          const data = await res.json();
          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '（無法取得分析內容，回應為空）';
          setAnalysis(text);
        } catch (e) {
          console.error(e); 
          setAnalysis(`分析失敗：${e?.message || '未知錯誤'}`);
        } finally { 
          setIsAnalyzing(false); 
        }
      };

      // --- 渲染輔助函式 (Render Helpers) ---
      const fmt = (n, d = 2) => (Number.isNaN(n) || n == null) ? "-" : Number(n).toLocaleString(undefined, { maximumFractionDigits: d, minimumFractionDigits: d });

      const renderInputField = (key, type='number', options={}) => (
        <div>
          <Label htmlFor={key}>{labelMap[key] || key}</Label>
          {type === 'select' ? (
            <Select id={key} value={inputs[key]} onChange={e => handleInputChange(key, e.target.value)}>
              {options.choices.map(c => <option key={c} value={c}>{c}</option>)}
            </Select>
          ) : type === 'country' ? (
            <Select id={key} value={inputs[key]} onChange={e => handleInputChange(key, e.target.value)}>
              {COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}
            </Select>
          ) : type === 'coo' ? (
            <Select id={key} value={inputs[key]} onChange={e => handleInputChange(key, e.target.value)}>
              <option value="auto">自動 (以前段國別推定)</option>
              {COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}
            </Select>
          ) : (
            <Input id={key} type={type} value={inputs[key]} onChange={e => handleInputChange(key, type==='number' ? Number(e.target.value) : e.target.value)} step={options.step || 1} />
          )}
        </div>
      );

      const renderSliderField = (key, max, step) => (
        <div>
          <Label>{labelMap[key] || key}</Label>
          <div className="flex items-center gap-4">
            <Slider value={inputs[key]} onChange={v => handleInputChange(key, v[0])} max={max} step={step} />
            <Input type="number" value={inputs[key]} onChange={e => handleInputChange(key, Number(e.target.value))} className="w-20 text-center" />
          </div>
        </div>
      );

      const Stat = ({ title, value, icon }) => (
        <div className="rounded-lg border bg-white p-4 shadow-sm">
          <div className="flex items-center gap-2 text-sm text-slate-500">
            <Icon name={icon} className="w-4 h-4" />
            <p>{title}</p>
          </div>
          <p className="text-xl font-semibold mt-1 text-slate-800">{value}</p>
        </div>
      );
      
      const TabButton = ({ tabId, label }) => (
        <button 
          onClick={() => setActiveTab(tabId)} 
          className={`whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm transition-colors duration-200 ${activeTab === tabId ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}
        >
          {label}
        </button>
      );
      
      // ** 修正後的簡易長條圖元件 **
      const SimpleBarChart = ({ data }) => {
        if (!data || data.length === 0) {
          return <div className="flex items-center justify-center h-full text-slate-500">沒有可顯示的數據</div>;
        }
        const maxValue = Math.max(...data.map(item => item.USD), 0) * 1.25 || 1;
        return (
          <div className="w-full h-full flex justify-around items-end gap-4 pt-8">
            {data.map((item, index) => (
              <div key={index} className="flex-1 h-full flex flex-col-reverse items-center gap-1">
                <div className="text-xs text-center text-slate-500 h-8 pt-1 w-full break-words">{item.name}</div>
                <div
                  className="w-full bg-slate-400 hover:bg-blue-500 transition-all duration-300 rounded-t-md relative group"
                  style={{ height: `${(item.USD / maxValue) * 100}%` }}
                >
                  <div className="absolute -top-5 left-0 right-0 text-center text-xs font-semibold text-slate-800 opacity-0 group-hover:opacity-100 transition-opacity">${fmt(item.USD)}</div>
                </div>
              </div>
            ))}
          </div>
        );
      };

      // --- 主要渲染 (Main Render) ---
      return (
        <div className="min-h-screen w-full bg-slate-100 p-4 sm:p-6">
          <div className="mx-auto max-w-7xl space-y-6">
            <header className="flex flex-col sm:flex-row items-start justify-between gap-4">
              <div>
                {/* ** 更新後的標題 ** */}
                <h1 className="text-2xl font-bold text-slate-900">IC Service AI Dashboard</h1>
                <p className="text-slate-600 text-sm mt-1">AI 加速器 / FPGA 視覺封裝設計・產地/關稅敏感・三場景比對＋批次模擬</p>
              </div>
              <div className="flex gap-2 flex-shrink-0">
                <Button variant="outline" onClick={resetAll}><Icon name="RotateCcw" />重置</Button>
                <Button onClick={exportXLSX} disabled={!XLSX}>{XLSX ? (<><Icon name="Sheet" />匯出 Excel</>) : '載入中...'}</Button>
              </div>
            </header>
            
            <div className="border-b border-slate-200 bg-white rounded-t-lg shadow-sm">
              <nav className="flex flex-wrap -mb-px" aria-label="Tabs">
                <TabButton tabId="inputs" label="輸入參數" />
                <TabButton tabId="tariffs" label="關稅表" />
                <TabButton tabId="scenarios" label="路徑/場景" />
                <TabButton tabId="results" label="結果/圖表" />
              </nav>
            </div>

            <main>
              {activeTab==='inputs' && (
                <Card>
                  <CardHeader><CardTitle>專案與成本參數</CardTitle></CardHeader>
                  <CardContent>
                    <div className="space-y-8">
                      <fieldset>
                        <legend className="text-sm font-semibold text-slate-700 mb-4 border-b pb-2 w-full">專案基本資訊</legend>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          {renderInputField('projectName','text')}
                          {renderInputField('customer','text')}
                          {renderInputField('segment','select',{choices:SEGMENTS})}
                          {renderInputField('packageType','select',{choices:PACKAGES})}
                        </div>
                      </fieldset>
                      <fieldset>
                        <legend className="text-sm font-semibold text-slate-700 mb-4 border-b pb-2 w-full">成本與良率</legend>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          {renderInputField('dieCount')}
                          {renderInputField('nodeNm')}
                          {renderInputField('waferCostPerDie')}
                          {renderInputField('substrateCost')}
                          {renderInputField('interposerCost')}
                          {renderInputField('bumpingCost')}
                          {renderInputField('assemblyCost')}
                          {renderInputField('testCost')}
                          {renderInputField('yieldWafer','number',{step:0.1})}
                          {renderInputField('yieldAssembly','number',{step:0.1})}
                          {renderInputField('yieldFinal','number',{step:0.1})}
                          {renderInputField('outboundLogistics')}
                          {renderInputField('insurance')}
                          {renderInputField('otherVariable')}
                        </div>
                      </fieldset>
                      <fieldset>
                        <legend className="text-sm font-semibold text-slate-700 mb-4 border-b pb-2 w-full">財務、物流與供應鏈</legend>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          {renderInputField('fxTWDperUSD','number',{step:0.01})}
                          {renderInputField('paymentTermsDays')}
                          {renderInputField('incoterm','select',{choices:['FOB','CIF','DDP']})}
                          {renderInputField('hsCode','text')}
                          {renderInputField('frontEndCountry','country')}
                          {renderInputField('assemblyCountry','country')}
                          {renderInputField('testCountry','country')}
                          {renderInputField('shipToCountry','country')}
                          <div className="lg:col-span-2">{renderInputField('cooOverride','coo')}</div>
                        </div>
                        <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            {renderSliderField('targetGM',60,1)}
                            {renderSliderField('riskAddon',15,0.5)}
                        </div>
                      </fieldset>
                    </div>
                    <div className="mt-8 pt-6 border-t">
                      <h4 className="text-sm font-semibold text-slate-700 mb-4">即時成本總覽</h4>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Stat title="製造成本 (USD)" value={`$${fmt(baseCost)}`} icon="Factory" />
                        <Stat title="到岸成本 (TW-only, 估)" value={`$${fmt(results.find(r=>r.name.includes('TW-only'))?.landed || 0)}`} icon="Landmark" />
                        <Stat title="建議報價 (USD, TW-only)" value={`$${fmt(results.find(r=>r.name.includes('TW-only'))?.quoteUSD || 0)}`} icon="BadgeDollarSign" />
                      </div>
                    </div>
                  </CardContent>
                </Card>
              )}

              {activeTab==='tariffs' && (
                <Card>
                  <CardHeader><CardTitle>關稅設定</CardTitle></CardHeader>
                  <CardContent>
                    <p className="text-sm text-slate-600 mb-4">簡化示例：美國對中國原產半導體 (HS 8542.*) 課徵 50% 關稅。您可以根據最新情況新增或修改規則。</p>
                    <div className="overflow-x-auto rounded-lg border">
                      <table className="w-full text-sm text-left text-slate-500">
                        <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                          <tr>{["目的地","COO","HS Pattern (Regex)","方案","稅率%","生效日", ""].map(h => <th key={h} scope="col" className="px-4 py-3">{h}</th>)}</tr>
                        </thead>
                        <tbody>
                          {tariffs.map((t,rIdx)=> (
                            <tr key={rIdx} className="bg-white border-b hover:bg-slate-50 transition-colors">
                              <td className="p-2 w-48"><Select value={t[0]} onChange={e=>handleTariffChange(rIdx,0,e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></td>
                              <td className="p-2 w-48"><Select value={t[1]} onChange={e=>handleTariffChange(rIdx,1,e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></td>
                              <td className="p-2"><Input value={t[2]} onChange={e=>handleTariffChange(rIdx,2,e.target.value)} /></td>
                              <td className="p-2"><Input value={t[3]} onChange={e=>handleTariffChange(rIdx,3,e.target.value)} /></td>
                              <td className="p-2 w-24"><Input type="number" value={t[4]} onChange={e=>handleTariffChange(rIdx,4,Number(e.target.value))} /></td>
                              <td className="p-2 w-40"><Input type="date" value={t[5]} onChange={e=>handleTariffChange(rIdx,5,e.target.value)} /></td>
                              <td className="p-2 text-center">
                                <Button variant="ghost" size="sm" onClick={() => setTariffs(p => p.filter((_, i) => i !== rIdx))}><Icon name="Trash2" /></Button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <Button variant="outline" className="mt-4" onClick={() => setTariffs([...tariffs, ["United States","China","^8542\\.","Custom",25,"2025-01-01"]])}><Icon name="Plus" />新增一列</Button>
                  </CardContent>
                </Card>
              )}

              {activeTab==='scenarios' && (
                <Card>
                  <CardHeader className="flex justify-between items-center">
                    <CardTitle>路徑/場景</CardTitle>
                    <Button variant="outline" onClick={addScenario}><Icon name="Plus" />新增場景</Button>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <p className="text-sm text-slate-600">比較不同供應鏈路徑對成本和報價的影響。</p>
                    <div className="grid gap-4">
                      {scenarios.map((s,idx)=> (
                        <div key={idx} className="rounded-lg border p-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3 bg-slate-50 relative group">
                          <div className="md:col-span-3 lg:col-span-2"><Label>名稱</Label><Input value={s.name} onChange={e=>updateScenario(idx,'name',e.target.value)} /></div>
                          <div><Label>前段</Label><Select value={s.frontEndCountry} onChange={e=>updateScenario(idx,'frontEndCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>封裝</Label><Select value={s.assemblyCountry} onChange={e=>updateScenario(idx,'assemblyCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>測試</Label><Select value={s.testCountry} onChange={e=>updateScenario(idx,'testCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>目的地</Label><Select value={s.shipToCountry} onChange={e=>updateScenario(idx,'shipToCountry',e.target.value)}>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                          <div><Label>COO（產地判定）</Label><Select value={s.assumedCOO} onChange={e=>updateScenario(idx,'assumedCOO',e.target.value)}><option value="auto">自動</option>{COUNTRIES.map(c=> <option key={c} value={c}>{c}</option>)}</Select></div>
                           <button onClick={() => setScenarios(p => p.filter((_, i) => i !== idx))} className="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                            <Icon name="XCircle" className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              )}

              {activeTab==='results' && (
                <div className="space-y-6">
                  <Card>
                    <CardHeader><CardTitle>報價對比 (USD)</CardTitle></CardHeader>
                    <CardContent className="h-80">
                      <SimpleBarChart data={chartData} />
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader><CardTitle>明細表</CardTitle></CardHeader>
                    <CardContent>
                      <div className="overflow-x-auto rounded-lg border">
                        <table className="w-full text-sm text-left text-slate-500">
                          <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>{["場景","COO","製造成本","關稅率%","關稅","到岸成本","報價 (USD)","報價 (TWD)"].map(h => <th key={h} scope="col" className="px-4 py-3 whitespace-nowrap">{h}</th>)}</tr>
                          </thead>
                          <tbody>
                            {results.map((r,i)=> (
                              <tr key={i} className="bg-white border-b hover:bg-slate-50 transition-colors">
                                <td className="px-4 py-3 font-medium text-slate-900 whitespace-nowrap">{r.name}</td>
                                <td className="px-4 py-3">{r.coo}</td>
                                <td className="px-4 py-3 text-right">${fmt(r.manufacturingCost)}</td>
                                <td className="px-4 py-3 text-right">{fmt(r.tariffRate,1)}%</td>
                                <td className="px-4 py-3 text-right text-red-600">${fmt(r.tariff)}</td>
                                <td className="px-4 py-3 text-right">${fmt(r.landed)}</td>
                                <td className="px-4 py-3 text-right font-semibold text-blue-700">${fmt(r.quoteUSD)}</td>
                                <td className="px-4 py-3 text-right font-semibold text-blue-700">NT${fmt(r.quoteTWD,0)}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader><CardTitle><Icon name="Sparkles" /> AI 洞察分析</CardTitle></CardHeader>
                    <CardContent>
                      <div className="flex flex-col items-start gap-4">
                        <p className="text-sm text-slate-600">根據您目前的輸入參數與場景設定，產生一份市場風險與應變策略分析報告。</p>
                        <div className="flex gap-2">
                          <Button onClick={handleGenerateAnalysis} disabled={isAnalyzing}>
                            {isAnalyzing ? <><Icon name="Loader2" className="animate-spin" /> 分析中...</> : <><Icon name="Wand2" /> 產生分析報告</>}
                          </Button>
                        </div>
                        {isAnalyzing && <div className="w-full bg-slate-100 rounded-md p-4 mt-4"><div className="h-24 bg-slate-200 rounded animate-pulse"></div></div>}
                        {analysis && (
                          <div className="w-full mt-4 p-4 border rounded-md bg-slate-50 text-sm text-slate-800">
                            <pre className="whitespace-pre-wrap font-sans">{analysis}</pre>
                          </div>
                        )}
                      </div>
                    </CardContent>
                  </Card>
                </div>
              )}
            </main>

            <footer className="text-xs text-slate-500 pt-4 text-center space-y-2">
              {/* ** 更新後的署名 ** */}
              <p>Designed by Dr. Cliff Wang + AI in PSDM</p>
              <p>本工具為試算用途，關稅與產地(COO)需依個案由關務/法律確認；出口管制請參照 BIS 最新公告與客戶最終用途。AI 分析結果僅供參考。</p>
            </footer>
          </div>
        </div>
      );
    }

    window.addEventListener('load', () => {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<ICBackendQuotationDashboard />);
    });
  </script>
</body>
</html>
