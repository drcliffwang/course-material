<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2PSDM AI 診斷平台 - 王博士</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        :root {
            --michigan-blue: #00274C; --michigan-maize: #FFCB05;
            --michigan-blue-light: #4A90A4; --michigan-blue-dark: #001B2E;
            --michigan-maize-light: #FFF2A6; --michigan-blue-lightest: #E8F0F7;
        }
        .text-michigan-blue { color: var(--michigan-blue); }
        .bg-michigan-blue { background-color: var(--michigan-blue); }
        .border-michigan-maize { border-color: var(--michigan-maize); }
        .text-michigan-maize { color: var(--michigan-maize); }
        .bg-michigan-maize { background-color: var(--michigan-maize); }
        .bg-michigan-blue-lightest { background-color: var(--michigan-blue-lightest); }
        .bg-michigan-maize-lightest { background-color: var(--michigan-maize-lightest); }

        .header-gradient { background: linear-gradient(135deg, var(--michigan-blue) 0%, var(--michigan-blue-light) 100%); }
        .michigan-button {
            background: linear-gradient(135deg, var(--michigan-blue), var(--michigan-blue-light)); color: var(--michigan-maize);
            transition: all 0.3s ease; border: 2px solid transparent; font-weight: 600;
        }
        .michigan-button:hover {
            background: var(--michigan-blue-dark); border-color: var(--michigan-maize);
            transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 39, 76, 0.4);
        }
        .michigan-button-secondary {
            background: var(--michigan-maize); color: var(--michigan-blue); border: 2px solid var(--michigan-blue);
            transition: all 0.3s ease; font-weight: 600;
        }
        .michigan-button-secondary:hover {
            background: var(--michigan-maize-light); transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 203, 5, 0.4);
        }
        .focus-michigan:focus {
            outline: none; box-shadow: 0 0 0 3px rgba(255, 203, 5, 0.3); border-color: var(--michigan-maize);
        }
        .card-shadow { box-shadow: 0 4px 16px rgba(0, 39, 76, 0.1); }
        .progress-bar-container { background-color: #e0e0e0; border-radius: 9999px; overflow: hidden; }
        .progress-bar {
            background-color: var(--michigan-maize); height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .model-checkbox:checked + label {
            border-color: var(--michigan-blue); background-color: var(--michigan-blue-lightest);
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 39, 76, 0.1);
        }
        .feedback-button {
            background-color: #e2e8f0; border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .feedback-button:hover { background-color: #cbd5e1; transform: scale(1.1); }
        .feedback-button.selected { background-color: var(--michigan-maize); }
        /* --- [新增] 創新方法頁籤樣式 --- */
        .innovation-tab {
            cursor: pointer; padding: 10px 20px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500; color: #4a5568;
        }
        .innovation-tab:hover {
            color: var(--michigan-blue);
            background-color: var(--michigan-blue-lightest);
        }
        .innovation-tab.active {
            color: var(--michigan-blue);
            border-bottom-color: var(--michigan-maize);
            font-weight: 700;
        }
        .innovation-content {
            display: none;
        }
        .innovation-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <header class="header-gradient shadow-lg border-b-4 border-michigan-maize sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="Cliff Baby Pic by GPT.jpg" alt="王博士" class="h-16 w-16 rounded-full border-2 border-michigan-maize object-cover" onerror="this.onerror=null; this.src='https://placehold.co/64x64/FFCB05/00274C?text=Dr.Wang';">
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-michigan-maize">A2PSDM AI診斷平台</h1>
                        <p class="text-sm text-white">王博士 × 系統思維 × 創新激發</p>
                    </div>
                </div>
            </div>
             <!-- 進度條 -->
            <div class="mt-4">
                <div id="progress-container" class="progress-bar-container h-2.5 w-full">
                    <div id="progress-bar" class="progress-bar" style="width: 10%;"></div>
                </div>
                <div id="progress-label" class="text-center text-xs text-white mt-1">階段 1 / 5: 背景設定</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="space-y-8">
            <!-- API 設定 -->
            <div id="api-settings" class="bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200 mb-8">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">AI 引擎設定</h2>
                <p class="text-gray-600 mb-2">API Key: 使用(Gemini, GPT, Deepseek)模型，請於此處設定。</p>
                <!-- [修改] 新增 API Key 取得說明 -->
                <p class="text-sm text-gray-500 mb-6">
                    您的API Key 金鑰只會儲存在您目前的瀏覽器中, 可從 
                    <a href="https://aistudio.google.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">Google AI Studio</a> (推薦,免費中), 
                    <a href="https://platform.deepseek.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">Deepseek</a>, 或 
                    <a href="https://platform.openai.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">OpenAI</a> 取得。
                </p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="aiProvider" class="block text-sm font-semibold text-michigan-blue mb-2">AI 服務提供商</label>
                        <select id="aiProvider" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                            <option value="gemini">Gemini (預設)</option>
                            <option value="openai">OpenAI GPT</option>
                            <option value="deepseek">DeepSeek</option>
                        </select>
                    </div>
                    <div>
                        <label for="apiKey" class="block text-sm font-semibold text-michigan-blue mb-2">API Key (選填)</label>
                        <input type="password" id="apiKey" placeholder="使用 API Key 請填寫" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                    </div>
                </div>
                <div class="text-right mt-6">
                    <button onclick="saveSettings()" class="michigan-button px-6 py-3 rounded-lg">💾 儲存設定</button>
                </div>
            </div>

            <!-- 階段 1: 企業背景設定 -->
            <div id="stage-1" class="bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">階段 1: 企業背景設定</h2>
                <p class="text-gray-600 mb-6">提供準確的背景資訊，將讓AI的分析更貼近您的真實情況。</p>
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <input id="industry" type="text" placeholder="所屬產業 (例如: 半導體)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                    <select id="companySize" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan" aria-label="企業規模">
                        <option value="新創公司 (1-50人)">企業規模: 新創公司</option>
                        <option value="中小型企業 (51-500人)">企業規模: 中小型企業</option>
                        <option value="大型企業 (501-2000人)">企業規模: 大型企業</option>
                        <option value="上市/跨國公司 (2000人以上)">企業規模: 上市/跨國公司</option>
                    </select>
                    <input id="businessModel" type="text" placeholder="主要商業模式 (例如: B2B硬體銷售)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                </div>
                <!-- [修改] 加入帶入範例按鈕 -->
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-sm font-semibold text-michigan-blue">請簡要描述您的核心挑戰：</label>
                    <button onclick="loadExampleChallenge()" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg transition-colors">
                        帶入範例
                    </button>
                </div>
                <textarea id="problemDescription" rows="4" placeholder="例如：市場競爭激烈、技術轉型困難、營收成長緩慢..." class="w-full px-4 py-4 border-2 border-gray-300 rounded-lg focus-michigan resize-none"></textarea>
                <div class="text-center mt-6">
                    <button onclick="goToStage(2)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg">➡️ 選擇診斷模型</button>
                </div>
            </div>

            <!-- 階段 2: 選擇診斷模型 -->
            <div id="stage-2" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">階段 2: 選擇診斷模型工具箱</h2>
                <p class="text-gray-600 mb-6">請選擇您希望 AI 運用的管理分析模型。選擇越多，分析維度越全面，但所需時間也越長。</p>
                <div id="model-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Models will be inserted here by JS -->
                </div>
                <div class="text-center mt-6 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(1)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">⬅️ 返回背景設定</button>
                    <button id="stage2-action-btn" onclick="runAnalysis()" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">🔬 開始深度分析</button>
                </div>
            </div>

            <!-- 階段 3: 分析儀表板 -->
            <div id="stage-3" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">階段 3: AI 策略分析儀表板</h2>
                <div id="analysis-dashboard" class="space-y-6">
                    <!-- Analysis results will be appended here -->
                </div>
                 <div class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(2)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">⬅️ 返回模型選擇</button>
                    <button onclick="goToStage(4)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">💡 進入創新方案設計</button>
                </div>
            </div>

            <!-- 階段 4: 創新設計 (導入頁籤) -->
            <div id="stage-4" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                 <h2 class="text-2xl font-bold text-michigan-blue mb-2">階段 4: 創新方案設計工具箱</h2>
                 <p class="text-gray-600 mb-6">基於前述分析，AI 將運用多種創新方法，系統性地為您激發突破性的解決方案。</p>
                
                 <!-- 創新方法頁籤 -->
                <div class="border-b border-gray-200 mb-6">
                    <nav id="innovation-tabs" class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button onclick="showInnovationTab('scamper')" class="innovation-tab active" data-tab="scamper">SCAMPER</button>
                        <button onclick="showInnovationTab('blue_ocean')" class="innovation-tab" data-tab="blue_ocean">藍海策略</button>
                        <button onclick="showInnovationTab('design_thinking')" class="innovation-tab" data-tab="design_thinking">設計思維</button>
                        <button onclick="showInnovationTab('lean_startup')" class="innovation-tab" data-tab="lean_startup">精實創業</button>
                        <button onclick="showInnovationTab('ten_types')" class="innovation-tab" data-tab="ten_types">十大創新類型</button>
                    </nav>
                </div>

                <!-- 創新方法內容容器 -->
                <div id="innovation-content-container">
                    <div id="innovation-content-scamper" class="innovation-content active">
                        <div id="scamper-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-blue_ocean" class="innovation-content">
                        <div id="blue-ocean-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-design_thinking" class="innovation-content">
                         <div id="design-thinking-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-lean_startup" class="innovation-content">
                        <div id="lean-startup-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-ten_types" class="innovation-content">
                         <div id="ten-types-result" class="space-y-6"></div>
                    </div>
                </div>

                <div class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(3)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">⬅️ 返回分析儀表板</button>
                    <button onclick="goToStage(5)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">📄 產生最終報告</button>
                </div>
            </div>
            
            <!-- 階段 5: 最終報告與行動方案 -->
            <div id="stage-5" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">階段 5: 整合診斷報告與行動方案</h2>
                <div id="final-recommendations" class="mb-8">
                    <!-- Final recommendations will be here -->
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex flex-wrap justify-center items-center gap-4">
                        <button onclick="goToStage(4)" class="michigan-button-secondary px-8 py-4 rounded-lg text-lg shadow-lg">⬅️ 返回創新設計</button>
                        <button onclick="generateReport()" class="michigan-button px-8 py-4 rounded-lg text-lg shadow-lg">📥 下載專業診斷報告</button>
                        <button onclick="scheduleConsultation()" class="michigan-button-secondary px-8 py-4 rounded-lg text-lg shadow-lg">📅 預約王博士深度諮詢</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 載入指示器 -->
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 text-center shadow-2xl max-w-sm mx-auto">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-michigan-blue mx-auto mb-6"></div>
            <p class="text-xl font-semibold text-michigan-blue mb-2">王博士的AI顧問正在為您分析...</p>
            <p id="loadingMessage" class="text-sm text-gray-600">啟動系統性思維引擎</p>
        </div>
    </div>
    
    <footer class="bg-michigan-blue text-white py-8 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p class="font-semibold text-michigan-maize">A2PSDM | 王博士</p>
            <p class="text-gray-400 mt-1">© 2025 A2PSDM × 密西根大學學術傳承 × AI創新技術</p>
        </div>
    </footer>

    <script>
        // --- 全域變數與設定 ---
        let diagnosisData = { stage: 1 };
        
        // 設定保存：localStorage
        const SETTINGS_KEY = 'a2psdm_ai_settings_v1';
        function getSettings() {
            try {
                const raw = localStorage.getItem(SETTINGS_KEY);
                return raw ? JSON.parse(raw) : { provider: 'gemini', apiKey: '' };
            } catch(e) {
                return { provider: 'gemini', apiKey: '' };
            }
        }
        function setSettings(s) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
        }
        let runtimeSettings = getSettings();

        const DR_WANG_PERSONA = `您是一位在密西根大學受過嚴格學術訓練、擁有30年產業顧問經驗的博士級專家王啟岳。您的分析結合了系統性、結構化的邏輯思維與創新的解決方案設計。請以專業、精準、具洞察力的語氣，提供戰略層級的建議，並只以繁體中文回應。`;
        
        const availableModels = [
            { id: 'swot', name: 'SWOT 分析', description: '評估內部優劣勢與外部機會威脅，提供戰略全局觀。' },
            { id: 'porters', name: '波特五力分析', description: '分析產業競爭結構，判斷產業吸引力與獲利潛力。' },
            { id: 'pestel', name: 'PESTEL 分析', description: '掃描總體環境中的政治、經濟、社會、技術、環境、法律等關鍵因素。' },
            { id: 'bmc', name: '商業模式 (BMC)', description: '解構並可視化商業模式的九個核心要素，尋找創新點。' },
            { id: 'vpc', name: '價值主張分析 (VPC)', description: '設計顧客真正需要的產品與服務，創造價值契合。' }
        ];

        // --- [新增] 帶入範例挑戰的函數 ---
        function loadExampleChallenge() {
            document.getElementById('industry').value = "代工傳產OEM/ODM";
            document.getElementById('companySize').value = "中小型企業 (51-500人)";
            document.getElementById('businessModel').value = "傳統車件與金屬加工";
            const exampleText = "過去二十年，我們從做傳統車件與金屬加工的代工傳產，擴展到模組化組裝與ODM，開始累積技術與設計能量。10年前開始品牌之路。我們與世界級手工具品牌聯名合作，逐漸打響名號；目前品牌營收占總營收的三分之一，也將公司毛利提高兩成。然而，做品牌需要的人才與代工的人才，是兩種截然不同的「物種」 。我們從外部找人來做品牌，困難重重：首先，開不起市場行情價；其次，人才進來難以溝通、水土不服；第三，磨合不順後離職，又得從頭來過。另方面，我們也同步內部培養。工廠裡的老員工要從過去的「交貨邏輯」切換到「價值創造邏輯」，需要時間磨。但客戶、市場、競爭者步步緊逼，究竟要投入資源培養原有團隊，以求穩定文化、慢慢轉型？還是從外部招募品牌高手，冒著文化衝突的風險，來換取轉型速度？做品牌，產品只是入場券，真正的戰場在於「組織能不能跟上品牌腳步」。";
            document.getElementById('problemDescription').value = exampleText;
        }

        // --- UI 控制 ---
        function updateProgress(stage) {
            diagnosisData.stage = stage;
            const totalStages = 5;
            const percentage = (stage / totalStages) * 100;
            const labels = ["背景設定", "選擇模型", "分析儀表板", "創新設計", "最終報告"];
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-label').textContent = `階段 ${stage} / ${totalStages}: ${labels[stage-1]}`;
        }
        
        async function goToStage(stageNumber) {
            if (stageNumber === 2) {
                const newContext = {
                    industry: document.getElementById('industry').value.trim(),
                    companySize: document.getElementById('companySize').value,
                    businessModel: document.getElementById('businessModel').value.trim(),
                    problem: document.getElementById('problemDescription').value.trim()
                };

                if (!newContext.industry || !newContext.problem) {
                    alert('請填寫「所屬產業」與「核心挑戰」以利分析。'); 
                    return;
                }
                
                if(JSON.stringify(diagnosisData.context) !== JSON.stringify(newContext)) {
                    diagnosisData.analysisResults = {};
                    diagnosisData.scamper = null;
                    diagnosisData.blue_ocean = null;
                    diagnosisData.design_thinking = null;
                    diagnosisData.lean_startup = null;
                    diagnosisData.ten_types = null;
                    diagnosisData.finalRecommendations = null;
                }
                diagnosisData.context = newContext;
            }
            
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`stage-${i}`).classList.add('hidden');
            }
            document.getElementById('api-settings').classList.add('hidden');

            const targetStage = document.getElementById(`stage-${stageNumber}`);
            if (targetStage) {
                targetStage.classList.remove('hidden');
                updateProgress(stageNumber);
                window.scrollTo({ top: targetStage.offsetTop - 120, behavior: 'smooth' });
                
                if (stageNumber === 2) {
                    const actionButton = document.getElementById('stage2-action-btn');
                    const analysisDone = diagnosisData.analysisResults && Object.keys(diagnosisData.analysisResults).length > 0;
                    if (analysisDone) {
                        actionButton.textContent = '➡️ 查看分析結果';
                        actionButton.onclick = () => goToStage(3);
                    } else {
                        actionButton.textContent = '🔬 開始深度分析';
                        actionButton.onclick = runAnalysis;
                    }
                }

                if (stageNumber === 4 && !diagnosisData.scamper) {
                    showInnovationTab('scamper');
                } else if (stageNumber === 5 && !diagnosisData.finalRecommendations) {
                    await generateFinalRecommendationsAnalysis();
                }
            }
        }
        
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        function saveSettings() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            runtimeSettings = { provider, apiKey };
            setSettings(runtimeSettings);
            
            let message = '✅ 設定已儲存！\n\n';
            
            if (provider === 'gemini') {
                message += '🎯 Gemini 已優化為最佳前端體驗，將提供穩定的分析服務。';
            } else {
                message += `⚠️ ${provider.toUpperCase()} 設定完成。\n\n`;
                message += '📋 相容性說明：\n';
                message += '• 系統已採用經過驗證的 API 調用架構\n';
                message += '• 如遇連線問題，將提供詳細診斷資訊\n';
                message += '• 建議同時設定 Gemini 作為備用方案';
            }
            
            alert(message);
            
            testConnectivity(provider, apiKey).catch(e => 
                console.warn('連線測試結果:', e.message)
            );
        }

        async function callAI(prompt, retries = 3, delay = 1000) {
            const provider = (runtimeSettings?.provider || 'gemini').toLowerCase();
            const key = runtimeSettings?.apiKey || '';

            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    let response;
                    if (provider === 'gemini') {
                        response = await callGeminiAPI(prompt, key);
                    } else if (provider === 'openai') {
                        if (!key) throw new Error('OpenAI 需要 API Key，請先設定。');
                        response = await callOpenAIAPI(prompt, key);
                    } else if (provider === 'deepseek') {
                        if (!key) throw new Error('DeepSeek 需要 API Key，請先設定。');
                        response = await callDeepSeekAPI(prompt, key);
                    } else {
                        throw new Error('不支援的 AI 提供商');
                    }
                    return response;
                } catch (error) {
                    console.error(`AI 調用失敗 (嘗試 ${attempt + 1}/${retries + 1}):`, error);
                    if (error.message.includes('API key not valid') || error.message.includes('權限') || error.message.includes('API Key')) {
                        throw new Error(`API Key 驗證失敗或權限不足。請檢查您的 ${provider.toUpperCase()} API Key 設定。`);
                    }
                    if (attempt < retries) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, attempt)));
                        continue;
                    }
                    throw new Error(`嘗試 ${retries + 1} 次後，AI 分析仍然失敗: ${error.message}`);
                }
            }
        }

        async function callGeminiAPI(prompt, apiKey) {
            const model = 'gemini-2.5-flash';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const combinedPrompt = `${DR_WANG_PERSONA}\n\n[診斷分析請求]\n${prompt}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: combinedPrompt }] }],
                generationConfig: { 
                    temperature: 0.5, topK: 40, topP: 0.95,
                    response_mime_type: "application/json",
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `Gemini API 錯誤 ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\n詳細錯誤：${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\n回應內容：${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (!candidate?.content?.parts?.[0]?.text) {
                 if (result.promptFeedback?.blockReason) {
                    throw new Error(`Gemini 請求被阻擋，原因：${result.promptFeedback.blockReason}`);
                }
                throw new Error(`Gemini 回應格式異常：${JSON.stringify(result, null, 2)}`);
            }
            return candidate.content.parts[0].text;
        }

        async function callOpenAIAPI(prompt, apiKey) {
            const apiUrl = 'https://api.openai.com/v1/chat/completions';
            const payload = {
                model: 'gpt-4o-mini',
                messages: [ { role: 'system', content: DR_WANG_PERSONA }, { role: 'user', content: prompt } ],
                response_format: { type: "json_object" },
                temperature: 0.5
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `OpenAI API 錯誤 ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\n詳細錯誤：${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\n回應內容：${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            if (!result.choices?.[0]?.message?.content) { throw new Error(`OpenAI 回應格式異常：${JSON.stringify(result, null, 2)}`); }
            return result.choices[0].message.content;
        }

        async function callDeepSeekAPI(prompt, apiKey) {
            const apiUrl = 'https://api.deepseek.com/v1/chat/completions';
            const payload = {
                model: 'deepseek-chat',
                messages: [ { role: 'system', content: DR_WANG_PERSONA }, { role: 'user', content: prompt } ],
                response_format: { type: "json_object" },
                temperature: 0.5
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `DeepSeek API 錯誤 ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\n詳細錯誤：${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\n回應內容：${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            if (!result.choices?.[0]?.message?.content) { throw new Error(`DeepSeek 回應格式異常：${JSON.stringify(result, null, 2)}`); }
            return result.choices[0].message.content;
        }

        async function testConnectivity(provider, apiKey) {
            try {
                if (!apiKey && provider !== 'gemini') { return false; }
                const testPrompt = 'Hello, this is a connection test, please reply with only {"status": "ok"}';
                const response = await callAI(testPrompt);
                console.log('連線測試成功', response);
                return true;
            } catch (error) {
                console.error('連線測試失敗:', error.message);
                return false;
            }
        }

        async function runAnalysis() {
            const selectedModels = Array.from(document.querySelectorAll('.model-checkbox:checked')).map(cb => cb.value);
            if (selectedModels.length === 0) {
                alert('請至少選擇一個分析模型。'); 
                return;
            }
  
            let orderedModels = selectedModels.slice();
            const vpcIndex = orderedModels.indexOf('vpc');
            const bmcIndex = orderedModels.indexOf('bmc');
            if (vpcIndex > -1 && bmcIndex > -1 && vpcIndex > bmcIndex) {
                 orderedModels = orderedModels.filter(m => m !== 'vpc');
                 orderedModels.splice(bmcIndex, 0, 'vpc');
            }
           
            diagnosisData.selectedModels = orderedModels;
            diagnosisData.analysisResults = {};

            goToStage(3);
            const dashboard = document.getElementById('analysis-dashboard');
            dashboard.innerHTML = '';

            for (const modelId of orderedModels) {
                showLoading(`正在執行 ${availableModels.find(m=>m.id === modelId).name}...`);
                try {
                    const prompt = window[`get${modelId.charAt(0).toUpperCase() + modelId.slice(1)}Prompt`]();
                    const response = await callAI(prompt);
                    const result = safeJSONParse(response);
                    if (result.error) throw new Error(result.message);
                    diagnosisData.analysisResults[modelId] = result;
                    renderAnalysisCard(modelId, result);
                } catch (error) {
                    console.error(`${modelId} 分析失敗:`, error);
                    renderErrorCard(modelId, error.message);
                }
            }
            hideLoading();
            
            const actionButton = document.getElementById('stage2-action-btn');
            actionButton.textContent = '➡️ 查看分析結果';
            actionButton.onclick = () => goToStage(3);
        }

        async function showInnovationTab(method) {
            document.querySelectorAll('.innovation-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === method));
            document.querySelectorAll('.innovation-content').forEach(content => content.classList.toggle('active', content.id === `innovation-content-${method}`));
            if (!diagnosisData[method]) {
                const generator = window[`generate${method.charAt(0).toUpperCase() + method.slice(1)}Analysis`];
                if (generator) await generator();
            }
        }

        async function generateAnalysisForMethod(method, promptFunction, renderFunction) {
            const methodKey = method.toLowerCase().replace(/ /g, '_');
            showLoading(`AI 正在運用 ${method.toUpperCase()} 進行創新設計...`);
            try {
                const prompt = promptFunction();
                const response = await callAI(prompt);
                const result = safeJSONParse(response);
                if (result.error) throw new Error(result.message);
                diagnosisData[methodKey] = result; 
                renderFunction(result);
            } catch (error) {
                console.error(`${method} 分析失敗:`, error);
                const container = document.getElementById(`${methodKey}-result`);
                if(container) {
                    container.innerHTML = `<div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-500"><h4 class="font-bold text-red-800">${method} 創新方案生成失敗</h4><p class="text-sm text-red-700 mt-1">原因：${error.message}</p></div>`;
                }
            } finally {
                hideLoading();
            }
        }
        
        async function generateScamperAnalysis() { await generateAnalysisForMethod('SCAMPER', getScamperPrompt, renderScamper); }
        async function generateBlue_oceanAnalysis() { await generateAnalysisForMethod('Blue Ocean', getBlueOceanPrompt, renderBlueOcean); }
        async function generateDesign_thinkingAnalysis() { await generateAnalysisForMethod('Design Thinking', getDesignThinkingPrompt, renderDesignThinking); }
        async function generateLean_startupAnalysis() { await generateAnalysisForMethod('Lean Startup', getLeanStartupPrompt, renderLeanStartup); }
        async function generateTen_typesAnalysis() { await generateAnalysisForMethod('Ten Types', getTenTypesPrompt, renderTenTypes); }
        
        async function generateFinalRecommendationsAnalysis() {
            showLoading('AI 正在整合最終戰略建議...');
            try {
                const finalPrompt = getFinalRecommendationsPrompt();
                const finalResponse = await callAI(finalPrompt);
                const finalResult = safeJSONParse(finalResponse);
                if (finalResult.error) throw new Error(finalResult.message);
                diagnosisData.finalRecommendations = finalResult;
                renderFinalRecommendations(finalResult);
            } catch (error) {
                console.error('最終建議生成失敗:', error);
                renderFinalRecommendationsError(error.message);
            } finally {
                hideLoading();
            }
        }
        
        function getBasePromptContext() {
            return `
                **企業背景:**
                - 產業: ${diagnosisData.context.industry}
                - 規模: ${diagnosisData.context.companySize}
                - 商業模式: ${diagnosisData.context.businessModel}
                - 核心挑戰: ${diagnosisData.context.problem}
                **已完成的策略分析摘要 (JSON格式):**
                ${JSON.stringify(diagnosisData.analysisResults || {}, null, 2)}
                請以繁體中文回應，並嚴格遵守指定的JSON輸出格式。
            `;
        }

        function getSwotPrompt() {
            return `${getBasePromptContext()}
            請對此企業进行SWOT分析。為每個象限提供 3 到 4 個最關鍵的洞察。
            **輸出格式 (嚴格遵守此JSON結構):**
            { "strengths": [], "weaknesses": [], "opportunities": [], "threats": [] }`;
        }

        function getPortersPrompt() {
            return `${getBasePromptContext()}
            請運用波特五力模型分析。為每一種力量進行評分（高、中、低）並提供理由，最後給出總結。
            **輸出格式 (嚴格遵守此JSON結構):**
            { "forces": [ {"name": "新進入者的威脅", "level": "高/中/低", "reason": ""} ], "summary": "" }`;
        }
        
        function getPestelPrompt() {
             return `${getBasePromptContext()}
            請運用PESTEL模型分析。為每個因素找出 2-3 個最相關的趨勢或影響。
            **輸出格式 (嚴格遵守此JSON結構):**
            { "political": [], "economic": [], "social": [], "technological": [], "environmental": [], "legal": [] }`;
        }

        function getVpcPrompt() {
            return `${getBasePromptContext()}
            請進行價值主張分析(VPC)。為「顧客輪廓」與「價值地圖」各區塊提供 2-3 個洞察。
            **輸出格式 (嚴格遵守此JSON結構):**
            { "customer_profile": { "jobs": [], "pains": [], "gains": [] }, "value_map": { "products_services": [], "pain_relievers": [], "gain_creators": [] } }`;
        }

        function getBmcPrompt() {
            return `${getBasePromptContext()}
            請建構商業模式 BMC。為九個模塊各提供2-3個核心要點。
            **輸出格式 (嚴格遵守此JSON結構):**
            { "customer_segments": [], "value_propositions": [], "channels": [], "customer_relationships": [], "revenue_streams": [], "key_activities": [], "key_resources": [], "key_partnerships": [], "cost_structure": [] }`;
        }

        function getScamperPrompt() {
            return `${getBasePromptContext()}
            [任務] 運用SCAMPER發想創新方案。先提煉3-4個「戰略議題」，再針對議題用七技法構思方案，最後選出前5優先方案。
            [輸出格式(JSON，嚴格遵守)]
            { "strategic_insights": [ { "issue": "", "description": "", "data_sources": [] } ], "scamper_solutions": [ { "technique": "S/C/A/M/P/E/R", "strategic_issue": "", "solution": { "title": "", "description": "", "expected_benefits": [] } } ], "priority_ranking": [] }`;
        }

        function getBlueOceanPrompt() {
            return `${getBasePromptContext()}
            [任務] 運用「藍海策略」的「四項行動架構」(ERRC)重構產業元素。為「消除」、「減少」、「提升」、「創造」各提出 2-3 個策略建議。
            [輸出格式(JSON，嚴格遵守)]
            { "eliminate": [ {"action": "", "rationale": ""} ], "reduce": [ {"action": "", "rationale": ""} ], "raise": [ {"action": "", "rationale": ""} ], "create": [ {"action": "", "rationale": ""} ] }`;
        }

        function getDesignThinkingPrompt() {
            return `${getBasePromptContext()}
            [任務] 運用「設計思維」五階段，規劃以使用者為中心的解決方案流程。為每階段提供 2-3 個關鍵行動或問題。
            [輸出格式(JSON，嚴格遵守)]
            { "stages": [ { "stage": "1. 同理心", "description": "", "actions": [] } ] }`;
        }
        
        function getLeanStartupPrompt() {
            return `${getBasePromptContext()}
            [任務] 運用「精實創業」循環，提出快速驗證商業構想的行動計畫。定義假設、MVP與衡量指標。
            [輸出格式(JSON，嚴格遵守)]
            { "title": "", "build": { "phase_name": "建立", "key_hypothesis": "", "mvp_suggestion": { "name": "", "description": "", "features": [] } }, "measure": { "phase_name": "衡量", "key_metrics": [ {"metric": "", "definition": ""} ], "measurement_method": "" }, "learn": { "phase_name": "學習", "pivot_or_persevere": "", "learning_questions": [] } }`;
        }

        function getTenTypesPrompt() {
            return `${getBasePromptContext()}
            [任務] 運用「十大創新類型」框架，從「結構」、「產品」和「體驗」三維度，為各類型提供 1-2 個創新構想。
            [輸出格式(JSON，嚴格遵守)]
            { "categories": [ { "name": "結構", "description": "", "types": [ {"type_name": "", "ideas": []} ] } ] }`;
        }

        function getFinalRecommendationsPrompt() {
             const innovationSummary = {};
             if (diagnosisData.scamper) innovationSummary.scamper = diagnosisData.scamper.priority_ranking;
             if (diagnosisData.blue_ocean) innovationSummary.blue_ocean = diagnosisData.blue_ocean;
             if (diagnosisData.design_thinking) innovationSummary.design_thinking = { stage1: diagnosisData.design_thinking.stages[0].actions, stage2: diagnosisData.design_thinking.stages[1].actions};
             if (diagnosisData.lean_startup) innovationSummary.lean_startup = { hypothesis: diagnosisData.lean_startup.build.key_hypothesis, mvp: diagnosisData.lean_startup.build.mvp_suggestion.name };
             if (diagnosisData.ten_types) innovationSummary.ten_types = { top_idea: diagnosisData.ten_types.categories[0].types[0].ideas[0] };
             const allDataSummary = JSON.stringify({ context: diagnosisData.context, analysisResults: diagnosisData.analysisResults, innovationSummary: innovationSummary }, null, 2);
             return `${DR_WANG_PERSONA}
            診斷數據摘要: ${allDataSummary}
            請綜合所有信息，提供整合戰略建議。包含：1. 核心洞察, 2. 立即行動(30天), 3. 季度路線圖, 4. 長期願景。
            **輸出格式 (嚴格遵守此JSON結構):**
            { "strategic_insight": "", "immediate_actions": [], "quarterly_roadmap": [ {"quarter": "Q1", "focus": ""} ], "long_term_vision": "" }`;
        }

        // --- 渲染函數 ---
        function renderAnalysisCard(modelId, data) {
            const model = availableModels.find(m => m.id === modelId);
            const container = document.createElement('div');
            container.className = 'bg-michigan-blue-lightest p-6 rounded-xl border-l-4 border-michigan-blue card-shadow';
            container.innerHTML = `
                <details open>
                    <summary class="font-bold text-michigan-blue text-xl cursor-pointer list-none flex justify-between items-center">
                        <span>${model.name}</span>
                        <span class="text-sm font-normal text-gray-500 hover:underline">點擊展開/收合</span>
                    </summary>
                    <div class="mt-4" id="content-${modelId}"></div>
                </details>
                <div class="flex justify-end items-center mt-4 gap-2">
                    <span class="text-xs text-gray-500">這個分析有幫助嗎？</span>
                    <button class="feedback-button" onclick="giveFeedback(this, '${modelId}', 'good')">👍</button>
                    <button class="feedback-button" onclick="giveFeedback(this, '${modelId}', 'bad')">👎</button>
                </div>`;
            document.getElementById('analysis-dashboard').appendChild(container);
            const contentDiv = document.getElementById(`content-${modelId}`);
            window[`render${modelId.charAt(0).toUpperCase() + modelId.slice(1)}`](contentDiv, data);
        }
        
        function renderSwot(container, data) {
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded-lg"><h4 class="font-bold text-green-800 mb-2">優勢(S)</h4><ul class="list-disc list-inside text-sm text-green-700 space-y-1">${(data.strengths || []).map(s => `<li>${s}</li>`).join('')}</ul></div>
                    <div class="bg-red-100 p-4 rounded-lg"><h4 class="font-bold text-red-800 mb-2">劣勢(W)</h4><ul class="list-disc list-inside text-sm text-red-700 space-y-1">${(data.weaknesses || []).map(w => `<li>${w}</li>`).join('')}</ul></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><h4 class="font-bold text-blue-800 mb-2">機會(O)</h4><ul class="list-disc list-inside text-sm text-blue-700 space-y-1">${(data.opportunities || []).map(o => `<li>${o}</li>`).join('')}</ul></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><h4 class="font-bold text-yellow-800 mb-2">威脅(T)</h4><ul class="list-disc list-inside text-sm text-yellow-700 space-y-1">${(data.threats || []).map(t => `<li>${t}</li>`).join('')}</ul></div>
                </div>`;
        }
        
        function renderPorters(container, data) {
            const levelColor = { '高': 'bg-red-500', '中': 'bg-yellow-500', '低': 'bg-green-500' };
            container.innerHTML = `<div class="space-y-3 mb-4">
                ${(data.forces || []).map(f => `<div class="p-3 bg-white rounded-lg border"><div class="flex items-center justify-between"><h5 class="font-semibold text-michigan-blue">${f.name}</h5><span class="px-3 py-1 text-white text-xs rounded-full ${levelColor[f.level] || 'bg-gray-400'}">${f.level}</span></div><p class="text-sm text-gray-600 mt-1">${f.reason}</p></div>`).join('')}
                </div>
                <div class="p-4 bg-michigan-maize-lightest rounded-lg"><h5 class="font-bold text-michigan-blue">總結</h5><p class="text-sm text-gray-700">${data.summary || ''}</p></div>`;
        }

        function renderPestel(container, data) {
            const labels = { political: '政治', economic: '經濟', social: '社會', technological: '技術', environmental: '環境', legal: '法律' };
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${Object.entries(data || {}).map(([key, value]) => `<div class="bg-white p-4 rounded-lg border"><h4 class="font-bold text-michigan-blue mb-2">${labels[key] || key}</h4><ul class="list-disc list-inside text-sm text-gray-700 space-y-1">${(value || []).map(v => `<li>${v}</li>`).join('')}</ul></div>`).join('')}
            </div>`;
        }

        function renderBmc(container, data) {
            const renderList = (items) => (items || []).map(item => `<li>${item}</li>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-5 gap-4 text-xs md:text-sm">
                    <div class="md:col-span-1 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">關鍵合作夥伴</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_partnerships)}</ul> </div>
                    <div class="md:col-span-1 space-y-4"> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">關鍵活動</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_activities)}</ul> </div> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">關鍵資源</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_resources)}</ul> </div> </div>
                    <div class="md:col-span-1 bg-michigan-maize-lightest p-2 md:p-4 rounded-lg border-2 border-michigan-maize"> <h4 class="font-bold text-michigan-blue mb-2">價值主張</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.value_propositions)}</ul> </div>
                    <div class="md:col-span-1 space-y-4"> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">顧客關係</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.customer_relationships)}</ul> </div> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">通路</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.channels)}</ul> </div> </div>
                    <div class="md:col-span-1 bg-michigan-maize-lightest p-2 md:p-4 rounded-lg border-2 border-michigan-maize"> <h4 class="font-bold text-michigan-blue mb-2">顧客族群</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.customer_segments)}</ul> </div>
                    <div class="md:col-span-3 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">成本結構</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.cost_structure)}</ul> </div>
                    <div class="md:col-span-2 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">收益流</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.revenue_streams)}</ul> </div>
                </div>`;
        }

        function renderVpc(container, data) {
            const renderList = (items) => (items || []).map(item => `<li class="text-sm">${item}</li>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div class="bg-white p-4 rounded-xl border-2 border-michigan-blue h-full flex flex-col"> <h4 class="font-bold text-michigan-blue text-lg mb-3 text-center">價值地圖</h4> <div class="space-y-4 flex-grow"> <div> <h5 class="font-semibold text-gray-700 mb-2">🎁 產品與服務</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.products_services)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">💊 痛點解方</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.pain_relievers)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">✨ 獲益創造者</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.gain_creators)}</ul> </div> </div> </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-michigan-maize h-full flex flex-col"> <h4 class="font-bold text-michigan-blue text-lg mb-3 text-center">顧客輪廓</h4> <div class="space-y-4 flex-grow"> <div> <h5 class="font-semibold text-gray-700 mb-2">👍 期望獲益</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.gains)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">👎 痛點</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.pains)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">📝 顧客任務</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.jobs)}</ul> </div> </div> </div>
                </div>`;
        }

        function renderScamper(data) {
            const container = document.getElementById('scamper-result');
            if (!data || (!data.strategic_insights?.length && !data.scamper_solutions?.length)) {
                container.innerHTML = `<div class="text-center text-gray-500">AI 未能生成 SCAMPER 創新方案。</div>`; return;
            }
            container.innerHTML = `
                ${data.strategic_insights?.length ? `<div class="bg-michigan-maize-lightest p-6 rounded-xl border-l-4 border-michigan-maize mb-8 card-shadow"> <h3 class="font-bold text-michigan-blue text-xl mb-4">🎯 核心戰略洞察</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> ${data.strategic_insights.map(i => `<div class="bg-white p-4 rounded-lg border"><h4 class="font-semibold text-michigan-blue mb-2">${i.issue}</h4><p class="text-sm text-gray-700 mb-2">${i.description}</p><div class="text-xs text-gray-500"><strong>數據依據：</strong> ${(i.data_sources || []).join(', ')}</div></div>`).join('')} </div> </div>` : ''}
                ${data.scamper_solutions?.length ? `<div class="mb-8"> <h3 class="font-bold text-michigan-blue text-xl mb-4">🧩 SCAMPER創新方案</h3> <div class="space-y-4"> ${data.scamper_solutions.map(s => `<details class="bg-white p-4 rounded-xl border card-shadow"><summary class="font-semibold text-michigan-blue cursor-pointer">${s.technique}: ${s.solution.title}</summary><div class="mt-3 pt-3 border-t"><p class="text-sm text-gray-700 mb-2">${s.solution.description}</p><p class="text-xs text-gray-600"><strong>預期效益:</strong> ${(s.solution.expected_benefits || []).join(', ')}</p><p class="text-xs text-gray-500 mt-1"><strong>對應議題:</strong> ${s.strategic_issue}</p></div></details>`).join('')} </div> </div>` : ''}
                ${data.priority_ranking?.length ? `<div class="bg-michigan-blue-lightest p-6 rounded-xl border-l-4 border-michigan-blue card-shadow"> <h3 class="font-bold text-michigan-blue text-xl mb-4">🚀 優先實施建議</h3> <ol class="list-decimal list-inside space-y-2 text-gray-800"> ${data.priority_ranking.map(p => `<li>${(typeof p === 'object' && p !== null) ? (p.title || '無標題建議') : p}</li>`).join('')} </ol> </div>` : ''}
            `;
        }
        
        function renderBlueOcean(data) {
            const container = document.getElementById('blue-ocean-result');
            const renderActions = (actions) => (actions || []).map(item => `<div class="bg-white p-3 rounded-md border"><h5 class="font-semibold text-gray-800">${item.action}</h5><p class="text-xs text-gray-600 mt-1">${item.rationale}</p></div>`).join('');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">四項行動架構 (ERRC Grid)</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> <div class="bg-red-50 p-4 rounded-lg"><h4 class="font-bold text-red-700 mb-3">🚫 消除</h4><div class="space-y-3">${renderActions(data.eliminate)}</div></div> <div class="bg-yellow-50 p-4 rounded-lg"><h4 class="font-bold text-yellow-700 mb-3">📉 減少</h4><div class="space-y-3">${renderActions(data.reduce)}</div></div> <div class="bg-blue-50 p-4 rounded-lg"><h4 class="font-bold text-blue-700 mb-3">📈 提升</h4><div class="space-y-3">${renderActions(data.raise)}</div></div> <div class="bg-green-50 p-4 rounded-lg"><h4 class="font-bold text-green-700 mb-3">✨ 創造</h4><div class="space-y-3">${renderActions(data.create)}</div></div> </div>`;
        }

        function renderDesignThinking(data) {
            const container = document.getElementById('design-thinking-result');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">設計思維五階段流程</h3> <div class="space-y-4"> ${(data.stages || []).map(s => `<div class="bg-michigan-blue-lightest p-5 rounded-xl border-l-4 border-michigan-blue"> <h4 class="font-bold text-michigan-blue text-lg">${s.stage}</h4> <p class="text-sm text-gray-700 my-2">${s.description}</p> <h5 class="font-semibold text-gray-800 text-sm mb-2">關鍵行動 / 問題:</h5> <ul class="list-disc list-inside text-sm text-gray-600 space-y-1"> ${(s.actions || []).map(a => `<li>${a}</li>`).join('')} </ul> </div>`).join('')} </div>`;
        }

        function renderLeanStartup(data) {
            const container = document.getElementById('lean-startup-result');
            if(!data) return;
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">${data.title || '精實創業行動計畫'}</h3> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div class="bg-blue-50 p-5 rounded-lg border border-blue-200"> <h4 class="font-bold text-blue-800 text-2xl mb-3">1. 建立</h4> <h5 class="font-semibold text-blue-700">關鍵假設</h5><p class="text-sm text-gray-700 mb-4">${data.build?.key_hypothesis || ''}</p> <h5 class="font-semibold text-blue-700">MVP 建議: ${data.build?.mvp_suggestion?.name || ''}</h5> <p class="text-sm text-gray-700 mb-2">${data.build?.mvp_suggestion?.description || ''}</p> <ul class="list-disc list-inside text-xs text-gray-600">${(data.build?.mvp_suggestion?.features || []).map(f => `<li>${f}</li>`).join('')}</ul> </div> <div class="bg-green-50 p-5 rounded-lg border border-green-200"> <h4 class="font-bold text-green-800 text-2xl mb-3">2. 衡量</h4> <h5 class="font-semibold text-green-700">關鍵指標</h5><ul class="text-sm text-gray-700 mb-4 space-y-2">${(data.measure?.key_metrics || []).map(m => `<li><strong>${m.metric}:</strong> ${m.definition}</li>`).join('')}</ul> <h5 class="font-semibold text-green-700">衡量方法</h5> <p class="text-sm text-gray-700">${data.measure?.measurement_method || ''}</p> </div> <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-200"> <h4 class="font-bold text-yellow-800 text-2xl mb-3">3. 學習</h4> <h5 class="font-semibold text-yellow-700">決策點: 堅持或轉向?</h5> <p class="text-sm text-gray-700 mb-4">${data.learn?.pivot_or_persevere || ''}</p> <h5 class="font-semibold text-yellow-700">學習問題</h5> <ul class="list-disc list-inside text-sm text-gray-700">${(data.learn?.learning_questions || []).map(q => `<li>${q}</li>`).join('')}</ul> </div> </div>`;
        }

        function renderTenTypes(data) {
            const container = document.getElementById('ten-types-result');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">十大創新類型機會點</h3> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> ${(data.categories || []).map(c => `<div class="bg-michigan-blue-lightest p-5 rounded-lg"> <h4 class="font-bold text-michigan-blue text-lg mb-2">${c.name}</h4> <p class="text-xs text-gray-600 mb-4">${c.description}</p> <div class="space-y-4"> ${(c.types || []).map(t => `<div class="bg-white p-3 rounded-md"> <h5 class="font-semibold text-gray-800 text-sm">${t.type_name}</h5> <ul class="list-disc list-inside text-xs text-gray-600 mt-2"> ${(t.ideas || []).map(i => `<li>${i}</li>`).join('')} </ul> </div>`).join('')} </div> </div>`).join('')} </div>`;
        }

        function renderFinalRecommendations(data) {
            const container = document.getElementById('final-recommendations');
            container.innerHTML = `<div class="space-y-6"> <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize"><h4 class="font-bold text-michigan-blue text-lg mb-2">核心戰略洞察</h4><p class="text-gray-800">${data?.strategic_insight || ''}</p></div> <div class="bg-michigan-blue-lightest p-5 rounded-lg border-l-4 border-michigan-blue"><h4 class="font-bold text-michigan-blue text-lg mb-2">🚀 立即行動 (30天內)</h4><ul class="list-disc list-inside text-gray-800 space-y-1">${(data?.immediate_actions || []).map(a => `<li>${a}</li>`).join('')}</ul></div> <div class="bg-white p-5 rounded-lg border"><h4 class="font-bold text-michigan-blue text-lg mb-2">🗺️ 季度執行路線圖</h4><div class="space-y-2">${(data?.quarterly_roadmap || []).map(q => `<div><strong class="text-michigan-blue">${q.quarter}:</strong> ${q.focus}</div>`).join('')}</div></div> <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize"><h4 class="font-bold text-michigan-blue text-lg mb-2">🔮 長期願景</h4><p class="text-gray-800">${data?.long_term_vision || ''}</p></div> </div>`;
        }
        
        function renderErrorCard(modelId, message) {
            const model = availableModels.find(m => m.id === modelId);
            const container = document.createElement('div');
            container.className = 'bg-red-100 p-6 rounded-xl border-l-4 border-red-500 card-shadow';
            container.innerHTML = `<h4 class="font-bold text-red-800 text-xl">${model.name} 分析失敗</h4> <p class="text-red-700 mt-2">原因：${message}</p> <p class="text-red-600 text-sm mt-2">建議：請檢查API Key設定或網路連線，或簡化問題描述後重試。</p>`;
            document.getElementById('analysis-dashboard').appendChild(container);
        }
        
        function renderFinalRecommendationsError(message) {
            const container = document.getElementById('final-recommendations');
            container.innerHTML = `<div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-500"><h4 class="font-bold text-red-800">整合診斷報告生成失敗</h4><p class="text-sm text-red-700 mt-1">原因：${message}</p></div>`;
        }
        
        function giveFeedback(button, modelId, rating) {
            console.log(`Feedback for ${modelId}: ${rating}`);
            const parent = button.parentElement;
            parent.querySelectorAll('.feedback-button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }

        function safeJSONParse(rawString) {
            try { return JSON.parse(rawString); } catch (e1) {
                try {
                    const match = rawString.match(/```json\s*([\s\S]*?)\s*```/);
                    if (match && match[1]) return JSON.parse(match[1]);
                    const start = rawString.indexOf('{');
                    const end = rawString.lastIndexOf('}');
                    if (start > -1 && end > -1) return JSON.parse(rawString.substring(start, end + 1));
                    throw new Error("在字串中找不到有效的JSON。");
                } catch (e2) {
                    console.error("JSON 解析錯誤:", e2, "原始字串:", rawString);
                    return { error: true, message: "AI 回應格式錯誤，無法解析。" };
                }
            }
        }
        
        function generateReport() {
            const currentDate = new Date().toLocaleDateString('zh-TW');
            const companyName = diagnosisData.context?.industry ? `${diagnosisData.context.industry}企業` : '目標企業';
            let htmlContent = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>A2PSDM AI 戰略診斷報告</title><style>body{font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;line-height:1.8;padding:40px;max-width:1000px;margin:auto;color:#333;background:#fdfdfd}.header{text-align:center;border-bottom:4px solid #00274c;padding-bottom:30px;margin-bottom:40px}.header h1{color:#00274c;font-size:2.5em;margin-bottom:10px}.header .subtitle{color:#ffcb05;background:#00274c;padding:8px 20px;display:inline-block;border-radius:20px;font-weight:700}.meta-info{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px;border-left:5px solid #ffcb05}.section{margin-bottom:40px;page-break-inside:avoid}.section h2{color:#00274c;border-bottom:2px solid #ffcb05;padding-bottom:10px;margin-bottom:20px;font-size:1.8em}.section h3{color:#00274c;margin-top:25px;margin-bottom:15px;font-size:1.5em;border-left:4px solid #00274c;padding-left:10px}.section h4{color:#00274c;margin-top:20px;margin-bottom:10px;font-size:1.2em;font-weight:700}.section h5{color:#333;margin:10px 0 5px;font-size:1em;font-weight:700}.executive-summary{background:linear-gradient(135deg,#e8f0f7,#f0f8ff);padding:25px;border-radius:15px;border:1px solid #00274c;margin-bottom:30px}.analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}.analysis-card{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:20px;box-shadow:0 4px 8px #0000000d}.swot-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0}.swot-card{padding:15px;border-radius:8px;border-left:5px solid}.swot-strengths{background:#d4edda;border-left-color:#28a745}.swot-weaknesses{background:#f8d7da;border-left-color:#dc3545}.swot-opportunities{background:#d1ecf1;border-left-color:#17a2b8}.swot-threats{background:#fff3cd;border-left-color:#ffc107}.recommendation-box{background:linear-gradient(135deg,#fff2a6,#ffcb05);padding:20px;border-radius:10px;margin:15px 0;border:1px solid #00274c}.action-item{background:#f8f9fa;padding:15px;margin:10px 0;border-left:4px solid #00274c;border-radius:5px}ul,ol{padding-left:25px;margin:10px 0}li{margin-bottom:8px;line-height:1.6}.footer{margin-top:50px;padding-top:30px;border-top:2px solid #00274c;text-align:center;color:#666}.page-break{page-break-before:always}@media print{body{padding:20px}}</style></head><body><div class="header"><h1>AI 戰略診斷報告</h1><div class="subtitle">A2PSDM × 王博士 × 系統思維分析</div></div><div class="meta-info"><h4>📋 診斷基本資訊</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px"><div><strong>診斷對象：</strong>${companyName}</div><div><strong>產業別：</strong>${diagnosisData.context?.industry||"N/A"}</div><div><strong>企業規模：</strong>${diagnosisData.context?.companySize||"N/A"}</div><div><strong>商業模式：</strong>${diagnosisData.context?.businessModel||"N/A"}</div><div><strong>報告日期：</strong>${currentDate}</div><div><strong>診斷模型：</strong>${diagnosisData.selectedModels?diagnosisData.selectedModels.join(", ").toUpperCase():"N/A"}</div></div></div><div class="section"><h2>🎯 核心挑戰描述</h2><div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:5px solid #dc3545"><p style="font-size:1.1em;line-height:1.8;margin:0">${diagnosisData.context?.problem||"未提供具體挑戰描述"}</p></div></div>`;
            if (diagnosisData.finalRecommendations?.strategic_insight) { htmlContent += `<div class="section"><h2>📊 執行摘要</h2><div class="executive-summary"><h3 style="margin-top:0;color:#00274c">核心戰略洞察</h3><p style="font-size:1.1em;line-height:1.8">${diagnosisData.finalRecommendations.strategic_insight}</p></div></div>`; }
            htmlContent += `<div class="section page-break"><h2>📈 初始策略分析</h2></div>`;
            if (diagnosisData.analysisResults?.swot) { htmlContent += `<div class="section"><h3>SWOT 戰略分析</h3><div class="swot-grid"><div class="swot-card swot-strengths"><h4>💪 優勢 (S)</h4><ul>${(diagnosisData.analysisResults.swot.strengths||[]).map(s=>`<li>${s}</li>`).join("")}</ul></div><div class="swot-card swot-weaknesses"><h4>⚠️ 劣勢 (W)</h4><ul>${(diagnosisData.analysisResults.swot.weaknesses||[]).map(w=>`<li>${w}</li>`).join("")}</ul></div><div class="swot-card swot-opportunities"><h4>🚀 機會 (O)</h4><ul>${(diagnosisData.analysisResults.swot.opportunities||[]).map(o=>`<li>${o}</li>`).join("")}</ul></div><div class="swot-card swot-threats"><h4>⚡ 威脅 (T)</h4><ul>${(diagnosisData.analysisResults.swot.threats||[]).map(t=>`<li>${t}</li>`).join("")}</ul></div></div></div>`; }
            if (diagnosisData.analysisResults?.porters) { const p=diagnosisData.analysisResults.porters;htmlContent+=`<div class="section"><h3>產業競爭力分析 (波特五力)</h3><div class="analysis-grid">${(p.forces||[]).map(f=>{const l=f.level==="高"?"#dc3545":f.level==="中"?"#ffc107":"#28a745";return`<div class="analysis-card"><h4>${f.name} <span style="background:${l};color:#fff;padding:3px 8px;border-radius:12px;font-size:.8em;float:right">${f.level}</span></h4><p>${f.reason}</p></div>`}).join("")}</div><div class="recommendation-box"><h4 style="margin-top:0">📋 產業競爭總結</h4><p style="margin-bottom:0">${p.summary||""}</p></div></div>`;}
            if(diagnosisData.analysisResults?.pestel){const p=diagnosisData.analysisResults.pestel,l={political:"🏛️ 政治",economic:"💰 經濟",social:"👥 社會",technological:"🔬 技術",environmental:"🌍 環境",legal:"⚖️ 法律"};htmlContent+=`<div class="section"><h3>總體環境分析 (PESTEL)</h3><div class="analysis-grid">${Object.entries(p).map(([k,v])=>`<div class="analysis-card"><h4>${l[k]||k}</h4><ul>${(v||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div>`).join("")}</div></div>`}
            if(diagnosisData.analysisResults?.vpc){const v=diagnosisData.analysisResults.vpc;htmlContent+=`<div class="section"><h3>價值主張分析 (VPC)</h3><div class="analysis-grid"><div class="analysis-card"><h4>✨ 價值地圖</h4><h5>產品與服務</h5><ul>${(v.value_map?.products_services||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>痛點解方</h5><ul>${(v.value_map?.pain_relievers||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>獲益創造者</h5><ul>${(v.value_map?.gain_creators||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div><div class="analysis-card"><h4>👤 顧客輪廓</h4><h5>顧客任務</h5><ul>${(v.customer_profile?.jobs||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>痛點</h5><ul>${(v.customer_profile?.pains||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>期望獲益</h5><ul>${(v.customer_profile?.gains||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div></div></div>`}
            if(diagnosisData.analysisResults?.bmc){const b=diagnosisData.analysisResults.bmc;htmlContent+=`<div class="section"><h3>商業模式分析 (BMC)</h3><div class="analysis-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"><div class="analysis-card"><h4>🤝 關鍵合作夥伴</h4><ul>${(b.key_partnerships||[]).map(p=>`<li>${p}</li>`).join("")}</ul></div><div class="analysis-card"><h4>⚡ 關鍵活動</h4><ul>${(b.key_activities||[]).map(a=>`<li>${a}</li>`).join("")}</ul></div><div class="analysis-card"><h4>🎁 價值主張</h4><ul>${(b.value_propositions||[]).map(v=>`<li>${v}</li>`).join("")}</ul></div><div class="analysis-card"><h4>👥 顧客關係</h4><ul>${(b.customer_relationships||[]).map(r=>`<li>${r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>🎯 目標客群</h4><ul>${(b.customer_segments||[]).map(s=>`<li>${s}</li>`).join("")}</ul></div><div class="analysis-card"><h4>🔑 關鍵資源</h4><ul>${(b.key_resources||[]).map(r=>`<li>${r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>📢 通路管道</h4><ul>${(b.channels||[]).map(c=>`<li>${c}</li>`).join("")}</ul></div><div class="analysis-card"><h4>💰 收益流</h4><ul>${(b.revenue_streams||[]).map(r=>`<li>${r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>💸 成本結構</h4><ul>${(b.cost_structure||[]).map(c=>`<li>${c}</li>`).join("")}</ul></div></div></div>`}
            htmlContent += `<div class="section page-break"><h2>💡 創新方案設計工具箱</h2></div>`;
            if(diagnosisData.scamper){const s=diagnosisData.scamper;htmlContent+=`<div class="section"><h3>🧩 SCAMPER 創新解決方案</h3>${(s.strategic_insights||[]).length>0?`<h4>🎯 核心戰略洞察</h4><div class="analysis-grid">${s.strategic_insights.map(i=>`<div class="analysis-card" style="border-left:5px solid #ffcb05"><h5>${i.issue}</h5><p>${i.description}</p><p style="font-size:.9em;color:#666"><strong>數據依據:</strong> ${(i.data_sources||[]).join(", ")}</p></div>`).join("")}</div>`:""}<h4 style="margin-top:20px">💡 具體創新方案</h4>${(s.scamper_solutions||[]).map(s=>`<div class="analysis-card" style="margin-bottom:15px"><h5>${s.technique}: ${s.solution.title}</h5><p>${s.solution.description}</p><ul><li><strong>對應議題:</strong> ${s.strategic_issue}</li><li><strong>預期效益:</strong> ${(s.solution.expected_benefits||[]).join(", ")}</li></ul></div>`).join("")}${(s.priority_ranking||[]).length>0?`<h4 style="margin-top:20px">🚀 優先實施建議</h4><ol>${s.priority_ranking.slice(0,5).map(p=>`<li>${(typeof p === 'object' && p !== null) ? (p.title || '無標題建議') : p}</li>`).join("")}</ol>`:""}</div>`}
            if(diagnosisData.blue_ocean){const b=diagnosisData.blue_ocean,r=a=>(a||[]).map(i=>`<div class="analysis-card" style="padding:15px;margin-bottom:10px"><h5>${i.action}</h5><p style="font-size:.9em;margin:0">${i.rationale}</p></div>`).join("");htmlContent+=`<div class="section"><h3>🌊 藍海策略分析 (ERRC)</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div style="background:#f8d7da;padding:15px;border-radius:8px"><h4 style="color:#721c24">🚫 消除</h4>${r(b.eliminate)}</div><div style="background:#fff3cd;padding:15px;border-radius:8px"><h4 style="color:#856404">📉 減少</h4>${r(b.reduce)}</div><div style="background:#d1ecf1;padding:15px;border-radius:8px"><h4 style="color:#0c5460">📈 提升</h4>${r(b.raise)}</div><div style="background:#d4edda;padding:15px;border-radius:8px"><h4 style="color:#155724">✨ 創造</h4>${r(b.create)}</div></div></div>`}
            if(diagnosisData.design_thinking){htmlContent+=`<div class="section"><h3>🧠 設計思維流程</h3>${(diagnosisData.design_thinking.stages||[]).map(s=>`<div class="analysis-card" style="margin-bottom:15px;border-left:5px solid #00274c"><h4>${s.stage}</h4><p>${s.description}</p><h5>關鍵行動/問題:</h5><ul>${(s.actions||[]).map(a=>`<li>${a}</li>`).join("")}</ul></div>`).join("")}</div>`}
            if(diagnosisData.lean_startup){const l=diagnosisData.lean_startup;htmlContent+=`<div class="section"><h3>🚀 精實創業行動計畫</h3><h4>${l.title||""}</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px"><div class="analysis-card" style="background:#d1ecf1"><h4>1. 建立</h4><h5>關鍵假設</h5><p>${l.build?.key_hypothesis||""}</p><h5>MVP建議: ${l.build?.mvp_suggestion?.name||""}</h5><p>${l.build?.mvp_suggestion?.description||""}</p><ul>${(l.build?.mvp_suggestion?.features||[]).map(f=>`<li>${f}</li>`).join("")}</ul></div><div class="analysis-card" style="background:#d4edda"><h4>2. 衡量</h4><h5>關鍵指標</h5><ul>${(l.measure?.key_metrics||[]).map(m=>`<li><strong>${m.metric}:</strong> ${m.definition}</li>`).join("")}</ul><h5>衡量方法</h5><p>${l.measure?.measurement_method||""}</p></div><div class="analysis-card" style="background:#fff3cd"><h4>3. 學習</h4><h5>決策點</h5><p>${l.learn?.pivot_or_persevere||""}</p><h5>學習問題</h5><ul>${(l.learn?.learning_questions||[]).map(q=>`<li>${q}</li>`).join("")}</ul></div></div></div>`}
            if(diagnosisData.ten_types){htmlContent+=`<div class="section"><h3>🔟 十大創新類型機會點</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">${(diagnosisData.ten_types.categories||[]).map(c=>`<div class="analysis-card" style="background:#e8f0f7"><h4>${c.name}</h4><p style="font-size:.9em">${c.description}</p>${(c.types||[]).map(t=>`<div style="background:#fff;padding:10px;border-radius:5px;margin-top:10px"><h5>${t.type_name}</h5><ul>${(t.ideas||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div>`).join("")}</div>`).join("")}</div></div>`}
            if (diagnosisData.finalRecommendations) { const f = diagnosisData.finalRecommendations; htmlContent += `<div class="section page-break"><h2>🚀 戰略建議與行動方案</h2><div class="recommendation-box"><h3 style="margin-top:0">⚡ 立即行動方案 (30天內)</h3><div class="action-item"><ol>${(f.immediate_actions || []).map(a => `<li>${a}</li>`).join('')}</ol></div></div><h3>🗺️ 季度執行路線圖</h3><div class="analysis-grid">${(f.quarterly_roadmap || []).map(q => `<div class="analysis-card"><h4>${q.quarter}</h4><p>${q.focus}</p></div>`).join('')}</div><div class="recommendation-box"><h3 style="margin-top:0">🔮 長期願景</h3><p style="font-size:1.1em;line-height:1.8;margin-bottom:0">${f.long_term_vision || ''}</p></div></div>`; }
            htmlContent += `<div class="footer"><h3>關於 A2PSDM 顧問服務</h3><p><strong>王博士</strong> | A2PSDM</p><p>密西根大學博士 × 30年產業經驗 × AI創新整合</p><p>本報告由 A2PSDM AI 診斷平台生成 | © 2025 A2PSDM</p><p style="margin-top:20px;font-size:.9em;color:#888">如需深度諮詢服務，請聯繫：dr.cliffwang@a2psdm.com</p></div></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `A2PSDM_戰略診斷報告_${currentDate.replace(/\//g, '')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function scheduleConsultation() {
            const subject = encodeURIComponent('A2PSDM深度戰略諮詢預約申請');
            const body = encodeURIComponent(`王博士團隊：\n\n我已透過AI診斷平台完成初步分析，希望預約深度諮詢。\n\n診斷挑戰：${diagnosisData.context?.problem || '待填寫'}\n\n期待您的專業指導！`);
            window.open(`mailto:dr.cliffwang@a2psdm.com?subject=${subject}&body=${body}`);
        }

        window.onload = () => {
            const modelSelectionDiv = document.getElementById('model-selection');
            availableModels.forEach(model => {
                const modelElement = document.createElement('div');
                modelElement.innerHTML = `<input type="checkbox" id="model-${model.id}" value="${model.id}" class="hidden model-checkbox" checked><label for="model-${model.id}" class="block border-2 border-gray-300 rounded-lg p-4 cursor-pointer transition-all duration-200 hover:border-michigan-blue"><h4 class="font-bold text-michigan-blue">${model.name}</h4><p class="text-sm text-gray-600 mt-1">${model.description}</p></label>`;
                modelSelectionDiv.appendChild(modelElement);
            });
            try {
                const s = getSettings();
                if (s.provider) document.getElementById('aiProvider').value = s.provider;
                if (s.apiKey) document.getElementById('apiKey').value = s.apiKey;
                runtimeSettings = s;
            } catch(e){ console.warn('設定載入失敗', e); }
            updateProgress(1);
        };
    </script>
</body>
</html>

