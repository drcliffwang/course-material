<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2PSDM AI è¨ºæ–·å¹³å° - ç‹åšå£«</title>
    <!-- ä¸å†éœ€è¦ jspdf å’Œ html2canvasï¼Œå·²ç§»é™¤ä»¥åŠ é€Ÿé é¢è¼‰å…¥ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        :root {
            --michigan-blue: #00274C; --michigan-maize: #FFCB05;
            --michigan-blue-light: #4A90A4; --michigan-blue-dark: #001B2E;
            --michigan-maize-light: #FFF2A6; --michigan-blue-lightest: #E8F0F7;
        }
        .text-michigan-blue { color: var(--michigan-blue); }
        .bg-michigan-blue { background-color: var(--michigan-blue); }
        .border-michigan-maize { border-color: var(--michigan-maize); }
        .text-michigan-maize { color: var(--michigan-maize); }
        .bg-michigan-maize { background-color: var(--michigan-maize); }
        .bg-michigan-blue-lightest { background-color: var(--michigan-blue-lightest); }
        .bg-michigan-maize-lightest { background-color: var(--michigan-maize-lightest); }

        .header-gradient { background: linear-gradient(135deg, var(--michigan-blue) 0%, var(--michigan-blue-light) 100%); }
        .michigan-button {
            background: linear-gradient(135deg, var(--michigan-blue), var(--michigan-blue-light)); color: var(--michigan-maize);
            transition: all 0.3s ease; border: 2px solid transparent; font-weight: 600;
        }
        .michigan-button:hover {
            background: var(--michigan-blue-dark); border-color: var(--michigan-maize);
            transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 39, 76, 0.4);
        }
        .michigan-button-secondary {
            background: var(--michigan-maize); color: var(--michigan-blue); border: 2px solid var(--michigan-blue);
            transition: all 0.3s ease; font-weight: 600;
        }
        .michigan-button-secondary:hover {
            background: var(--michigan-maize-light); transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 203, 5, 0.4);
        }
        .focus-michigan:focus {
            outline: none; box-shadow: 0 0 0 3px rgba(255, 203, 5, 0.3); border-color: var(--michigan-maize);
        }
        .card-shadow { box-shadow: 0 4px 16px rgba(0, 39, 76, 0.1); }
        .progress-bar-container { background-color: #e0e0e0; border-radius: 9999px; overflow: hidden; }
        .progress-bar {
            background-color: var(--michigan-maize); height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .model-checkbox:checked + label {
            border-color: var(--michigan-blue); background-color: var(--michigan-blue-lightest);
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 39, 76, 0.1);
        }
        .feedback-button {
            background-color: #e2e8f0; border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .feedback-button:hover { background-color: #cbd5e1; transform: scale(1.1); }
        .feedback-button.selected { background-color: var(--michigan-maize); }
        /* --- [æ–°å¢] å‰µæ–°æ–¹æ³•é ç±¤æ¨£å¼ --- */
        .innovation-tab {
            cursor: pointer; padding: 10px 20px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500; color: #4a5568;
        }
        .innovation-tab:hover {
            color: var(--michigan-blue);
            background-color: var(--michigan-blue-lightest);
        }
        .innovation-tab.active {
            color: var(--michigan-blue);
            border-bottom-color: var(--michigan-maize);
            font-weight: 700;
        }
        .innovation-content {
            display: none;
        }
        .innovation-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <header class="header-gradient shadow-lg border-b-4 border-michigan-maize sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="Cliff Baby Pic by GPT.jpg" alt="ç‹åšå£«" class="h-16 w-16 rounded-full border-2 border-michigan-maize object-cover" onerror="this.onerror=null; this.src='https://placehold.co/64x64/FFCB05/00274C?text=Dr.Wang';">
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-michigan-maize">A2PSDM AIè¨ºæ–·å¹³å°</h1>
                        <p class="text-sm text-white">ç‹åšå£« Ã— ç³»çµ±æ€ç¶­ Ã— å‰µæ–°æ¿€ç™¼</p>
                    </div>
                </div>
            </div>
             <!-- é€²åº¦æ¢ -->
            <div class="mt-4">
                <div id="progress-container" class="progress-bar-container h-2.5 w-full">
                    <div id="progress-bar" class="progress-bar" style="width: 10%;"></div>
                </div>
                <div id="progress-label" class="text-center text-xs text-white mt-1">éšæ®µ 1 / 5: èƒŒæ™¯è¨­å®š</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="space-y-8">
            <!-- API è¨­å®š -->
            <div id="api-settings" class="bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200 mb-8">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">AI å¼•æ“è¨­å®š</h2>
                <p class="text-gray-600 mb-2">API Key: ä½¿ç”¨(Gemini, GPT, Deepseek)æ¨¡å‹ï¼Œè«‹æ–¼æ­¤è™•è¨­å®šã€‚</p>
                <!-- [ä¿®æ”¹] æ–°å¢ API Key å–å¾—èªªæ˜ -->
                <p class="text-sm text-gray-500 mb-6">
                    æ‚¨çš„API Key é‡‘é‘°åªæœƒå„²å­˜åœ¨æ‚¨ç›®å‰çš„ç€è¦½å™¨ä¸­, å¯å¾ 
                    <a href="https://aistudio.google.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">Google AI Studio</a> (æ¨è–¦,å…è²»ä¸­), 
                    <a href="https://platform.deepseek.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">Deepseek</a>, æˆ– 
                    <a href="https://platform.openai.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">OpenAI</a> å–å¾—ã€‚
                </p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="aiProvider" class="block text-sm font-semibold text-michigan-blue mb-2">AI æœå‹™æä¾›å•†</label>
                        <select id="aiProvider" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                            <option value="gemini">Gemini (é è¨­)</option>
                            <option value="openai">OpenAI GPT</option>
                            <option value="deepseek">DeepSeek</option>
                        </select>
                    </div>
                    <div>
                        <label for="apiKey" class="block text-sm font-semibold text-michigan-blue mb-2">API Key (é¸å¡«)</label>
                        <input type="password" id="apiKey" placeholder="ä½¿ç”¨ API Key è«‹å¡«å¯«" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                    </div>
                </div>
                <div class="text-right mt-6">
                    <button onclick="saveSettings()" class="michigan-button px-6 py-3 rounded-lg">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </div>

            <!-- éšæ®µ 1: ä¼æ¥­èƒŒæ™¯è¨­å®š -->
            <div id="stage-1" class="bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">éšæ®µ 1: ä¼æ¥­èƒŒæ™¯è¨­å®š</h2>
                <p class="text-gray-600 mb-6">æä¾›æº–ç¢ºçš„èƒŒæ™¯è³‡è¨Šï¼Œå°‡è®“AIçš„åˆ†ææ›´è²¼è¿‘æ‚¨çš„çœŸå¯¦æƒ…æ³ã€‚</p>
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <input id="industry" type="text" placeholder="æ‰€å±¬ç”¢æ¥­ (ä¾‹å¦‚: åŠå°é«”)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                    <select id="companySize" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan" aria-label="ä¼æ¥­è¦æ¨¡">
                        <option value="æ–°å‰µå…¬å¸ (1-50äºº)">ä¼æ¥­è¦æ¨¡: æ–°å‰µå…¬å¸</option>
                        <option value="ä¸­å°å‹ä¼æ¥­ (51-500äºº)">ä¼æ¥­è¦æ¨¡: ä¸­å°å‹ä¼æ¥­</option>
                        <option value="å¤§å‹ä¼æ¥­ (501-2000äºº)">ä¼æ¥­è¦æ¨¡: å¤§å‹ä¼æ¥­</option>
                        <option value="ä¸Šå¸‚/è·¨åœ‹å…¬å¸ (2000äººä»¥ä¸Š)">ä¼æ¥­è¦æ¨¡: ä¸Šå¸‚/è·¨åœ‹å…¬å¸</option>
                    </select>
                    <input id="businessModel" type="text" placeholder="ä¸»è¦å•†æ¥­æ¨¡å¼ (ä¾‹å¦‚: B2Bç¡¬é«”éŠ·å”®)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                </div>
                <!-- [ä¿®æ”¹] åŠ å…¥å¸¶å…¥ç¯„ä¾‹æŒ‰éˆ• -->
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-sm font-semibold text-michigan-blue">è«‹ç°¡è¦æè¿°æ‚¨çš„æ ¸å¿ƒæŒ‘æˆ°ï¼š</label>
                    <button onclick="loadExampleChallenge()" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg transition-colors">
                        å¸¶å…¥ç¯„ä¾‹
                    </button>
                </div>
                <textarea id="problemDescription" rows="4" placeholder="ä¾‹å¦‚ï¼šå¸‚å ´ç«¶çˆ­æ¿€çƒˆã€æŠ€è¡“è½‰å‹å›°é›£ã€ç‡Ÿæ”¶æˆé•·ç·©æ…¢..." class="w-full px-4 py-4 border-2 border-gray-300 rounded-lg focus-michigan resize-none"></textarea>
                <div class="text-center mt-6">
                    <button onclick="goToStage(2)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg">â¡ï¸ é¸æ“‡è¨ºæ–·æ¨¡å‹</button>
                </div>
            </div>

            <!-- éšæ®µ 2: é¸æ“‡è¨ºæ–·æ¨¡å‹ -->
            <div id="stage-2" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">éšæ®µ 2: é¸æ“‡è¨ºæ–·æ¨¡å‹å·¥å…·ç®±</h2>
                <p class="text-gray-600 mb-6">è«‹é¸æ“‡æ‚¨å¸Œæœ› AI é‹ç”¨çš„ç®¡ç†åˆ†ææ¨¡å‹ã€‚é¸æ“‡è¶Šå¤šï¼Œåˆ†æç¶­åº¦è¶Šå…¨é¢ï¼Œä½†æ‰€éœ€æ™‚é–“ä¹Ÿè¶Šé•·ã€‚</p>
                <!-- [ä¿®æ”¹] æ­¤è™• grid-cols-3 å·²å¤±æ•ˆï¼Œå°‡ç”± grid-cols-4 å–ä»£ä»¥å®¹ç´æ–°é …ç›® -->
                <div id="model-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Models will be inserted here by JS -->
                </div>
                <div class="text-center mt-6 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(1)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸ è¿”å›èƒŒæ™¯è¨­å®š</button>
                    <button id="stage2-action-btn" onclick="runAnalysis()" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ”¬ é–‹å§‹æ·±åº¦åˆ†æ</button>
                </div>
            </div>

            <!-- éšæ®µ 3: åˆ†æå„€è¡¨æ¿ -->
            <div id="stage-3" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">éšæ®µ 3: AI ç­–ç•¥åˆ†æå„€è¡¨æ¿</h2>
                <div id="analysis-dashboard" class="space-y-6">
                    <!-- Analysis results will be appended here -->
                </div>
                 <div class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(2)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸ è¿”å›æ¨¡å‹é¸æ“‡</button>
                    <button onclick="goToStage(4)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ’¡ é€²å…¥å‰µæ–°æ–¹æ¡ˆè¨­è¨ˆ</button>
                </div>
            </div>

            <!-- éšæ®µ 4: å‰µæ–°è¨­è¨ˆ (å°å…¥é ç±¤) -->
            <div id="stage-4" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                 <h2 class="text-2xl font-bold text-michigan-blue mb-2">éšæ®µ 4: å‰µæ–°æ–¹æ¡ˆè¨­è¨ˆå·¥å…·ç®±</h2>
                 <p class="text-gray-600 mb-6">åŸºæ–¼å‰è¿°åˆ†æï¼ŒAI å°‡é‹ç”¨å¤šç¨®å‰µæ–°æ–¹æ³•ï¼Œç³»çµ±æ€§åœ°ç‚ºæ‚¨æ¿€ç™¼çªç ´æ€§çš„è§£æ±ºæ–¹æ¡ˆã€‚</p>
                <!-- Auto-Run All for Innovation Methods -->
                <div class="flex flex-col md:flex-row items-start md:items-center gap-3 mb-4">
                    <button id="autoRunAllBtn" onclick="autoRunAll()" class="michigan-button px-4 py-2 rounded-lg shadow">
                        ğŸš€ è‡ªå‹•åŸ·è¡Œå…¨éƒ¨å‰µæ–°åˆ†æ
                    </button>
                    <span id="autoRunStatus" class="text-xs text-gray-600">
                        ï¼ˆä¾åºåŸ·è¡Œï¼šSCAMPER â†’ è—æµ·ç­–ç•¥ â†’ è¨­è¨ˆæ€ç¶­ â†’ ç²¾å¯¦å‰µæ¥­ â†’ åå¤§å‰µæ–°ï¼‰
                    </span>
                    <label class="ml-0 md:ml-auto flex items-center gap-2 text-xs text-gray-600">
                        <input type="checkbox" id="autoSwitchToNextTab" class="accent-michigan-blue" checked>
                        è‡ªå‹•åˆ‡æ›åˆ†é é¡¯ç¤ºé€²åº¦
                    </label>
                </div>

                
                 <!-- å‰µæ–°æ–¹æ³•é ç±¤ -->
                <div class="border-b border-gray-200 mb-6">
                    <nav id="innovation-tabs" class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button onclick="showInnovationTab('scamper')" class="innovation-tab active" data-tab="scamper">SCAMPER</button>
                        <button onclick="showInnovationTab('blue_ocean')" class="innovation-tab" data-tab="blue_ocean">è—æµ·ç­–ç•¥</button>
                        <button onclick="showInnovationTab('design_thinking')" class="innovation-tab" data-tab="design_thinking">è¨­è¨ˆæ€ç¶­</button>
                        <button onclick="showInnovationTab('lean_startup')" class="innovation-tab" data-tab="lean_startup">ç²¾å¯¦å‰µæ¥­</button>
                        <button onclick="showInnovationTab('ten_types')" class="innovation-tab" data-tab="ten_types">åå¤§å‰µæ–°é¡å‹</button>
                    </nav>
                </div>

                <!-- å‰µæ–°æ–¹æ³•å…§å®¹å®¹å™¨ -->
                <div id="innovation-content-container">
                    <div id="innovation-content-scamper" class="innovation-content active">
                        <div id="scamper-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-blue_ocean" class="innovation-content">
                        <div id="blue-ocean-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-design_thinking" class="innovation-content">
                         <div id="design-thinking-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-lean_startup" class="innovation-content">
                        <div id="lean-startup-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-ten_types" class="innovation-content">
                         <div id="ten-types-result" class="space-y-6"></div>
                    </div>
                </div>

                <div class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(3)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸ è¿”å›åˆ†æå„€è¡¨æ¿</button>
                    <button onclick="goToStage(5)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ“„ ç”¢ç”Ÿæœ€çµ‚å ±å‘Š</button>
                </div>
            </div>
            
            <!-- éšæ®µ 5: æœ€çµ‚å ±å‘Šèˆ‡è¡Œå‹•æ–¹æ¡ˆ -->
            <div id="stage-5" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">éšæ®µ 5: æ•´åˆè¨ºæ–·å ±å‘Šèˆ‡è¡Œå‹•æ–¹æ¡ˆ</h2>
                <div id="final-recommendations" class="mb-8">
                    <!-- Final recommendations will be here -->
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex flex-wrap justify-center items-center gap-4">
                        <button onclick="goToStage(4)" class="michigan-button-secondary px-8 py-4 rounded-lg text-lg shadow-lg">â¬…ï¸ è¿”å›å‰µæ–°è¨­è¨ˆ</button>
                        <button onclick="generateReport()" class="michigan-button px-8 py-4 rounded-lg text-lg shadow-lg">ğŸ“¥ ä¸‹è¼‰å°ˆæ¥­è¨ºæ–·å ±å‘Š</button>
                        <button onclick="scheduleConsultation()" class="michigan-button-secondary px-8 py-4 rounded-lg text-lg shadow-lg">ğŸ“… é ç´„ç‹åšå£«æ·±åº¦è«®è©¢</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 text-center shadow-2xl max-w-sm mx-auto">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-michigan-blue mx-auto mb-6"></div>
            <p class="text-xl font-semibold text-michigan-blue mb-2">ç‹åšå£«çš„AIé¡§å•æ­£åœ¨ç‚ºæ‚¨åˆ†æ...</p>
            <p id="loadingMessage" class="text-sm text-gray-600">å•Ÿå‹•ç³»çµ±æ€§æ€ç¶­å¼•æ“</p>
        </div>
    </div>
    
    <footer class="bg-michigan-blue text-white py-8 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p class="font-semibold text-michigan-maize">A2PSDM | ç‹åšå£«</p>
            <p class="text-gray-400 mt-1">Â© 2025 A2PSDM Ã— å¯†è¥¿æ ¹å¤§å­¸å­¸è¡“å‚³æ‰¿ Ã— AIå‰µæ–°æŠ€è¡“</p>
        </div>
    </footer>

    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
        let diagnosisData = { stage: 1 };
        
        // è¨­å®šä¿å­˜ï¼šlocalStorage
        const SETTINGS_KEY = 'a2psdm_ai_settings_v1';
        function getSettings() {
            try {
                const raw = localStorage.getItem(SETTINGS_KEY);
                return raw ? JSON.parse(raw) : { provider: 'gemini', apiKey: '' };
            } catch(e) {
                return { provider: 'gemini', apiKey: '' };
            }
        }
        function setSettings(s) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
        }
        let runtimeSettings = getSettings();

        const DR_WANG_PERSONA = `æ‚¨æ˜¯ä¸€ä½åœ¨å¯†è¥¿æ ¹å¤§å­¸å—éåš´æ ¼å­¸è¡“è¨“ç·´ã€æ“æœ‰30å¹´ç”¢æ¥­é¡§å•ç¶“é©—çš„åšå£«ç´šå°ˆå®¶ç‹å•Ÿå²³ã€‚æ‚¨çš„åˆ†æçµåˆäº†ç³»çµ±æ€§ã€çµæ§‹åŒ–çš„é‚è¼¯æ€ç¶­èˆ‡å‰µæ–°çš„è§£æ±ºæ–¹æ¡ˆè¨­è¨ˆã€‚è«‹ä»¥å°ˆæ¥­ã€ç²¾æº–ã€å…·æ´å¯ŸåŠ›çš„èªæ°£ï¼Œæä¾›æˆ°ç•¥å±¤ç´šçš„å»ºè­°ï¼Œä¸¦åªä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚`;
        
        // --- [ä¿®æ”¹] åŠ å…¥ç¬¬å…­ç¨®å·¥å…·ï¼šå®¢æˆ¶æ—…ç¨‹ ---
        const availableModels = [
            { id: 'swot', name: 'SWOT åˆ†æ', description: 'è©•ä¼°å…§éƒ¨å„ªåŠ£å‹¢èˆ‡å¤–éƒ¨æ©Ÿæœƒå¨è„…ï¼Œæä¾›æˆ°ç•¥å…¨å±€è§€ã€‚' },
            { id: 'porters', name: 'æ³¢ç‰¹äº”åŠ›åˆ†æ', description: 'åˆ†æç”¢æ¥­ç«¶çˆ­çµæ§‹ï¼Œåˆ¤æ–·ç”¢æ¥­å¸å¼•åŠ›èˆ‡ç²åˆ©æ½›åŠ›ã€‚' },
            { id: 'pestel', name: 'PESTEL åˆ†æ', description: 'æƒæç¸½é«”ç’°å¢ƒä¸­çš„æ”¿æ²»ã€ç¶“æ¿Ÿã€ç¤¾æœƒã€æŠ€è¡“ã€ç’°å¢ƒã€æ³•å¾‹ç­‰é—œéµå› ç´ ã€‚' },
            { id: 'bmc', name: 'å•†æ¥­æ¨¡å¼ (BMC)', description: 'è§£æ§‹ä¸¦å¯è¦–åŒ–å•†æ¥­æ¨¡å¼çš„ä¹å€‹æ ¸å¿ƒè¦ç´ ï¼Œå°‹æ‰¾å‰µæ–°é»ã€‚' },
            { id: 'vpc', name: 'åƒ¹å€¼ä¸»å¼µåˆ†æ (VPC)', description: 'è¨­è¨ˆé¡§å®¢çœŸæ­£éœ€è¦çš„ç”¢å“èˆ‡æœå‹™ï¼Œå‰µé€ åƒ¹å€¼å¥‘åˆã€‚' },
            { id: 'customerJourney', name: 'å®¢æˆ¶æ—…ç¨‹ (Customer Journey)', description: 'åˆ†æé¡§å®¢å¾èªçŸ¥åˆ°è³¼è²·çš„ AIDA/AISAS å®Œæ•´æ­·ç¨‹ï¼ŒåŒ…å«å„éšæ®µç—›é»è©•åˆ†(1-10)èˆ‡è§£æ±ºæ–¹æ¡ˆå»ºè­°ã€‚' },
            { id: 'blueOcean', name: 'è—æµ·ç­–ç•¥ (Blue Ocean)', description: 'å››é …è¡Œå‹•æ¶æ§‹(æ¸›é™¤-é™ä½-æå‡-å‰µé€ )ï¼Œèšç„¦å·®ç•°åŒ–è—æµ·æ©Ÿæœƒèˆ‡å‰µæ–°ç­–ç•¥ã€‚' }
        ];

        // --- [æ–°å¢] å¸¶å…¥ç¯„ä¾‹æŒ‘æˆ°çš„å‡½æ•¸ ---
        function loadExampleChallenge() {
            document.getElementById('industry').value = "ä»£å·¥å‚³ç”¢OEM/ODM";
            document.getElementById('companySize').value = "ä¸­å°å‹ä¼æ¥­ (51-500äºº)";
            document.getElementById('businessModel').value = "å‚³çµ±è»Šä»¶èˆ‡é‡‘å±¬åŠ å·¥";
            const exampleText = "éå»äºŒåå¹´ï¼Œæˆ‘å€‘å¾åšå‚³çµ±è»Šä»¶èˆ‡é‡‘å±¬åŠ å·¥çš„ä»£å·¥å‚³ç”¢ï¼Œæ“´å±•åˆ°æ¨¡çµ„åŒ–çµ„è£èˆ‡ODMï¼Œé–‹å§‹ç´¯ç©æŠ€è¡“èˆ‡è¨­è¨ˆèƒ½é‡ã€‚10å¹´å‰é–‹å§‹å“ç‰Œä¹‹è·¯ã€‚æˆ‘å€‘èˆ‡ä¸–ç•Œç´šæ‰‹å·¥å…·å“ç‰Œè¯ååˆä½œï¼Œé€æ¼¸æ‰“éŸ¿åè™Ÿï¼›ç›®å‰å“ç‰Œç‡Ÿæ”¶å ç¸½ç‡Ÿæ”¶çš„ä¸‰åˆ†ä¹‹ä¸€ï¼Œä¹Ÿå°‡å…¬å¸æ¯›åˆ©æé«˜å…©æˆã€‚ç„¶è€Œï¼Œåšå“ç‰Œéœ€è¦çš„äººæ‰èˆ‡ä»£å·¥çš„äººæ‰ï¼Œæ˜¯å…©ç¨®æˆªç„¶ä¸åŒçš„ã€Œç‰©ç¨®ã€ ã€‚æˆ‘å€‘å¾å¤–éƒ¨æ‰¾äººä¾†åšå“ç‰Œï¼Œå›°é›£é‡é‡ï¼šé¦–å…ˆï¼Œé–‹ä¸èµ·å¸‚å ´è¡Œæƒ…åƒ¹ï¼›å…¶æ¬¡ï¼Œäººæ‰é€²ä¾†é›£ä»¥æºé€šã€æ°´åœŸä¸æœï¼›ç¬¬ä¸‰ï¼Œç£¨åˆä¸é †å¾Œé›¢è·ï¼Œåˆå¾—å¾é ­ä¾†éã€‚å¦æ–¹é¢ï¼Œæˆ‘å€‘ä¹ŸåŒæ­¥å…§éƒ¨åŸ¹é¤Šã€‚å·¥å» è£¡çš„è€å“¡å·¥è¦å¾éå»çš„ã€Œäº¤è²¨é‚è¼¯ã€åˆ‡æ›åˆ°ã€Œåƒ¹å€¼å‰µé€ é‚è¼¯ã€ï¼Œéœ€è¦æ™‚é–“ç£¨ã€‚ä½†å®¢æˆ¶ã€å¸‚å ´ã€ç«¶çˆ­è€…æ­¥æ­¥ç·Šé€¼ï¼Œç©¶ç«Ÿè¦æŠ•å…¥è³‡æºåŸ¹é¤ŠåŸæœ‰åœ˜éšŠï¼Œä»¥æ±‚ç©©å®šæ–‡åŒ–ã€æ…¢æ…¢è½‰å‹ï¼Ÿé‚„æ˜¯å¾å¤–éƒ¨æ‹›å‹Ÿå“ç‰Œé«˜æ‰‹ï¼Œå†’è‘—æ–‡åŒ–è¡çªçš„é¢¨éšªï¼Œä¾†æ›å–è½‰å‹é€Ÿåº¦ï¼Ÿåšå“ç‰Œï¼Œç”¢å“åªæ˜¯å…¥å ´åˆ¸ï¼ŒçœŸæ­£çš„æˆ°å ´åœ¨æ–¼ã€Œçµ„ç¹”èƒ½ä¸èƒ½è·Ÿä¸Šå“ç‰Œè…³æ­¥ã€ã€‚";
            document.getElementById('problemDescription').value = exampleText;
        }

        // --- UI æ§åˆ¶ ---
        function updateProgress(stage) {
            diagnosisData.stage = stage;
            const totalStages = 5;
            const percentage = (stage / totalStages) * 100;
            const labels = ["èƒŒæ™¯è¨­å®š", "é¸æ“‡æ¨¡å‹", "åˆ†æå„€è¡¨æ¿", "å‰µæ–°è¨­è¨ˆ", "æœ€çµ‚å ±å‘Š"];
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-label').textContent = `éšæ®µ ${stage} / ${totalStages}: ${labels[stage-1]}`;
        }
        
        async function goToStage(stageNumber) {
            if (stageNumber === 2) {
                const newContext = {
                    industry: document.getElementById('industry').value.trim(),
                    companySize: document.getElementById('companySize').value,
                    businessModel: document.getElementById('businessModel').value.trim(),
                    problem: document.getElementById('problemDescription').value.trim()
                };

                if (!newContext.industry || !newContext.problem) {
                    alert('è«‹å¡«å¯«ã€Œæ‰€å±¬ç”¢æ¥­ã€èˆ‡ã€Œæ ¸å¿ƒæŒ‘æˆ°ã€ä»¥åˆ©åˆ†æã€‚'); 
                    return;
                }
                
                // [è¨»] æ­¤è™•é‚è¼¯æœƒè‡ªå‹•æ¸…é™¤ analysisResultsï¼ŒåŒ…å«æ–°åŠ å…¥çš„ customerJourneyï¼Œä¸éœ€é¡å¤–ä¿®æ”¹
                if(JSON.stringify(diagnosisData.context) !== JSON.stringify(newContext)) {
                    diagnosisData.analysisResults = {};
                    diagnosisData.scamper = null;
                    diagnosisData.blue_ocean = null;
                    diagnosisData.design_thinking = null;
                    diagnosisData.lean_startup = null;
                    diagnosisData.ten_types = null;
                    diagnosisData.finalRecommendations = null;
                }
                diagnosisData.context = newContext;
            }
            
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`stage-${i}`).classList.add('hidden');
            }
            document.getElementById('api-settings').classList.add('hidden');

            const targetStage = document.getElementById(`stage-${stageNumber}`);
            if (targetStage) {
                targetStage.classList.remove('hidden');
                updateProgress(stageNumber);
                window.scrollTo({ top: targetStage.offsetTop - 120, behavior: 'smooth' });
                
                if (stageNumber === 2) {
                    const actionButton = document.getElementById('stage2-action-btn');
                    const analysisDone = diagnosisData.analysisResults && Object.keys(diagnosisData.analysisResults).length > 0;
                    if (analysisDone) {
                        actionButton.textContent = 'â¡ï¸ æŸ¥çœ‹åˆ†æçµæœ';
                        actionButton.onclick = () => goToStage(3);
                    } else {
                        actionButton.textContent = 'ğŸ”¬ é–‹å§‹æ·±åº¦åˆ†æ';
                        actionButton.onclick = runAnalysis;
                    }
                }

                if (stageNumber === 4 && !diagnosisData.scamper) {
                    showInnovationTab('scamper');
                } else if (stageNumber === 5 && !diagnosisData.finalRecommendations) {
                    await generateFinalRecommendationsAnalysis();
                }
            }
        }
        
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        function saveSettings() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            runtimeSettings = { provider, apiKey };
            setSettings(runtimeSettings);
            
            let message = 'âœ… è¨­å®šå·²å„²å­˜ï¼\n\n';
            
            if (provider === 'gemini') {
                message += 'ğŸ¯ Gemini å·²å„ªåŒ–ç‚ºæœ€ä½³å‰ç«¯é«”é©—ï¼Œå°‡æä¾›ç©©å®šçš„åˆ†ææœå‹™ã€‚';
            } else {
                message += `âš ï¸ ${provider.toUpperCase()} è¨­å®šå®Œæˆã€‚\n\n`;
                message += 'ğŸ“‹ ç›¸å®¹æ€§èªªæ˜ï¼š\n';
                message += 'â€¢ ç³»çµ±å·²æ¡ç”¨ç¶“éé©—è­‰çš„ API èª¿ç”¨æ¶æ§‹\n';
                message += 'â€¢ å¦‚é‡é€£ç·šå•é¡Œï¼Œå°‡æä¾›è©³ç´°è¨ºæ–·è³‡è¨Š\n';
                message += 'â€¢ å»ºè­°åŒæ™‚è¨­å®š Gemini ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ';
            }
            
            alert(message);
            
            testConnectivity(provider, apiKey).catch(e => 
                console.warn('é€£ç·šæ¸¬è©¦çµæœ:', e.message)
            );
        }

        async function callAI(prompt, retries = 3, delay = 1000) {
            const provider = (runtimeSettings?.provider || 'gemini').toLowerCase();
            const key = runtimeSettings?.apiKey || '';

            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    let response;
                    if (provider === 'gemini') {
                        response = await callGeminiAPI(prompt, key);
                    } else if (provider === 'openai') {
                        if (!key) throw new Error('OpenAI éœ€è¦ API Keyï¼Œè«‹å…ˆè¨­å®šã€‚');
                        response = await callOpenAIAPI(prompt, key);
                    } else if (provider === 'deepseek') {
                        if (!key) throw new Error('DeepSeek éœ€è¦ API Keyï¼Œè«‹å…ˆè¨­å®šã€‚');
                        response = await callDeepSeekAPI(prompt, key);
                    } else {
                        throw new Error('ä¸æ”¯æ´çš„ AI æä¾›å•†');
                    }
                    return response;
                } catch (error) {
                    console.error(`AI èª¿ç”¨å¤±æ•— (å˜—è©¦ ${attempt + 1}/${retries + 1}):`, error);
                    if (error.message.includes('API key not valid') || error.message.includes('æ¬Šé™') || error.message.includes('API Key')) {
                        throw new Error(`API Key é©—è­‰å¤±æ•—æˆ–æ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥æ‚¨çš„ ${provider.toUpperCase()} API Key è¨­å®šã€‚`);
                    }
                    if (attempt < retries) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, attempt)));
                        continue;
                    }
                    throw new Error(`å˜—è©¦ ${retries + 1} æ¬¡å¾Œï¼ŒAI åˆ†æä»ç„¶å¤±æ•—: ${error.message}`);
                }
            }
        }

        async function callGeminiAPI(prompt, apiKey) {
            const model = 'gemini-2.5-flash';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const combinedPrompt = `${DR_WANG_PERSONA}\n\n[è¨ºæ–·åˆ†æè«‹æ±‚]\n${prompt}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: combinedPrompt }] }],
                generationConfig: { 
                    temperature: 0.5, topK: 40, topP: 0.95,
                    response_mime_type: "application/json",
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `Gemini API éŒ¯èª¤ ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\nè©³ç´°éŒ¯èª¤ï¼š${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\nå›æ‡‰å…§å®¹ï¼š${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (!candidate?.content?.parts?.[0]?.text) {
                 if (result.promptFeedback?.blockReason) {
                    throw new Error(`Gemini è«‹æ±‚è¢«é˜»æ“‹ï¼ŒåŸå› ï¼š${result.promptFeedback.blockReason}`);
                }
                throw new Error(`Gemini å›æ‡‰æ ¼å¼ç•°å¸¸ï¼š${JSON.stringify(result, null, 2)}`);
            }
            return candidate.content.parts[0].text;
        }

        async function callOpenAIAPI(prompt, apiKey) {
            const apiUrl = 'https://api.openai.com/v1/chat/completions';
            const payload = {
                model: 'gpt-4o-mini',
                messages: [
                { role: 'system', content: DR_WANG_PERSONA },
                { role: 'system', content: 'ä½ æ˜¯ä¸€å€‹åªè¼¸å‡º JSON çš„æ¨¡å‹ï¼Œæ‰€æœ‰å›æ‡‰å¿…é ˆæ˜¯æœ‰æ•ˆçš„ JSON ç‰©ä»¶ï¼ˆjsonï¼‰ï¼Œä¸è¦è¼¸å‡ºå…¶ä»–èªªæ˜æ–‡å­—ã€‚' },
                { role: 'user', content: prompt }
            ],
                response_format: { type: "json_object" },
                temperature: 0.5
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `OpenAI API éŒ¯èª¤ ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\nè©³ç´°éŒ¯èª¤ï¼š${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\nå›æ‡‰å…§å®¹ï¼š${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            if (!result.choices?.[0]?.message?.content) { throw new Error(`OpenAI å›æ‡‰æ ¼å¼ç•°å¸¸ï¼š${JSON.stringify(result, null, 2)}`); }
            return result.choices[0].message.content;
        }

        async function callDeepSeekAPI(prompt, apiKey) {
            const apiUrl = 'https://api.deepseek.com/v1/chat/completions';
            const payload = {
                model: 'deepseek-chat',
                messages: [ { role: 'system', content: DR_WANG_PERSONA }, { role: 'user', content: prompt } ],
                response_format: { type: "json_object" },
                temperature: 0.5
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `DeepSeek API éŒ¯èª¤ ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\nè©³ç´°éŒ¯èª¤ï¼š${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\nå›æ‡‰å…§å®¹ï¼š${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            if (!result.choices?.[0]?.message?.content) { throw new Error(`DeepSeek å›æ‡‰æ ¼å¼ç•°å¸¸ï¼š${JSON.stringify(result, null, 2)}`); }
            return result.choices[0].message.content;
        }

        async function testConnectivity(provider, apiKey) {
            try {
                if (!apiKey && provider !== 'gemini') { return false; }
                const testPrompt = 'Hello, this is a connection test, please reply with only {"status": "ok"}';
                const response = await callAI(testPrompt);
                console.log('é€£ç·šæ¸¬è©¦æˆåŠŸ', response);
                return true;
            } catch (error) {
                console.error('é€£ç·šæ¸¬è©¦å¤±æ•—:', error.message);
                return false;
            }
        }

        async function runAnalysis() {
            const selectedModels = Array.from(document.querySelectorAll('.model-checkbox:checked')).map(cb => cb.value);
            if (selectedModels.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†ææ¨¡å‹ã€‚'); 
                return;
            }
  
            let orderedModels = selectedModels.slice();
            const vpcIndex = orderedModels.indexOf('vpc');
            const bmcIndex = orderedModels.indexOf('bmc');
            if (vpcIndex > -1 && bmcIndex > -1 && vpcIndex > bmcIndex) {
                 orderedModels = orderedModels.filter(m => m !== 'vpc');
                 orderedModels.splice(bmcIndex, 0, 'vpc');
            }
           
            diagnosisData.selectedModels = orderedModels;
            diagnosisData.analysisResults = {};

            goToStage(3);
            const dashboard = document.getElementById('analysis-dashboard');
            dashboard.innerHTML = '';

            for (const modelId of orderedModels) {
                const modelName = availableModels.find(m => m.id === modelId)?.name || modelId;
                showLoading(`æ­£åœ¨åŸ·è¡Œ ${modelName}...`);
                try {
                    // [è¨»] æ­¤è™•å‹•æ…‹å‘¼å« prompt å‡½æ•¸ï¼Œæœƒè‡ªå‹•å°æ‡‰åˆ°æ–°åŠ å…¥çš„ getCustomerJourneyPrompt
                    const prompt = window[`get${modelId.charAt(0).toUpperCase() + modelId.slice(1)}Prompt`]();
                    const response = await callAI(prompt);
                    const result = safeJSONParse(response);
                    if (result.error) throw new Error(result.message);
                    
                    // [Phase 2C ä¿®å¾©] è‡ªå‹•è½‰æ› Blue Ocean æ•¸æ“šçµæ§‹
                    if (modelId === 'blueOcean' && result.eliminate && !result.four_actions) {
                        console.log('[Blue Ocean Fix] æª¢æ¸¬åˆ°èˆŠæ ¼å¼ï¼Œè‡ªå‹•è½‰æ›...');
                        result.four_actions = {
                            eliminate: result.eliminate || [],
                            reduce: result.reduce || [],
                            raise: result.raise || [],
                            create: result.create || []
                        };
                        // ä¿ç•™å…¶ä»–æ¬„ä½
                        if (!result.value_curve) result.value_curve = {};
                        if (!result.strategic_insights) result.strategic_insights = '';
                        console.log('[Blue Ocean Fix] è½‰æ›å®Œæˆ:', result);
                    }
                    
                    diagnosisData.analysisResults[modelId] = result;
                    if (modelId !== 'blueOcean') {
                        renderAnalysisCard(modelId, result);
                    }
                } catch (error) {
                    console.error(`${modelId} åˆ†æå¤±æ•—:`, error);
                    renderErrorCard(modelId, error.message);
                }
            }
            hideLoading();
            
            const actionButton = document.getElementById('stage2-action-btn');
            actionButton.textContent = 'â¡ï¸ æŸ¥çœ‹åˆ†æçµæœ';
            actionButton.onclick = () => goToStage(3);
        }

        async function showInnovationTab(method) {
            document.querySelectorAll('.innovation-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === method));
            document.querySelectorAll('.innovation-content').forEach(content => content.classList.toggle('active', content.id === `innovation-content-${method}`));
            if (!diagnosisData[method]) {
                const generator = window[`generate${method.charAt(0).toUpperCase() + method.slice(1)}Analysis`];
                if (generator) await generator();
            }
        }

        async function generateAnalysisForMethod(method, promptFunction, renderFunction) {
            const methodKey = method.toLowerCase().replace(/ /g, '_');
            showLoading(`AI æ­£åœ¨é‹ç”¨ ${method.toUpperCase()} é€²è¡Œå‰µæ–°è¨­è¨ˆ...`);
            try {
                const prompt = promptFunction();
                const response = await callAI(prompt);
                const result = safeJSONParse(response);
                if (result.error) throw new Error(result.message);

                // Ten Types çµæ§‹ä¿®æ­£ï¼šå°‡ ideas ç‰©ä»¶è½‰æˆå¯é¡¯ç¤ºçš„å­—ä¸²é™£åˆ—
                if (methodKey === 'ten_types' && result && Array.isArray(result.categories)) {
                    result.categories = result.categories.map(c => ({
                        ...c,
                        types: (c.types || []).map(t => ({
                            ...t,
                            ideas: (t.ideas || []).map(i => {
                                if (typeof i === 'string') return i;
                                if (!i || typeof i !== 'object') return String(i);
                                return i.idea || i.description || Object.values(i).join('ï¼š ');
                            })
                        }))
                    }));
                }

                diagnosisData[methodKey] = result; 
                renderFunction(result);
            } catch (error) {
                console.error(`${method} åˆ†æå¤±æ•—:`, error);
                const container = document.getElementById(`${methodKey}-result`);
                if(container) {
                    container.innerHTML = `<div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-500"><h4 class="font-bold text-red-800">${method} å‰µæ–°æ–¹æ¡ˆç”Ÿæˆå¤±æ•—</h4><p class="text-sm text-red-700 mt-1">åŸå› ï¼š${error.message}</p></div>`;
                }
            } finally {
                hideLoading();
            }
        }
        
        async function generateScamperAnalysis() { await generateAnalysisForMethod('SCAMPER', getScamperPrompt, renderScamper); }
        async function generateBlue_oceanAnalysis() { await generateAnalysisForMethod('Blue Ocean', getBlueOceanPrompt, renderBlueOcean); }
        async function generateDesign_thinkingAnalysis() { await generateAnalysisForMethod('Design Thinking', getDesignThinkingPrompt, renderDesignThinking); }
        async function generateLean_startupAnalysis() { await generateAnalysisForMethod('Lean Startup', getLeanStartupPrompt, renderLeanStartup); }
        async function generateTen_typesAnalysis() { await generateAnalysisForMethod('Ten Types', getTenTypesPrompt, renderTenTypes); }
        
        
        // ä¸€éµè‡ªå‹•åŸ·è¡Œ 4/5 æ‰€æœ‰å‰µæ–°åˆ†æï¼ˆä¾åºï¼‰ï¼šSCAMPER â†’ è—æµ·ç­–ç•¥ â†’ è¨­è¨ˆæ€ç¶­ â†’ ç²¾å¯¦å‰µæ¥­ â†’ åå¤§å‰µæ–°
        async function autoRunAll() {
            try {
                const btn = document.getElementById('autoRunAllBtn');
                const status = document.getElementById('autoRunStatus');
                const autoSwitch = document.getElementById('autoSwitchToNextTab');
                if (btn) { btn.disabled = true; btn.innerText = 'â³ è‡ªå‹•åŸ·è¡Œä¸­â€¦'; }
                if (status) { status.textContent = 'æº–å‚™é–‹å§‹â€¦'; }

                const allSteps = [
                    { key: 'scamper', name: 'SCAMPER', runner: generateScamperAnalysis },
                    { key: 'blue_ocean', name: 'è—æµ·ç­–ç•¥', runner: generateBlue_oceanAnalysis },
                    { key: 'design_thinking', name: 'è¨­è¨ˆæ€ç¶­', runner: generateDesign_thinkingAnalysis },
                    { key: 'lean_startup', name: 'ç²¾å¯¦å‰µæ¥­', runner: generateLean_startupAnalysis },
                    { key: 'ten_types', name: 'åå¤§å‰µæ–°', runner: generateTen_typesAnalysis },
                ];
                // è‡ªå‹•è·³éå·²å®Œæˆçš„æ–¹æ³•
                const steps = allSteps.filter(s => !diagnosisData || !diagnosisData[s.key]);

                for (let i = 0; i < steps.length; i++) {
                    const s = steps[i];
                    if (status) status.textContent = `(${i+1}/${steps.length}) åŸ·è¡Œ ${s.name}â€¦`;
                    try {
                        if (autoSwitch && autoSwitch.checked && typeof showInnovationTab === 'function') {
                            showInnovationTab(s.key);
                        }
                        await s.runner();
                        if (status) status.textContent = `(${i+1}/${steps.length}) å®Œæˆ ${s.name}`;
                    } catch (err) {
                        console.error('Auto-run step failed:', s.name, err);
                        if (status) status.textContent = `âš ï¸ ${s.name} ç™¼ç”ŸéŒ¯èª¤ï¼ˆå·²ç•¥éï¼‰`;
                    }
                }

                if (status) status.textContent = 'ğŸ‰ æ‰€æœ‰å‰µæ–°åˆ†æå·²å®Œæˆï¼å¯å‰å¾€ 5/5 ç”¢ç”Ÿæœ€çµ‚å ±å‘Š';
            } finally {
                const btn = document.getElementById('autoRunAllBtn');
                if (btn) { btn.disabled = false; btn.innerText = 'ğŸš€ è‡ªå‹•åŸ·è¡Œå…¨éƒ¨å‰µæ–°åˆ†æ'; }
            }
        }

async function generateFinalRecommendationsAnalysis() {
            showLoading('AI æ­£åœ¨æ•´åˆæœ€çµ‚æˆ°ç•¥å»ºè­°...');
            try {
                const finalPrompt = getFinalRecommendationsPrompt();
                const finalResponse = await callAI(finalPrompt);
                const finalResult = safeJSONParse(finalResponse);
                if (finalResult.error) throw new Error(finalResult.message);
                diagnosisData.finalRecommendations = finalResult;
                renderFinalRecommendations(finalResult);
            } catch (error) {
                console.error('æœ€çµ‚å»ºè­°ç”Ÿæˆå¤±æ•—:', error);
                renderFinalRecommendationsError(error.message);
            } finally {
                hideLoading();
            }
        }
        
        function getBasePromptContext() {
            // [è¨»] æ­¤å‡½æ•¸æœƒè‡ªå‹•å°‡ diagnosisData.analysisResults å®Œæ•´æ‰“åŒ…ï¼Œ
            // å› æ­¤æ–°åŠ å…¥çš„ customerJourney çµæœæœƒè‡ªå‹•è¢«å¾ŒçºŒéšæ®µ(å‰µæ–°ã€ç¸½çµ)ç´å…¥è€ƒé‡
            return `
                **ä¼æ¥­èƒŒæ™¯:**
                - ç”¢æ¥­: ${diagnosisData.context.industry}
                - è¦æ¨¡: ${diagnosisData.context.companySize}
                - å•†æ¥­æ¨¡å¼: ${diagnosisData.context.businessModel}
                - æ ¸å¿ƒæŒ‘æˆ°: ${diagnosisData.context.problem}
                **å·²å®Œæˆçš„ç­–ç•¥åˆ†ææ‘˜è¦ (JSONæ ¼å¼):**
                ${JSON.stringify(diagnosisData.analysisResults || {}, null, 2)}
                è«‹ä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸¦åš´æ ¼éµå®ˆæŒ‡å®šçš„JSONè¼¸å‡ºæ ¼å¼ã€‚
            `;
        }

        function getSwotPrompt() {
            return `${getBasePromptContext()}
            è«‹å°æ­¤ä¼æ¥­é€²è¡Œã€Œä¸‰å±¤æ·±å…¥ SWOT åˆ†æã€ï¼š
            
            ã€ç¬¬ä¸€å±¤ï¼šè¨ºæ–·å±¤ã€‘ç‚ºæ¯å€‹ SWOT è±¡é™æä¾› 4-5 å€‹é—œéµæ´å¯Ÿé»ï¼Œæ¯å€‹æ´å¯Ÿé»éœ€åŒ…å«ã€Œç¾è±¡æè¿°ã€èˆ‡ã€Œæ ¹æœ¬åŸå› ã€ã€‚
            ã€ç¬¬äºŒå±¤ï¼šæˆ°ç•¥çŸ©é™£ã€‘åŸºæ–¼è¨ºæ–·å±¤ï¼Œç”Ÿæˆã€ŒSWOT æˆ°ç•¥çŸ©é™£ã€ï¼š
            - SO ç­–ç•¥ï¼ˆå„ªå‹¢-æ©Ÿæœƒï¼‰ï¼šå¦‚ä½•ç”¨å„ªå‹¢æŠ“ä½æ©Ÿæœƒï¼Ÿæä¾› 2-3 å€‹ç­–ç•¥
            - WO ç­–ç•¥ï¼ˆåŠ£å‹¢-æ©Ÿæœƒï¼‰ï¼šå¦‚ä½•å…‹æœåŠ£å‹¢ä»¥åˆ©ç”¨æ©Ÿæœƒï¼Ÿæä¾› 2-3 å€‹ç­–ç•¥
            - ST ç­–ç•¥ï¼ˆå„ªå‹¢-å¨è„…ï¼‰ï¼šå¦‚ä½•ç”¨å„ªå‹¢è¦é¿å¨è„…ï¼Ÿæä¾› 2-3 å€‹ç­–ç•¥
            - WT ç­–ç•¥ï¼ˆåŠ£å‹¢-å¨è„…ï¼‰ï¼šå¦‚ä½•åŒæ™‚é™ä½åŠ£å‹¢èˆ‡å¨è„…ï¼Ÿæä¾› 2-3 å€‹ç­–ç•¥
            
            ã€ç¬¬ä¸‰å±¤ï¼šå„ªå…ˆèšç„¦é»ã€‘å¾æˆ°ç•¥çŸ©é™£ä¸­ï¼Œé¸å‡ºã€Œå‰ 3 å€‹æœ€æ‡‰å„ªå…ˆåŸ·è¡Œçš„ç­–ç•¥ã€ï¼Œä¸¦èªªæ˜ï¼š
            - ç‚ºä½•å„ªå…ˆï¼ˆå½±éŸ¿åŠ›ã€å¯è¡Œæ€§ã€æ€¥è¿«æ€§ï¼‰
            - é æœŸæ•ˆç›Š
            - æ‰€éœ€è³‡æºè©•ä¼°ï¼ˆä½/ä¸­/é«˜ï¼‰
            
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            {
              "diagnosis": {
                "strengths": [{"point": "å„ªå‹¢é»æè¿°", "root_cause": "ç‚ºä½•å…·å‚™æ­¤å„ªå‹¢çš„æ ¹æœ¬åŸå› "}],
                "weaknesses": [{"point": "åŠ£å‹¢é»æè¿°", "root_cause": "é€ æˆæ­¤åŠ£å‹¢çš„æ ¹æœ¬åŸå› "}],
                "opportunities": [{"point": "æ©Ÿæœƒé»æè¿°", "root_cause": "æ­¤æ©Ÿæœƒç”¢ç”Ÿçš„èƒŒæ™¯åŸå› "}],
                "threats": [{"point": "å¨è„…é»æè¿°", "root_cause": "æ­¤å¨è„…å½¢æˆçš„æ ¹æœ¬åŸå› "}]
              },
              "strategy_matrix": {
                "SO": [{"strategy": "ç­–ç•¥æè¿°", "rationale": "åŸ·è¡Œé‚è¼¯èˆ‡é æœŸæ•ˆç›Š"}],
                "WO": [{"strategy": "ç­–ç•¥æè¿°", "rationale": "åŸ·è¡Œé‚è¼¯èˆ‡é æœŸæ•ˆç›Š"}],
                "ST": [{"strategy": "ç­–ç•¥æè¿°", "rationale": "åŸ·è¡Œé‚è¼¯èˆ‡é æœŸæ•ˆç›Š"}],
                "WT": [{"strategy": "ç­–ç•¥æè¿°", "rationale": "åŸ·è¡Œé‚è¼¯èˆ‡é æœŸæ•ˆç›Š"}]
              },
              "top_3_priorities": [
                {
                  "rank": 1,
                  "strategy": "ç­–ç•¥åç¨±",
                  "type": "SO/WO/ST/WT",
                  "why_priority": "å„ªå…ˆåŸå› ï¼ˆå½±éŸ¿åŠ›ã€å¯è¡Œæ€§ã€æ€¥è¿«æ€§åˆ†æï¼‰",
                  "expected_benefit": "é æœŸæ•ˆç›Šæè¿°",
                  "resource_requirement": "ä½/ä¸­/é«˜"
                }
              ]
            }`;
        }

        function getPortersPrompt() {
            return `${getBasePromptContext()}
            è«‹é‹ç”¨æ³¢ç‰¹äº”åŠ›æ¨¡å‹åˆ†æã€‚ç‚ºæ¯ä¸€ç¨®åŠ›é‡é€²è¡Œè©•åˆ†ï¼ˆé«˜ã€ä¸­ã€ä½ï¼‰ä¸¦æä¾›ç†ç”±ï¼Œæœ€å¾Œçµ¦å‡ºç¸½çµã€‚
            
            **Phase 2A å¢å¼·è¦æ±‚**ï¼š
            é™¤äº†åŸæœ‰çš„æ³¢ç‰¹äº”åŠ›åˆ†æå¤–ï¼Œè«‹é¡å¤–æä¾›ã€Œç«¶çˆ­ç­–ç•¥å»ºè­°ã€(competitive_strategy)ï¼š
            
            1. **æ³¢ç‰¹ä¸‰å¤§åŸºæœ¬ç­–ç•¥è©•ä¼°** (porter_generic_strategies)ï¼š
               - æˆæœ¬é ˜å°ç­–ç•¥ï¼šé©åˆåº¦åˆ†æ•¸ 1-10ã€å¯è¡Œæ€§ï¼ˆé«˜/ä¸­/ä½ï¼‰ã€ç†ç”±
               - å·®ç•°åŒ–ç­–ç•¥ï¼šé©åˆåº¦åˆ†æ•¸ 1-10ã€å¯è¡Œæ€§ï¼ˆé«˜/ä¸­/ä½ï¼‰ã€ç†ç”±
               - èšç„¦ç­–ç•¥ï¼ˆåˆ©åŸºå¸‚å ´ï¼‰ï¼šé©åˆåº¦åˆ†æ•¸ 1-10ã€å¯è¡Œæ€§ï¼ˆé«˜/ä¸­/ä½ï¼‰ã€ç†ç”±
            
            2. **æ¨è–¦ç­–ç•¥** (recommended_strategy)ï¼šåŸºæ–¼ä¸Šè¿°è©•ä¼°ï¼Œæ¨è–¦æœ€é©åˆçš„ç­–ç•¥ï¼ˆå¯ç‚ºè¤‡åˆç­–ç•¥ï¼‰
            
            3. **å‰ 3 å¤§é—œéµè¡Œå‹•** (top_3_actions)ï¼š
               æ¯å€‹è¡Œå‹•åŒ…å«ï¼š
               - action: å…·é«”è¡Œå‹•æè¿°
               - strategic_basis: ç­–ç•¥ä¾æ“š
               - expected_outcome: é æœŸæˆæœ
            
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            {
              "forces": [
                {"name": "æ–°é€²å…¥è€…çš„å¨è„…", "level": "é«˜/ä¸­/ä½", "reason": "..."}
              ],
              "summary": "ç”¢æ¥­ç«¶çˆ­ç¸½çµ...",
              "competitive_strategy": {
                "recommended_strategy": "å·®ç•°åŒ–ç­–ç•¥",
                "porter_generic_strategies": [
                  {
                    "strategy": "æˆæœ¬é ˜å°ç­–ç•¥",
                    "score": 6,
                    "feasibility": "ä¸­",
                    "reason": "èªªæ˜ç‚ºä½•æ­¤ç­–ç•¥é©åˆåº¦ç‚º 6 åˆ†ï¼Œå¯è¡Œæ€§ç‚ºä¸­ç­‰"
                  },
                  {
                    "strategy": "å·®ç•°åŒ–ç­–ç•¥",
                    "score": 8,
                    "feasibility": "é«˜",
                    "reason": "èªªæ˜ç‚ºä½•æ­¤ç­–ç•¥é©åˆåº¦ç‚º 8 åˆ†ï¼Œå¯è¡Œæ€§é«˜"
                  },
                  {
                    "strategy": "èšç„¦ç­–ç•¥ï¼ˆåˆ©åŸºå¸‚å ´ï¼‰",
                    "score": 7,
                    "feasibility": "ä¸­",
                    "reason": "èªªæ˜ç‚ºä½•æ­¤ç­–ç•¥é©åˆåº¦ç‚º 7 åˆ†ï¼Œå¯è¡Œæ€§ç‚ºä¸­ç­‰"
                  }
                ],
                "top_3_actions": [
                  {
                    "action": "å»ºç«‹å“ç‰Œå·®ç•°åŒ–å®šä½",
                    "strategic_basis": "åŸºæ–¼å·®ç•°åŒ–ç­–ç•¥ï¼Œé€éå“ç‰Œå½¢è±¡å€éš”ç«¶çˆ­å°æ‰‹",
                    "expected_outcome": "æå‡å“ç‰Œæº¢åƒ¹ 15-20%ï¼Œé™ä½åƒ¹æ ¼æ•æ„Ÿåº¦"
                  },
                  {
                    "action": "æ·±åŒ–å®¢æˆ¶é—œä¿‚ç®¡ç†ç³»çµ±",
                    "strategic_basis": "å¼·åŒ–å®¢æˆ¶é»è‘—åº¦ï¼Œå»ºç«‹è½‰æ›éšœç¤™",
                    "expected_outcome": "å®¢æˆ¶ç•™å­˜ç‡æå‡ 25%ï¼Œå£ç¢‘æ¨è–¦å¢åŠ "
                  },
                  {
                    "action": "æŠ•è³‡ç ”ç™¼å‰µæ–°ç”¢å“ç·š",
                    "strategic_basis": "æŒçºŒå‰µæ–°ä»¥ç¶­æŒå·®ç•°åŒ–å„ªå‹¢",
                    "expected_outcome": "æ–°ç”¢å“è²¢ç»ç‡Ÿæ”¶ 30% ä»¥ä¸Š"
                  }
                ]
              }
            }`;
        }
        
        function getPestelPrompt() {
             return `${getBasePromptContext()}
            è«‹é‹ç”¨PESTELæ¨¡å‹åˆ†æã€‚ç‚ºæ¯å€‹å› ç´ æ‰¾å‡º 2-3 å€‹æœ€ç›¸é—œçš„è¶¨å‹¢æˆ–å½±éŸ¿ã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "political": [], "economic": [], "social": [], "technological": [], "environmental": [], "legal": [] }`;
        }

        function getVpcPrompt() {
            return `${getBasePromptContext()}
            è«‹é€²è¡Œåƒ¹å€¼ä¸»å¼µåˆ†æ(VPC)ã€‚ç‚ºã€Œé¡§å®¢è¼ªå»“ã€èˆ‡ã€Œåƒ¹å€¼åœ°åœ–ã€å„å€å¡Šæä¾› 2-3 å€‹æ´å¯Ÿã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "customer_profile": { "jobs": [], "pains": [], "gains": [] }, "value_map": { "products_services": [], "pain_relievers": [], "gain_creators": [] } }`;
        }

        function getBmcPrompt() {
            return `${getBasePromptContext()}
            è«‹å»ºæ§‹å•†æ¥­æ¨¡å¼ BMCã€‚ç‚ºä¹å€‹æ¨¡å¡Šå„æä¾›2-3å€‹æ ¸å¿ƒè¦é»ã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "customer_segments": [], "value_propositions": [], "channels": [], "customer_relationships": [], "revenue_streams": [], "key_activities": [], "key_resources": [], "key_partnerships": [], "cost_structure": [] }`;
        }

        // --- [æ–°åŠ å…¥] å®¢æˆ¶æ—…ç¨‹ Prompt ---
        function getCustomerJourneyPrompt() {
            return `${getBasePromptContext()}
            è«‹åˆ†ææ­¤ä¼æ¥­çš„ã€Œå®¢æˆ¶æ—…ç¨‹ã€ã€‚è«‹æ ¹æ“šå…¶å•†æ¥­æ¨¡å¼(ä¾‹å¦‚ B2B, B2C)å’ŒæŒ‘æˆ°ï¼Œè‡ªå‹•é¸æ“‡æœ€é©åˆçš„æ¨¡å‹ (å‚³çµ± AIDA æˆ– æ•¸ä½ AISAS)ã€‚
            ç‚ºé¸å®šçš„æ¨¡å‹ï¼Œåˆ†æå…¶æ¯å€‹éšæ®µçš„é—œéµæ´»å‹•èˆ‡æ¥è§¸é»ï¼Œä¸¦æä¾›ä¸€å€‹ç¸½çµæ´å¯Ÿã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            {
              "model_chosen": "AIDA / AISAS",
              "reason_for_choice": "èªªæ˜ç‚ºä½•é¸æ“‡æ­¤æ¨¡å‹...",
              "stages": [
                { "stage_name": "éšæ®µåç¨± (ä¾‹å¦‚: Attention)", "description": "æ­¤éšæ®µçš„é¡§å®¢è¡Œç‚ºæè¿°...", "key_touchpoints": ["æ¥è§¸é»1", "æ¥è§¸é»2"] }
              ],
              "summary_insight": "é—œæ–¼å®¢æˆ¶æ—…ç¨‹çš„é—œéµç¸½çµæ´å¯Ÿ..."
            }

**é‡è¦ï¼šæ¯å€‹éšæ®µå¿…é ˆåŒ…å«ç—›é»æ•¸æ“š**

åœ¨æ¯å€‹ stage ç‰©ä»¶ä¸­ï¼Œè«‹å‹™å¿…æä¾›ï¼š

1. **pain_points** (é™£åˆ—ï¼Œå¿…éœ€)ï¼š
   [
     {
       "description": "ç—›é»æè¿°ï¼ˆå…·é«”ã€æ¸…æ™°ï¼‰",
       "intensity": 7,  // 1-10 çš„æ•¸å­—
       "category": "åŠŸèƒ½æ€§",  // å¿…é ˆæ˜¯ï¼š"åŠŸèƒ½æ€§" / "æƒ…æ„Ÿæ€§" / "ç¤¾äº¤æ€§"
       "solution_hint": "å…·é«”çš„è§£æ±ºæ–¹æ¡ˆå»ºè­°"
     }
   ]

2. **overall_pain_score** (æ•¸å­—ï¼Œå¿…éœ€)ï¼šè©²éšæ®µçš„æ•´é«”ç—›é»è©•åˆ† (1-10)

**ç¯„ä¾‹**ï¼š
{
  "stages": [
    {
      "stage_name": "èªçŸ¥éšæ®µ",
      "description": "...",
      "key_touchpoints": ["...", "..."],
      "pain_points": [
        {
          "description": "è³‡è¨Šéè¼‰ï¼Œé›£ä»¥å¿«é€Ÿæ‰¾åˆ°é—œéµç”¢å“ç‰¹é»",
          "intensity": 7,
          "category": "åŠŸèƒ½æ€§",
          "solution_hint": "æä¾›ä¸€é å¼ç”¢å“é‡é»æ‘˜è¦ï¼Œä½¿ç”¨åœ–åƒåŒ–å‘ˆç¾"
        }
      ],
      "overall_pain_score": 6.5
    }
  ]
}

**å¦‚æœæ²’æœ‰æä¾› pain_points å’Œ overall_pain_scoreï¼Œå ±å‘Šå°‡ç¼ºå°‘ç—›é»åˆ†æåŠŸèƒ½ï¼**

ã€å®Œæ•´ç¯„ä¾‹ã€‘å¿…é ˆå®Œå…¨æŒ‰ç…§æ­¤æ ¼å¼ï¼š
{
  "model_chosen": "AIDA",
  "reason_for_choice": "B2C é›¶å”®æ¥­é©åˆ AIDA",
  "stages": [
    {
      "stage_name": "Attention",
      "description": "é¡§å®¢é¦–æ¬¡æ¥è§¸å“ç‰Œ",
      "key_touchpoints": ["ç¤¾ç¾¤åª’é«”", "æœå°‹å¼•æ“"],
      "pain_points": [
        {"description": "è³‡è¨Šéè¼‰", "intensity": 7, "category": "åŠŸèƒ½æ€§", "solution_hint": "ç°¡åŒ–å‘ˆç¾"}
      ],
      "overall_pain_score": 7
    }
  ],
  "summary_insight": "é‡é»..."
}
`;
        }

        function getScamperPrompt() {
            // è‡ªå‹•æå–å‰éšæ®µçš„ç—›é»è³‡æ–™
            const swotWeaknesses = diagnosisData.analysisResults?.swot?.diagnosis?.weaknesses || 
                                   diagnosisData.analysisResults?.swot?.weaknesses || [];
            const vpcPains = diagnosisData.analysisResults?.vpc?.customer_profile?.pains || [];
            
            const painContext = `
ã€å‰éšæ®µè­˜åˆ¥çš„æˆ°ç•¥ç´šç—›é»ã€‘
SWOT é—œéµåŠ£å‹¢: ${JSON.stringify(swotWeaknesses.slice(0, 3), null, 2)}
VPC é¡§å®¢ç—›é»: ${JSON.stringify(vpcPains.slice(0, 3), null, 2)}
            `;
            
            return `${getBasePromptContext()}
            
            ${painContext}
            
            [ä»»å‹™] é‹ç”¨ SCAMPER ä¸ƒæŠ€æ³•ï¼Œé‡å°ã€Œä¸Šè¿°æˆ°ç•¥ç´šç—›é»ã€è¨­è¨ˆå‰µæ–°è§£æ±ºæ–¹æ¡ˆã€‚
            
            ã€æ–¹æ¡ˆè¨­è¨ˆåŸå‰‡ã€‘
            1. æ¯å€‹æ–¹æ¡ˆå¿…é ˆæ˜ç¢ºæŒ‡å‡ºã€Œè§£æ±ºå“ªå€‹ç—›é»ã€ï¼ˆå¼•ç”¨ä¸Šè¿° SWOT åŠ£å‹¢æˆ– VPC ç—›é»ï¼‰
            2. æä¾›ã€Œé æœŸæ•ˆç›Šã€èˆ‡ã€Œè³‡æºéœ€æ±‚è©•ä¼°ã€ï¼ˆä½/ä¸­/é«˜ï¼‰
            3. è©•ä¼°ã€Œå½±éŸ¿åŠ›ã€èˆ‡ã€Œå¯è¡Œæ€§ã€ï¼ˆå„ 1-10 åˆ†ï¼‰
            
            ã€å„ªå…ˆæ’åºã€‘æ ¹æ“šã€Œå½±éŸ¿åŠ› Ã— å¯è¡Œæ€§ / 10ã€è¨ˆç®—å„ªå…ˆç´šåˆ†æ•¸ï¼ˆ1-10åˆ†ï¼‰ï¼Œé¸å‡ºå‰ 5 å€‹æ–¹æ¡ˆã€‚
            
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            {
              "pain_points_summary": [
                {"source": "SWOTåŠ£å‹¢/VPCç—›é»", "pain": "ç—›é»æè¿°"}
              ],
              "scamper_solutions": [
                {
                  "technique": "S/C/A/M/P/E/R",
                  "target_pain": "å°æ‡‰çš„ç—›é»æè¿°ï¼ˆå¿…é ˆä¾†è‡ªä¸Šè¿°pain_points_summaryï¼‰",
                  "solution": {
                    "title": "æ–¹æ¡ˆæ¨™é¡Œ",
                    "description": "è©³ç´°æè¿°å¦‚ä½•è§£æ±ºè©²ç—›é»",
                    "expected_benefits": ["æ•ˆç›Š1", "æ•ˆç›Š2"],
                    "resource_requirement": "ä½/ä¸­/é«˜"
                  },
                  "scores": {
                    "impact": 8,
                    "feasibility": 7,
                    "priority_score": 5.6
                  }
                }
              ],
              "top_5_priorities": [
                {
                  "rank": 1,
                  "technique": "æŠ€æ³•åç¨±",
                  "title": "æ–¹æ¡ˆæ¨™é¡Œ",
                  "target_pain": "è§£æ±ºçš„ç—›é»",
                  "priority_score": 8.1,
                  "why_top": "ç‚ºä½•æ’åå‰5çš„åŸå› "
                }
              ]
            }`;
        }

        function getBlueOceanPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œè—æµ·ç­–ç•¥ã€çš„ã€Œå››é …è¡Œå‹•æ¶æ§‹ã€(ERRC)åˆ†æç”¢æ¥­ç«¶çˆ­è¦ç´ 
            - æ¶ˆé™¤ï¼ˆEliminateï¼‰ï¼šç”¢æ¥­ä¸­å¯ä»¥å®Œå…¨ç§»é™¤çš„å…ƒç´ 
            - æ¸›å°‘ï¼ˆReduceï¼‰ï¼šé™ä½åˆ°ç”¢æ¥­æ¨™æº–ä»¥ä¸‹çš„å…ƒç´   
            - æå‡ï¼ˆRaiseï¼‰ï¼šé é«˜æ–¼ç”¢æ¥­æ¨™æº–çš„å…ƒç´ 
            - å‰µé€ ï¼ˆCreateï¼‰ï¼šç”¢æ¥­å¾æœªæä¾›éçš„æ–°å…ƒç´ 
            
            æ¯å€‹è¡Œå‹•è‡³å°‘æå‡º 2-3 å€‹å…·é«”é …ç›®ã€‚

ã€æ­£ç¢ºæ ¼å¼ç¯„ä¾‹ã€‘AI å¿…é ˆå®Œå…¨æŒ‰ç…§æ­¤æ ¼å¼è¿”å›ï¼š

{
  "four_actions": {
    "eliminate": [
      {"item": "å‚³çµ±ç´™æœ¬èªªæ˜æ›¸", "reason": "æ•¸ä½åŒ–æ™‚ä»£ï¼Œå®¢æˆ¶æ›´å‚¾å‘ç·šä¸ŠæŸ¥è©¢ï¼Œæˆæœ¬é«˜ä¸”ä¸ç’°ä¿"},
      {"item": "å¯¦é«”å±•ç¤ºä¸­å¿ƒ", "reason": "é«˜æ˜‚ç§Ÿé‡‘æˆæœ¬ï¼Œå¯ç”¨ VR/AR è™›æ“¬å±•å»³å–ä»£"}
    ],
    "reduce": [
      {"item": "éŠ·å”®äººå“¡æ•¸é‡", "reason": "å°å…¥ AI å®¢æœèˆ‡è‡ªåŠ©ç³»çµ±ï¼Œé™ä½äººåŠ›æˆæœ¬"},
      {"item": "ç”¢å“åŒ…è£è±ªè¯åº¦", "reason": "ç°¡åŒ–åŒ…è£ï¼Œé™ä½æˆæœ¬èˆ‡ç’°å¢ƒè² æ“”"}
    ],
    "raise": [
      {"item": "ç”¢å“å®¢è£½åŒ–ç¨‹åº¦", "reason": "åˆ©ç”¨ AI èˆ‡æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œæä¾›å¤§è¦æ¨¡å®¢è£½åŒ–"},
      {"item": "æ•¸æ“šå®‰å…¨ä¿éšœ", "reason": "å¼·åŒ–è³‡å®‰æŠ•è³‡ï¼Œå»ºç«‹ä¿¡ä»»èˆ‡å·®ç•°åŒ–"}
    ],
    "create": [
      {"item": "è¨‚é–±åˆ¶æœå‹™æ¨¡å¼", "reason": "å¾ä¸€æ¬¡æ€§éŠ·å”®è½‰ç‚ºé•·æœŸå®¢æˆ¶é—œä¿‚ï¼Œå‰µé€ ç©©å®šç¾é‡‘æµ"},
      {"item": "ç”¢æ¥­ç”Ÿæ…‹ç³»å¹³å°", "reason": "ä¸²é€£ä¸Šä¸‹æ¸¸å¤¥ä¼´ï¼Œå‰µé€ ç¶²è·¯æ•ˆæ‡‰"}
    ]
  },
  "value_curve": {
    "factors": ["åƒ¹æ ¼", "å“è³ª", "å‰µæ–°", "å®¢æˆ¶é«”é©—", "æ°¸çºŒæ€§"],
    "own_company": {
      "name": "æˆ‘å€‘å…¬å¸ï¼ˆè—æµ·ç­–ç•¥å¾Œï¼‰",
      "scores": [6, 9, 10, 9, 10]
    },
    "competitors": [
      {
        "name": "å‚³çµ±ç«¶çˆ­å°æ‰‹ A",
        "scores": [8, 7, 5, 6, 4]
      }
    ]
  },
  "strategic_insights": "é€éæ¸›é™¤å‚³çµ±æˆæœ¬çµæ§‹ï¼Œä¸¦å‰µé€ è¨‚é–±åˆ¶èˆ‡ç”Ÿæ…‹ç³»å¹³å°ï¼Œå…¬å¸å¯åœ¨ã€Œå‰µæ–°ã€èˆ‡ã€Œæ°¸çºŒæ€§ã€ç¶­åº¦å»ºç«‹é¡¯è‘—å·®ç•°åŒ–ã€‚"
}

**é‡è¦èªªæ˜ï¼šå¿…é ˆè¿”å›ä»¥ä¸‹ JSON æ ¼å¼**

{
  "four_actions": {
    "eliminate": [
      {"item": "å…·é«”é …ç›®åç¨±", "reason": "ç‚ºä»€éº¼è¦æ¸›é™¤"}
    ],
    "reduce": [
      {"item": "å…·é«”é …ç›®åç¨±", "reason": "ç‚ºä»€éº¼è¦é™ä½"}
    ],
    "raise": [
      {"item": "å…·é«”é …ç›®åç¨±", "reason": "ç‚ºä»€éº¼è¦æå‡"}
    ],
    "create": [
      {"item": "å…·é«”é …ç›®åç¨±", "reason": "ç‚ºä»€éº¼è¦å‰µé€ "}
    ]
  },
  "value_curve": {
    "factors": ["åƒ¹æ ¼", "å“è³ª", "å‰µæ–°", "æœå‹™", "ä¾¿åˆ©æ€§"],
    "own_company": {
      "name": "æˆ‘å€‘å…¬å¸",
      "scores": [7, 8, 9, 7, 8]
    },
    "competitors": [
      {
        "name": "ç«¶çˆ­å°æ‰‹ A",
        "scores": [8, 6, 5, 7, 6]
      }
    ]
  },
  "strategic_insights": "åŸºæ–¼å››é …è¡Œå‹•å’Œåƒ¹å€¼æ›²ç·šçš„ç¶œåˆæˆ°ç•¥å»ºè­°..."
}

**æ¬„ä½è¦æ±‚**ï¼š
- four_actions: å¿…é ˆåŒ…å« eliminate/reduce/raise/create å››å€‹éµï¼Œæ¯å€‹è‡³å°‘ 2 é …
- value_curve.factors: è‡³å°‘ 5 å€‹ç«¶çˆ­ç¶­åº¦
- scores: å¿…é ˆæ˜¯ 1-10 çš„æ•¸å­—é™£åˆ—ï¼Œé•·åº¦èˆ‡ factors ä¸€è‡´
- strategic_insights: ç¶œåˆæˆ°ç•¥å»ºè­°æ–‡å­—

è‹¥ç¼ºå°‘ä»»ä½•æ¬„ä½ï¼Œè—æµ·ç­–ç•¥åˆ†æå°‡ç„¡æ³•é¡¯ç¤ºã€‚
`;
        }

        function getDesignThinkingPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œè¨­è¨ˆæ€ç¶­ã€äº”éšæ®µï¼Œè¦åŠƒä»¥ä½¿ç”¨è€…ç‚ºä¸­å¿ƒçš„è§£æ±ºæ–¹æ¡ˆæµç¨‹ã€‚ç‚ºæ¯éšæ®µæä¾› 2-3 å€‹é—œéµè¡Œå‹•æˆ–å•é¡Œã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "stages": [ { "stage": "1. åŒç†å¿ƒ", "description": "", "actions": [] } ] }`;
        }
        
        function getLeanStartupPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œç²¾å¯¦å‰µæ¥­ã€å¾ªç’°ï¼Œæå‡ºå¿«é€Ÿé©—è­‰å•†æ¥­æ§‹æƒ³çš„è¡Œå‹•è¨ˆç•«ã€‚å®šç¾©å‡è¨­ã€MVPèˆ‡è¡¡é‡æŒ‡æ¨™ã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "title": "", "build": { "phase_name": "å»ºç«‹", "key_hypothesis": "", "mvp_suggestion": { "name": "", "description": "", "features": [] } }, "measure": { "phase_name": "è¡¡é‡", "key_metrics": [ {"metric": "", "definition": ""} ], "measurement_method": "" }, "learn": { "phase_name": "å­¸ç¿’", "pivot_or_persevere": "", "learning_questions": [] } }`;
        }

        function getTenTypesPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œåå¤§å‰µæ–°é¡å‹ã€æ¡†æ¶ï¼Œå¾ã€Œçµæ§‹ã€ã€ã€Œç”¢å“ã€å’Œã€Œé«”é©—ã€ä¸‰ç¶­åº¦ï¼Œç‚ºå„é¡å‹æä¾› 1-2 å€‹å‰µæ–°æ§‹æƒ³ã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "categories": [ { "name": "çµæ§‹", "description": "", "types": [ {"type_name": "", "ideas": []} ] } ] }`;
        }

        function getFinalRecommendationsPrompt() {
             const innovationSummary = {};
             
             // æ”¶é›†æ‰€æœ‰å‰µæ–°æ–¹æ¡ˆï¼ˆå«å„ªå…ˆç´šåˆ†æ•¸ï¼‰
             const allInitiatives = [];
             
             if (diagnosisData.scamper?.top_5_priorities) {
                 diagnosisData.scamper.top_5_priorities.forEach(p => {
                     allInitiatives.push({
                         source: 'SCAMPER',
                         title: p.title,
                         impact: p.priority_score >= 7 ? 9 : (p.priority_score >= 5 ? 6 : 3),
                         feasibility: p.priority_score >= 7 ? 8 : (p.priority_score >= 5 ? 6 : 4)
                     });
                 });
                 innovationSummary.scamper = diagnosisData.scamper.top_5_priorities;
             } else if (diagnosisData.scamper?.priority_ranking) {
                 innovationSummary.scamper = diagnosisData.scamper.priority_ranking;
             }
             
             if (diagnosisData.swot?.top_3_priorities) {
                 diagnosisData.swot.top_3_priorities.forEach(p => {
                     const resourceMap = {'ä½': 9, 'ä¸­': 6, 'ä½': 4};
                     allInitiatives.push({
                         source: 'SWOT',
                         title: p.strategy,
                         impact: 8,
                         feasibility: resourceMap[p.resource_requirement] || 6
                     });
                 });
                 innovationSummary.swot_priorities = diagnosisData.swot.top_3_priorities;
             }
             
             if (diagnosisData.blue_ocean) innovationSummary.blue_ocean = diagnosisData.blue_ocean;
             if (diagnosisData.design_thinking) innovationSummary.design_thinking = { stage1: diagnosisData.design_thinking.stages[0].actions, stage2: diagnosisData.design_thinking.stages[1].actions};
             if (diagnosisData.lean_startup) innovationSummary.lean_startup = { hypothesis: diagnosisData.lean_startup.build.key_hypothesis, mvp: diagnosisData.lean_startup.build.mvp_suggestion.name };
             if (diagnosisData.ten_types) innovationSummary.ten_types = { top_idea: diagnosisData.ten_types.categories[0].types[0].ideas[0] };
             
             const allDataSummary = JSON.stringify({ context: diagnosisData.context, analysisResults: diagnosisData.analysisResults, innovationSummary: innovationSummary }, null, 2);
             
             return `${DR_WANG_PERSONA}
            è¨ºæ–·æ•¸æ“šæ‘˜è¦: ${allDataSummary}
            
            æ‰€æœ‰å‰µæ–°æ–¹æ¡ˆæ¸…å–®ï¼ˆå«å½±éŸ¿åŠ›èˆ‡å¯è¡Œæ€§è©•ä¼°ï¼‰: ${JSON.stringify(allInitiatives, null, 2)}
            
            è«‹ç¶œåˆæ‰€æœ‰ä¿¡æ¯ï¼Œæä¾›ã€Œæ•´åˆæˆ°ç•¥å»ºè­° + åŸ·è¡Œå„ªå…ˆç´šçŸ©é™£ã€ï¼š
            
            ã€æ ¸å¿ƒæ´å¯Ÿã€‘æ•´åˆè¨ºæ–·éšæ®µçš„é—œéµç™¼ç¾ï¼Œæç…‰ 3-5 å€‹æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿã€‚
            
            ã€åŸ·è¡Œå„ªå…ˆç´šçŸ©é™£ã€‘å°‡æ‰€æœ‰å‰µæ–°æ–¹æ¡ˆï¼ˆSWOTç­–ç•¥ã€SCAMPERæ–¹æ¡ˆç­‰ï¼‰æŒ‰ã€Œå½±éŸ¿åŠ› Ã— å¯è¡Œæ€§ã€åˆ†ç‚ºå››é¡ï¼š
            - **å¿«é€Ÿè‡´å‹ (Quick Wins)**: é«˜å½±éŸ¿åŠ›ï¼ˆ7-10ï¼‰+ é«˜å¯è¡Œæ€§ï¼ˆ7-10ï¼‰â†’ å»ºè­°è³‡æºé…ç½® 50%
              é€™äº›æ˜¯ã€ŒçŸ­æœŸå…§å¯è¦‹æ•ˆä¸”å®¹æ˜“åŸ·è¡Œã€çš„é …ç›®ï¼Œæ‡‰å„ªå…ˆæŠ•å…¥
            - **æˆ°ç•¥è³­æ³¨ (Big Bets)**: é«˜å½±éŸ¿åŠ›ï¼ˆ7-10ï¼‰+ ä½å¯è¡Œæ€§ï¼ˆ1-6ï¼‰â†’ å»ºè­°è³‡æºé…ç½® 30%
              é€™äº›æ˜¯ã€Œé•·æœŸæˆ°ç•¥åƒ¹å€¼é«˜ä½†éœ€å…‹æœå›°é›£ã€çš„é …ç›®ï¼Œéœ€åˆ†éšæ®µæ¨é€²
            - **å¡«å……é …ç›® (Fill-ins)**: ä½å½±éŸ¿åŠ›ï¼ˆ1-6ï¼‰+ é«˜å¯è¡Œæ€§ï¼ˆ7-10ï¼‰â†’ å»ºè­°è³‡æºé…ç½® 15%
              é€™äº›æ˜¯ã€Œå®¹æ˜“åšä½†æ•ˆç›Šæœ‰é™ã€çš„é …ç›®ï¼Œå¯ä½œç‚ºå¿«é€Ÿå–å¾—é€²å±•çš„è£œå……
            - **é‡‘éŒ¢é™·é˜± (Money Pits)**: ä½å½±éŸ¿åŠ›ï¼ˆ1-6ï¼‰+ ä½å¯è¡Œæ€§ï¼ˆ1-6ï¼‰â†’ å»ºè­°è³‡æºé…ç½® 5%
              é€™äº›æ˜¯ã€ŒæŠ•å…¥ç”¢å‡ºæ¯”ä½ã€çš„é …ç›®ï¼Œæ‡‰é¿å…æˆ–å»¶å¾Œ
            
            ã€ç«‹å³è¡Œå‹• (30 å¤©)ã€‘å¾ã€Œå¿«é€Ÿè‡´å‹ã€å€é¸å‡º 3-5 å€‹è¡Œå‹•ï¼Œæ˜ç¢ºè² è²¬äººèˆ‡æœŸé™ã€‚
            ã€å­£åº¦è·¯ç·šåœ–ã€‘å¹³è¡¡ã€Œå¿«é€Ÿè‡´å‹ã€èˆ‡ã€Œæˆ°ç•¥è³­æ³¨ã€çš„åŸ·è¡Œç¯€å¥ï¼Œç‚º Q1-Q4 è¦åŠƒé‡é»ã€‚
            ã€é•·æœŸé¡˜æ™¯ã€‘æç¹ª 1-3 å¹´çš„æˆ°ç•¥è—åœ–èˆ‡è½‰å‹ç›®æ¨™ã€‚
            
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            {
              "strategic_insight": "3-5 å€‹æ ¸å¿ƒæ´å¯Ÿçš„æ•´åˆæè¿°",
              "priority_matrix": {
                "quick_wins": [
                  {
                    "initiative": "æ–¹æ¡ˆåç¨±",
                    "source": "ä¾†æºï¼ˆSWOT/SCAMPER/å…¶ä»–ï¼‰",
                    "impact": 8,
                    "feasibility": 9,
                    "why_quick_win": "ç‚ºä½•å±¬æ–¼å¿«é€Ÿè‡´å‹",
                    "estimated_timeline": "é ä¼°å®Œæˆæ™‚é–“"
                  }
                ],
                "big_bets": [
                  {
                    "initiative": "æ–¹æ¡ˆåç¨±",
                    "source": "ä¾†æº",
                    "impact": 9,
                    "feasibility": 5,
                    "why_big_bet": "ç‚ºä½•å±¬æ–¼æˆ°ç•¥è³­æ³¨",
                    "key_challenges": "ä¸»è¦æŒ‘æˆ°",
                    "mitigation_strategy": "å…‹æœç­–ç•¥"
                  }
                ],
                "fill_ins": [
                  {
                    "initiative": "æ–¹æ¡ˆåç¨±",
                    "source": "ä¾†æº",
                    "impact": 5,
                    "feasibility": 8,
                    "why_fill_in": "ç‚ºä½•å±¬æ–¼å¡«å……é …ç›®"
                  }
                ],
                "money_pits": [
                  {
                    "initiative": "æ–¹æ¡ˆåç¨±ï¼ˆå¦‚æœ‰ï¼‰",
                    "source": "ä¾†æº",
                    "impact": 3,
                    "feasibility": 4,
                    "why_avoid": "ç‚ºä½•æ‡‰é¿å…"
                  }
                ]
              },
              "resource_allocation_summary": {
                "quick_wins": "50%",
                "big_bets": "30%",
                "fill_ins": "15%",
                "money_pits": "5%"
              },
              "immediate_actions": [
                {"action": "è¡Œå‹•æè¿°", "owner": "è² è²¬äºº/éƒ¨é–€", "deadline": "30å¤©å…§å…·é«”æ—¥æœŸ", "from_category": "å¿«é€Ÿè‡´å‹"}
              ],
              "quarterly_roadmap": [
                {
                  "quarter": "Q1",
                  "focus": "æœ¬å­£é‡é»ä¸»é¡Œ",
                  "quick_wins_count": 2,
                  "big_bets_progress": "æˆ°ç•¥è³­æ³¨çš„éšæ®µæ€§ç›®æ¨™"
                }
              ],
              "long_term_vision": "1-3å¹´é¡˜æ™¯æè¿°"
            }`;
        }

        // --- æ¸²æŸ“å‡½æ•¸ ---
        function renderAnalysisCard(modelId, data) {
            const model = availableModels.find(m => m.id === modelId);
            const container = document.createElement('div');
            container.className = 'bg-michigan-blue-lightest p-6 rounded-xl border-l-4 border-michigan-blue card-shadow';
            container.innerHTML = `
                <details open>
                    <summary class="font-bold text-michigan-blue text-xl cursor-pointer list-none flex justify-between items-center">
                        <span>${model.name}</span>
                        <span class="text-sm font-normal text-gray-500 hover:underline">é»æ“Šå±•é–‹/æ”¶åˆ</span>
                    </summary>
                    <div class="mt-4" id="content-${modelId}"></div>
                </details>
                <div class="flex justify-end items-center mt-4 gap-2">
                    <span class="text-xs text-gray-500">é€™å€‹åˆ†ææœ‰å¹«åŠ©å—ï¼Ÿ</span>
                    <button class="feedback-button" onclick="giveFeedback(this, '${modelId}', 'good')">ğŸ‘</button>
                    <button class="feedback-button" onclick="giveFeedback(this, '${modelId}', 'bad')">ğŸ‘</button>
                </div>`;
            document.getElementById('analysis-dashboard').appendChild(container);
            const contentDiv = document.getElementById(`content-${modelId}`);
            // [è¨»] æ­¤è™•å‹•æ…‹å‘¼å« render å‡½æ•¸ï¼Œæœƒè‡ªå‹•å°æ‡‰åˆ°æ–°åŠ å…¥çš„ renderCustomerJourney
            window[`render${modelId.charAt(0).toUpperCase() + modelId.slice(1)}`](contentDiv, data);
        }
        
        function renderSwot(container, data) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç‰ˆä¸‰å±¤çµæ§‹
            const isEnhanced = data.diagnosis && data.strategy_matrix;
            
            if (isEnhanced) {
                // æ–°ç‰ˆï¼šä¸‰å±¤æ·±å…¥æ¸²æŸ“
                const diag = data.diagnosis;
                const matrix = data.strategy_matrix;
                const priorities = data.top_3_priorities || [];
                
                container.innerHTML = `
                    <!-- ç¬¬ä¸€å±¤ï¼šè¨ºæ–·å±¤ï¼ˆ4è±¡é™ï¼‰ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-100 p-4 rounded-lg">
                            <h4 class="font-bold text-green-800 mb-2">ğŸ’ª å„ªå‹¢ (S)</h4>
                            <ul class="space-y-2">
                                ${(diag.strengths || []).map(s => `
                                    <li class="text-sm">
                                        <span class="font-semibold text-green-900">${s.point}</span>
                                        <p class="text-xs text-green-700 mt-1 pl-3 border-l-2 border-green-300">æ ¹å› ï¼š${s.root_cause}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg">
                            <h4 class="font-bold text-red-800 mb-2">âš ï¸ åŠ£å‹¢ (W)</h4>
                            <ul class="space-y-2">
                                ${(diag.weaknesses || []).map(w => `
                                    <li class="text-sm">
                                        <span class="font-semibold text-red-900">${w.point}</span>
                                        <p class="text-xs text-red-700 mt-1 pl-3 border-l-2 border-red-300">æ ¹å› ï¼š${w.root_cause}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-800 mb-2">ğŸš€ æ©Ÿæœƒ (O)</h4>
                            <ul class="space-y-2">
                                ${(diag.opportunities || []).map(o => `
                                    <li class="text-sm">
                                        <span class="font-semibold text-blue-900">${o.point}</span>
                                        <p class="text-xs text-blue-700 mt-1 pl-3 border-l-2 border-blue-300">èƒŒæ™¯ï¼š${o.root_cause}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded-lg">
                            <h4 class="font-bold text-yellow-800 mb-2">âš¡ å¨è„… (T)</h4>
                            <ul class="space-y-2">
                                ${(diag.threats || []).map(t => `
                                    <li class="text-sm">
                                        <span class="font-semibold text-yellow-900">${t.point}</span>
                                        <p class="text-xs text-yellow-700 mt-1 pl-3 border-l-2 border-yellow-300">æ ¹å› ï¼š${t.root_cause}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- ç¬¬äºŒå±¤ï¼šæˆ°ç•¥çŸ©é™£ï¼ˆæŠ˜ç–Šå¼ï¼‰ -->
                    <details class="mb-6 bg-white rounded-xl border-2 border-michigan-blue p-4 card-shadow">
                        <summary class="cursor-pointer font-bold text-michigan-blue text-lg flex justify-between items-center">
                            <span>ğŸ“Š ç¬¬äºŒå±¤ï¼šSWOT æˆ°ç•¥çŸ©é™£ï¼ˆé»æ“Šå±•é–‹ï¼‰</span>
                            <span class="text-sm font-normal text-gray-500">å››è±¡é™ç­–ç•¥çµ„åˆ</span>
                        </summary>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- SO ç­–ç•¥ -->
                            <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                                <h5 class="font-bold text-green-800 mb-2">ğŸ’ªğŸš€ SO ç­–ç•¥ï¼ˆå„ªå‹¢-æ©Ÿæœƒï¼‰</h5>
                                <p class="text-xs text-green-700 mb-3">é‹ç”¨å„ªå‹¢ï¼ŒæŠŠæ¡æ©Ÿæœƒ</p>
                                ${(matrix.SO || []).map((s, idx) => `
                                    <div class="bg-white p-3 rounded-md mb-2 border border-green-200">
                                        <p class="font-semibold text-sm text-green-900">ç­–ç•¥ ${idx + 1}: ${s.strategy}</p>
                                        <p class="text-xs text-gray-600 mt-1">${s.rationale}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- WO ç­–ç•¥ -->
                            <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                                <h5 class="font-bold text-yellow-800 mb-2">âš ï¸ğŸš€ WO ç­–ç•¥ï¼ˆåŠ£å‹¢-æ©Ÿæœƒï¼‰</h5>
                                <p class="text-xs text-yellow-700 mb-3">å…‹æœåŠ£å‹¢ï¼Œåˆ©ç”¨æ©Ÿæœƒ</p>
                                ${(matrix.WO || []).map((s, idx) => `
                                    <div class="bg-white p-3 rounded-md mb-2 border border-yellow-200">
                                        <p class="font-semibold text-sm text-yellow-900">ç­–ç•¥ ${idx + 1}: ${s.strategy}</p>
                                        <p class="text-xs text-gray-600 mt-1">${s.rationale}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- ST ç­–ç•¥ -->
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                                <h5 class="font-bold text-blue-800 mb-2">ğŸ’ªâš¡ ST ç­–ç•¥ï¼ˆå„ªå‹¢-å¨è„…ï¼‰</h5>
                                <p class="text-xs text-blue-700 mb-3">é‹ç”¨å„ªå‹¢ï¼Œè¦é¿å¨è„…</p>
                                ${(matrix.ST || []).map((s, idx) => `
                                    <div class="bg-white p-3 rounded-md mb-2 border border-blue-200">
                                        <p class="font-semibold text-sm text-blue-900">ç­–ç•¥ ${idx + 1}: ${s.strategy}</p>
                                        <p class="text-xs text-gray-600 mt-1">${s.rationale}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- WT ç­–ç•¥ -->
                            <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                                <h5 class="font-bold text-red-800 mb-2">âš ï¸âš¡ WT ç­–ç•¥ï¼ˆåŠ£å‹¢-å¨è„…ï¼‰</h5>
                                <p class="text-xs text-red-700 mb-3">é™ä½åŠ£å‹¢ï¼Œè¿´é¿å¨è„…</p>
                                ${(matrix.WT || []).map((s, idx) => `
                                    <div class="bg-white p-3 rounded-md mb-2 border border-red-200">
                                        <p class="font-semibold text-sm text-red-900">ç­–ç•¥ ${idx + 1}: ${s.strategy}</p>
                                        <p class="text-xs text-gray-600 mt-1">${s.rationale}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </details>
                    
                    <!-- ç¬¬ä¸‰å±¤ï¼šå‰ 3 å„ªå…ˆç­–ç•¥ -->
                    ${priorities.length > 0 ? `
                    <div class="bg-michigan-maize-lightest p-5 rounded-xl border-l-4 border-michigan-maize card-shadow">
                        <h4 class="font-bold text-michigan-blue text-lg mb-3">ğŸ¯ ç¬¬ä¸‰å±¤ï¼šå‰ 3 å„ªå…ˆåŸ·è¡Œç­–ç•¥</h4>
                        <div class="space-y-3">
                            ${priorities.map(p => `
                                <div class="bg-white p-4 rounded-lg border-2 border-michigan-blue">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="bg-michigan-blue text-michigan-maize font-bold px-3 py-1 rounded-full text-sm">å„ªå…ˆç´š ${p.rank}</span>
                                                <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs">${p.type} ç­–ç•¥</span>
                                                <span class="text-xs ${p.resource_requirement === 'ä½' ? 'text-green-600' : p.resource_requirement === 'ä¸­' ? 'text-yellow-600' : 'text-red-600'} font-semibold">
                                                    è³‡æºéœ€æ±‚ï¼š${p.resource_requirement}
                                                </span>
                                            </div>
                                            <p class="font-semibold text-michigan-blue mb-2">${p.strategy}</p>
                                            <div class="text-sm text-gray-700 space-y-1">
                                                <p><strong>å„ªå…ˆåŸå› ï¼š</strong>${p.why_priority}</p>
                                                <p><strong>é æœŸæ•ˆç›Šï¼š</strong>${p.expected_benefit}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
            } else {
                // èˆŠç‰ˆï¼šç°¡å–®å››è±¡é™ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
                container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded-lg"><h4 class="font-bold text-green-800 mb-2">å„ªå‹¢(S)</h4><ul class="list-disc list-inside text-sm text-green-700 space-y-1">${(data.strengths || []).map(s => `<li>${(typeof s === 'object' && s !== null) ? Object.values(s).join('ï¼š ') : s}</li>`).join('')}</ul></div>
                    <div class="bg-red-100 p-4 rounded-lg"><h4 class="font-bold text-red-800 mb-2">åŠ£å‹¢(W)</h4><ul class="list-disc list-inside text-sm text-red-700 space-y-1">${(data.weaknesses || []).map(w => `<li>${(typeof w === 'object' && w !== null) ? Object.values(w).join('ï¼š ') : w}</li>`).join('')}</ul></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><h4 class="font-bold text-blue-800 mb-2">æ©Ÿæœƒ(O)</h4><ul class="list-disc list-inside text-sm text-blue-700 space-y-1">${(data.opportunities || []).map(o => `<li>${(typeof o === 'object' && o !== null) ? Object.values(o).join('ï¼š ') : o}</li>`).join('')}</ul></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><h4 class="font-bold text-yellow-800 mb-2">å¨è„…(T)</h4><ul class="list-disc list-inside text-sm text-yellow-700 space-y-1">${(data.threats || []).map(t => `<li>${(typeof t === 'object' && t !== null) ? Object.values(t).join('ï¼š ') : t}</li>`).join('')}</ul></div>
                </div>`;
            }
        }
        
        function renderPorters(container, data) {
            const levelColor = { 'é«˜': 'bg-red-500', 'ä¸­': 'bg-yellow-500', 'ä½': 'bg-green-500' };
            container.innerHTML = `<div class="space-y-3 mb-4">
                ${(data.forces || []).map(f => `<div class="p-3 bg-white rounded-lg border"><div class="flex items-center justify-between"><h5 class="font-semibold text-michigan-blue">${f.name}</h5><span class="px-3 py-1 text-white text-xs rounded-full ${levelColor[f.level] || 'bg-gray-400'}">${f.level}</span></div><p class="text-sm text-gray-600 mt-1">${f.reason}</p></div>`).join('')}
                </div>
                <div class="p-4 bg-michigan-maize-lightest rounded-lg"><h5 class="font-bold text-michigan-blue">ç¸½çµ</h5><p class="text-sm text-gray-700">${data.summary || ''}</p></div>`;

            
            // Phase 2A å¢å¼·ï¼šç«¶çˆ­ç­–ç•¥å»ºè­°
            if (data.competitive_strategy) {
                const cs = data.competitive_strategy;
                
                container.innerHTML += `
                    <div class="mt-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-indigo-200">
                        <h4 class="text-xl font-bold text-indigo-800 mb-4">
                            ğŸ¯ ç«¶çˆ­ç­–ç•¥å»ºè­°
                        </h4>
                        
                        <!-- æ¨è–¦ç­–ç•¥ -->
                        <div class="bg-white p-4 rounded-lg mb-4 border-l-4 border-indigo-500">
                            <h5 class="font-bold text-indigo-700 mb-2">ğŸ’¡ æ¨è–¦ç­–ç•¥</h5>
                            <p class="text-lg font-semibold text-gray-800">${cs.recommended_strategy}</p>
                        </div>
                        
                        <!-- ä¸‰å¤§ç­–ç•¥è©•ä¼° -->
                        <h5 class="font-bold text-gray-700 mb-3">ğŸ“Š æ³¢ç‰¹ä¸‰å¤§åŸºæœ¬ç­–ç•¥è©•ä¼°</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            ${(cs.porter_generic_strategies || []).map(s => `
                                <div class="bg-white p-4 rounded-lg border border-gray-200">
                                    <h6 class="font-bold text-gray-800 mb-2">${s.strategy}</h6>
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm text-gray-600">é©åˆåº¦</span>
                                        <span class="text-2xl font-bold text-indigo-600">${s.score}/10</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-sm text-gray-600">å¯è¡Œæ€§ï¼š</span>
                                        <span class="px-2 py-1 rounded text-sm font-semibold ${
                                            s.feasibility === 'é«˜' ? 'bg-green-100 text-green-800' :
                                            s.feasibility === 'ä¸­' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'
                                        }">${s.feasibility}</span>
                                    </div>
                                    <p class="text-sm text-gray-600">${s.reason}</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- å‰ 3 å¤§é—œéµè¡Œå‹• -->
                        <h5 class="font-bold text-gray-700 mb-3">ğŸš€ å‰ 3 å¤§é—œéµè¡Œå‹•å»ºè­°</h5>
                        <div class="space-y-3">
                            ${(cs.top_3_actions || []).map((action, idx) => `
                                <div class="bg-white p-4 rounded-lg border-l-4 border-indigo-400">
                                    <h6 class="font-bold text-gray-800 mb-2">${idx + 1}. ${action.action}</h6>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong class="text-indigo-600">ç­–ç•¥ä¾æ“šï¼š</strong>${action.strategic_basis}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <strong class="text-green-600">é æœŸæˆæœï¼š</strong>${action.expected_outcome}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function renderPestel(container, data) {
            const labels = { political: 'æ”¿æ²»', economic: 'ç¶“æ¿Ÿ', social: 'ç¤¾æœƒ', technological: 'æŠ€è¡“', environmental: 'ç’°å¢ƒ', legal: 'æ³•å¾‹' };
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${Object.entries(data || {}).map(([key, value]) => `<div class="bg-white p-4 rounded-lg border"><h4 class="font-bold text-michigan-blue mb-2">${labels[key] || key}</h4><ul class="list-disc list-inside text-sm text-gray-700 space-y-1">${(value || []).map(item => `<li>${(typeof item === 'object' && item !== null) ? Object.values(item).join('ï¼š ') : item}</li>`).join('')}</ul></div>`).join('')}
            </div>`;
        }

        function renderBmc(container, data) {
            const renderList = (items) => (items || []).map(item => `<li>${(typeof item === 'object' && item !== null) ? Object.values(item).join('ï¼š ') : item}</li>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-5 gap-4 text-xs md:text-sm">
                    <div class="md:col-span-1 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">é—œéµåˆä½œå¤¥ä¼´</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_partnerships)}</ul> </div>
                    <div class="md:col-span-1 space-y-4"> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é—œéµæ´»å‹•</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_activities)}</ul> </div> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é—œéµè³‡æº</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_resources)}</ul> </div> </div>
                    <div class="md:col-span-1 bg-michigan-maize-lightest p-2 md:p-4 rounded-lg border-2 border-michigan-maize"> <h4 class="font-bold text-michigan-blue mb-2">åƒ¹å€¼ä¸»å¼µ</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.value_propositions)}</ul> </div>
                    <div class="md:col-span-1 space-y-4"> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é¡§å®¢é—œä¿‚</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.customer_relationships)}</ul> </div> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é€šè·¯</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.channels)}</ul> </div> </div>
                    <div class="md:col-span-1 bg-michigan-maize-lightest p-2 md:p-4 rounded-lg border-2 border-michigan-maize"> <h4 class="font-bold text-michigan-blue mb-2">é¡§å®¢æ—ç¾¤</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.customer_segments)}</ul> </div>
                    <div class="md:col-span-3 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">æˆæœ¬çµæ§‹</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.cost_structure)}</ul> </div>
                    <div class="md:col-span-2 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">æ”¶ç›Šæµ</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.revenue_streams)}</ul> </div>
                </div>`;
        }

        function renderVpc(container, data) {
            const renderList = (items) => (items || []).map(item => `<li class="text-sm">${(typeof item === 'object' && item !== null) ? Object.values(item).join('ï¼š ') : item}</li>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div class="bg-white p-4 rounded-xl border-2 border-michigan-blue h-full flex flex-col"> <h4 class="font-bold text-michigan-blue text-lg mb-3 text-center">åƒ¹å€¼åœ°åœ–</h4> <div class="space-y-4 flex-grow"> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ ç”¢å“èˆ‡æœå‹™</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.products_services)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ’Š ç—›é»è§£æ–¹</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.pain_relievers)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">âœ¨ ç²ç›Šå‰µé€ è€…</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.gain_creators)}</ul> </div> </div> </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-michigan-maize h-full flex flex-col"> <h4 class="font-bold text-michigan-blue text-lg mb-3 text-center">é¡§å®¢è¼ªå»“</h4> <div class="space-y-4 flex-grow"> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ‘ æœŸæœ›ç²ç›Š</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.gains)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ‘ ç—›é»</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.pains)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ“ é¡§å®¢ä»»å‹™</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.jobs)}</ul> </div> </div> </div>
                </div>`;
        }

        // --- [æ–°åŠ å…¥] å®¢æˆ¶æ—…ç¨‹ Render ---
        function renderCustomerJourney(container, data) {
            if (!data || !Array.isArray(data.stages)) {
                container.innerHTML = `<p class="text-gray-500">ç„¡æ³•è¼‰å…¥å®¢æˆ¶æ—…ç¨‹åˆ†æè³‡æ–™ã€‚</p>`;
                return;
            }

            const stages = data.stages || [];

            const renderTagList = (items) =>
                (items || []).map(item =>
                    `<li class="text-xs bg-gray-200 text-gray-700 rounded-full px-2 py-0.5">
                        ${(typeof item === 'object' && item !== null) ? Object.values(item).join('ï¼š ') : item}
                     </li>`
                ).join('');

            const getPainColorClass = (score) => {
                if (!score && score !== 0) return 'bg-gray-100 text-gray-700';
                if (score <= 3) return 'bg-green-100 text-green-800';
                if (score <= 6) return 'bg-yellow-100 text-yellow-800';
                return 'bg-red-100 text-red-800';
            };

            const getStageScore = (stage) => {
                if (typeof stage.overall_pain_score === 'number') return stage.overall_pain_score;
                if (Array.isArray(stage.pain_points) && stage.pain_points.length > 0) {
                    const sum = stage.pain_points.reduce(
                        (acc, p) => acc + (Number(p.intensity) || 0),
                        0
                    );
                    return sum / stage.pain_points.length;
                }
                return 0;
            };

            const heatmapHtml = stages.length ? `
                <div class="mb-6">
                    <h5 class="font-semibold text-michigan-blue mb-1">ğŸ”¥ å®¢æˆ¶æ—…ç¨‹ç—›é»ç†±åŠ›åœ–</h5>
                    <p class="text-xs text-gray-500 mb-3">æ•¸å€¼è¶Šé«˜ä»£è¡¨è©²éšæ®µç—›é»è¶Šåš´é‡ï¼ˆ1â€“3 è¼•å¾®ï¼Œ4â€“6 ä¸­ç­‰ï¼Œ7â€“10 åš´é‡ï¼‰</p>
                    <div class="grid grid-cols-2 md:grid-cols-${Math.min(4, stages.length)} gap-3">
                        ${stages.map(stage => {
                            const score = getStageScore(stage);
                            const cls = getPainColorClass(score);
                            const severity = score <= 3 ? 'è¼•å¾®' : (score <= 6 ? 'ä¸­ç­‰' : 'åš´é‡');
                            return `
                            <div class="p-3 rounded-lg text-center ${cls}">
                                <div class="text-xs font-semibold">${stage.stage_name || ''}</div>
                                <div class="text-lg font-bold mt-1">${score ? score.toFixed(1) : 'â€”'}</div>
                                <div class="text-[10px] mt-1">${severity}ç—›é»</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            ` : '';

            const stagesHtml = stages.map(s => {
                const score = getStageScore(s);
                const scoreCls = getPainColorClass(score);

                return `
                <div class="p-3 bg-white rounded-lg border">
                    <h5 class="font-semibold text-michigan-blue">${s.stage_name}</h5>
                    <p class="text-sm text-gray-600 mt-1 mb-2">${s.description || ''}</p>

                    <h6 class="text-xs font-semibold text-gray-500 mb-1">é—œéµæ¥è§¸é»</h6>
                    <ul class="flex flex-wrap gap-2 mb-2">
                        ${renderTagList(s.key_touchpoints)}
                    </ul>

                    ${
                        (s.pain_points && s.pain_points.length)
                        ? `
                        <div class="mt-2 border-t pt-2">
                            <div class="flex items-center justify-between mb-1">
                                <h6 class="text-xs font-semibold text-gray-500">ç—›é»èˆ‡å»ºè­°</h6>
                                <span class="text-[10px] px-2 py-0.5 rounded-full ${scoreCls}">
                                    æ•´é«”ç—›é» ${score ? score.toFixed(1) : 'â€”'}/10
                                </span>
                            </div>
                            <div class="space-y-2">
                                ${s.pain_points.map(pain => {
                                    const pScore = Number(pain.intensity) || 0;
                                    const pCls = getPainColorClass(pScore);
                                    return `
                                    <div class="bg-gray-50 border-l-4 ${pCls.replace('bg-', 'border-')} p-2 rounded">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-xs font-semibold text-gray-800">${pain.description || ''}</span>
                                            <span class="text-[10px] px-2 py-0.5 rounded-full ${pCls}">
                                                ${pScore}/10
                                            </span>
                                        </div>
                                        <div class="text-[11px] text-gray-600">
                                            <span class="inline-block px-2 py-0.5 bg-white rounded border mr-1">
                                                é¡å‹ï¼š${pain.category || 'æœªåˆ†é¡'}
                                            </span>
                                            <span class="inline-block mt-1">ğŸ’¡ ${pain.solution_hint || 'å»ºè­°ç”±åœ˜éšŠé€²ä¸€æ­¥è¨è«–è§£æ³•'}</span>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        `
                        : ''
                    }
                </div>`;
            }).join('');

            container.innerHTML = `
                <div class="mb-4 p-4 bg-white rounded-lg border">
                    <h5 class="font-semibold text-michigan-blue">é¸ç”¨æ¨¡å‹: ${data.model_chosen || 'N/A'}</h5>
                    <p class="text-sm text-gray-600 mt-1">${data.reason_for_choice || ''}</p>
                </div>
                ${heatmapHtml}
                <div class="space-y-3 mb-4">
                    ${stagesHtml}
                </div>
                <div class="p-4 bg-michigan-maize-lightest rounded-lg">
                    <h5 class="font-bold text-michigan-blue">é—œéµæ´å¯Ÿç¸½çµ</h5>
                    <p class="text-sm text-gray-700">${data.summary_insight || ''}</p>
                </div>
            `;
        }
function renderScamper(data) {
            const container = document.getElementById('scamper-result');
            if (!data || (!data.scamper_solutions?.length)) {
                container.innerHTML = `<div class="text-center text-gray-500">AI æœªèƒ½ç”Ÿæˆ SCAMPER å‰µæ–°æ–¹æ¡ˆã€‚</div>`; 
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç‰ˆç—›é»å°å‘çµæ§‹
            const isEnhanced = data.pain_points_summary && data.top_5_priorities;
            
            if (isEnhanced) {
                // æ–°ç‰ˆï¼šç—›é»å°å‘æ¸²æŸ“
                container.innerHTML = `
                    <!-- ç—›é»æ‘˜è¦ -->
                    ${data.pain_points_summary?.length ? `
                    <div class="bg-red-50 p-5 rounded-xl border-l-4 border-red-500 mb-6 card-shadow">
                        <h3 class="font-bold text-red-800 text-lg mb-3">ğŸ¯ å‰éšæ®µè­˜åˆ¥çš„æˆ°ç•¥ç´šç—›é»</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${data.pain_points_summary.map(p => `
                                <div class="bg-white p-3 rounded-lg border border-red-200">
                                    <span class="text-xs font-semibold text-red-600">[${p.source}]</span>
                                    <p class="text-sm text-gray-800 mt-1">${p.pain}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- SCAMPER æ–¹æ¡ˆï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰ -->
                    <div class="mb-6">
                        <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸ§© SCAMPER ç—›é»è§£æ±ºæ–¹æ¡ˆï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰</h3>
                        <div class="space-y-3">
                            ${data.scamper_solutions.map(s => `
                                <details class="bg-white p-4 rounded-xl border-2 card-shadow hover:border-michigan-blue transition-all">
                                    <summary class="cursor-pointer flex justify-between items-center">
                                        <div class="flex-1">
                                            <span class="font-bold text-michigan-blue">${s.technique}: ${s.solution.title}</span>
                                            <p class="text-xs text-gray-500 mt-1">ğŸ¯ è§£æ±ºç—›é»ï¼š${s.target_pain}</p>
                                        </div>
                                        <div class="flex gap-2 ml-4">
                                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">å½±éŸ¿åŠ› ${s.scores?.impact || 'N/A'}/10</span>
                                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">å¯è¡Œæ€§ ${s.scores?.feasibility || 'N/A'}/10</span>
                                            <span class="text-xs ${s.solution.resource_requirement === 'ä½' ? 'bg-green-100 text-green-700' : s.solution.resource_requirement === 'ä¸­' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'} px-2 py-1 rounded">
                                                è³‡æº ${s.solution.resource_requirement}
                                            </span>
                                        </div>
                                    </summary>
                                    <div class="mt-4 pt-4 border-t">
                                        <h5 class="font-semibold text-gray-800 mb-2">æ–¹æ¡ˆæè¿°</h5>
                                        <p class="text-sm text-gray-700 mb-3">${s.solution.description}</p>
                                        <h5 class="font-semibold text-gray-800 mb-2">é æœŸæ•ˆç›Š</h5>
                                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                                            ${(s.solution.expected_benefits || []).map(b => `<li>${b}</li>`).join('')}
                                        </ul>
                                        ${s.scores ? `
                                        <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                            <span class="text-xs font-semibold text-gray-700">å„ªå…ˆç´šåˆ†æ•¸ï¼š</span>
                                            <span class="text-lg font-bold text-michigan-blue">${s.scores.priority_score.toFixed(1)}</span>
                                            <span class="text-xs text-gray-500">/ 10</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </details>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- å‰ 5 å„ªå…ˆæ–¹æ¡ˆ -->
                    ${data.top_5_priorities?.length ? `
                    <div class="bg-michigan-maize-lightest p-6 rounded-xl border-l-4 border-michigan-maize card-shadow">
                        <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸš€ å‰ 5 å„ªå…ˆåŸ·è¡Œæ–¹æ¡ˆ</h3>
                        <div class="space-y-3">
                            ${data.top_5_priorities.map(p => `
                                <div class="bg-white p-4 rounded-lg border-2 border-michigan-blue">
                                    <div class="flex items-start gap-3">
                                        <span class="bg-michigan-blue text-michigan-maize font-bold px-3 py-1 rounded-full text-lg flex-shrink-0">
                                            ${p.rank}
                                        </span>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-bold text-michigan-blue">${p.technique}: ${p.title}</span>
                                                <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                                                    åˆ†æ•¸ ${p.priority_score.toFixed(1)}
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600 mb-2">ğŸ¯ ${p.target_pain}</p>
                                            <p class="text-sm text-gray-700"><strong>å„ªå…ˆåŸå› ï¼š</strong>${p.why_top}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
            } else {
                // èˆŠç‰ˆï¼šå‘ä¸‹ç›¸å®¹æ¸²æŸ“
                container.innerHTML = `
                    ${data.strategic_insights?.length ? `<div class="bg-michigan-maize-lightest p-6 rounded-xl border-l-4 border-michigan-maize mb-8 card-shadow"> <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸ¯ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> ${data.strategic_insights.map(i => `<div class="bg-white p-4 rounded-lg border"><h4 class="font-semibold text-michigan-blue mb-2">${i.issue}</h4><p class="text-sm text-gray-700 mb-2">${i.description}</p><div class="text-xs text-gray-500"><strong>æ•¸æ“šä¾æ“šï¼š</strong> ${(i.data_sources || []).join(', ')}</div></div>`).join('')} </div> </div>` : ''}
                    ${data.scamper_solutions?.length ? `<div class="mb-8"> <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸ§© SCAMPERå‰µæ–°æ–¹æ¡ˆ</h3> <div class="space-y-4"> ${data.scamper_solutions.map(s => `<details class="bg-white p-4 rounded-xl border card-shadow"><summary class="font-semibold text-michigan-blue cursor-pointer">${s.technique}: ${s.solution.title}</summary><div class="mt-3 pt-3 border-t"><p class="text-sm text-gray-700 mb-2">${s.solution.description}</p><p class="text-xs text-gray-600"><strong>é æœŸæ•ˆç›Š:</strong> ${(s.solution.expected_benefits || []).join(', ')}</p><p class="text-xs text-gray-500 mt-1"><strong>å°æ‡‰è­°é¡Œ:</strong> ${s.strategic_issue}</p></div></details>`).join('')} </div> </div>` : ''}
                    ${data.priority_ranking?.length ? `<div class="bg-michigan-blue-lightest p-6 rounded-xl border-l-4 border-michigan-blue card-shadow"> <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸš€ å„ªå…ˆå¯¦æ–½å»ºè­°</h3> <ol class="list-decimal list-inside space-y-2 text-gray-800"> ${data.priority_ranking.map(p => `<li>${(typeof p === 'object' && p !== null) ? (p.title || Object.values(p).join('ï¼š ')) : p}</li>`).join('')} </ol> </div>` : ''}
                `;
            }
        }
        
        function renderBlueOcean(containerOrData, maybeData) {
            let container, data;

            if (containerOrData instanceof HTMLElement) {
                container = containerOrData;
                data = maybeData;
            } else {
                container = document.getElementById('blue-ocean-result');
                data = containerOrData;
            }

            if (!container || !data) {
                if (container) {
                    container.innerHTML = `<p class="text-gray-500">ç„¡æ³•è¼‰å…¥è—æµ·ç­–ç•¥åˆ†æè³‡æ–™ã€‚</p>`;
                }
                return;
            }

            const fourActions = data.four_actions || {
                eliminate: data.eliminate || [],
                reduce: data.reduce || [],
                raise: data.raise || [],
                create: data.create || []
            };

            const normalizeItems = (items = []) =>
                items.map(it => ({
                    title: it.action || it.item || it.name || '',
                    reason: it.rationale || it.reason || it.explanation || ''
                }));

            const renderActions = (actions) =>
                normalizeItems(actions).map(item => `
                    <div class="bg-white p-3 rounded-md border">
                        <h5 class="font-semibold text-gray-800">${item.title || 'æœªå‘½åé …ç›®'}</h5>
                        <p class="text-xs text-gray-600 mt-1">${item.reason || ''}</p>
                    </div>
                `).join('') || `<p class="text-xs text-gray-400">å°šæœªåµæ¸¬åˆ°æ­¤è±¡é™çš„å…·é«”é …ç›®ã€‚</p>`;

            const strategicInsightHtml = data.strategic_insights
                ? `
                <div class="mb-4 bg-michigan-maize-lightest p-4 rounded-lg border-l-4 border-michigan-maize">
                    <h4 class="font-bold text-michigan-blue text-sm mb-1">ğŸ¯ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h4>
                    <p class="text-xs text-gray-800">${data.strategic_insights}</p>
                </div>`
                : '';

            container.innerHTML = `
                <h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">å››é …è¡Œå‹•æ¶æ§‹ (ERRC Grid)</h3>
                ${strategicInsightHtml}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-red-50 p-4 rounded-lg">
                        <h4 class="font-bold text-red-700 mb-3">ğŸš« æ¶ˆé™¤ (Eliminate)</h4>
                        <div class="space-y-3">${renderActions(fourActions.eliminate)}</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-bold text-yellow-700 mb-3">ğŸ“‰ æ¸›å°‘ (Reduce)</h4>
                        <div class="space-y-3">${renderActions(fourActions.reduce)}</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-700 mb-3">ğŸ“ˆ æå‡ (Raise)</h4>
                        <div class="space-y-3">${renderActions(fourActions.raise)}</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-bold text-green-700 mb-3">âœ¨ å‰µé€  (Create)</h4>
                        <div class="space-y-3">${renderActions(fourActions.create)}</div>
                    </div>
                </div>
            `;
        }
function renderDesignThinking(data) {
            const container = document.getElementById('design-thinking-result');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">è¨­è¨ˆæ€ç¶­äº”éšæ®µæµç¨‹</h3> <div class="space-y-4"> ${(data.stages || []).map(s => `<div class="bg-michigan-blue-lightest p-5 rounded-xl border-l-4 border-michigan-blue"> <h4 class="font-bold text-michigan-blue text-lg">${s.stage}</h4> <p class="text-sm text-gray-700 my-2">${s.description}</p> <h5 class="font-semibold text-gray-800 text-sm mb-2">é—œéµè¡Œå‹• / å•é¡Œ:</h5> <ul class="list-disc list-inside text-sm text-gray-600 space-y-1"> ${(s.actions || []).map(a => `<li>${(typeof a === 'object' && a !== null) ? Object.values(a).join('ï¼š ') : a}</li>`).join('')} </ul> </div>`).join('')} </div>`;
        }

        function renderLeanStartup(data) {
            const container = document.getElementById('lean-startup-result');
            if(!data) return;
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">${data.title || 'ç²¾å¯¦å‰µæ¥­è¡Œå‹•è¨ˆç•«'}</h3> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div class="bg-blue-50 p-5 rounded-lg border border-blue-200"> <h4 class="font-bold text-blue-800 text-2xl mb-3">1. å»ºç«‹</h4> <h5 class="font-semibold text-blue-700">é—œéµå‡è¨­</h5><p class="text-sm text-gray-700 mb-4">${data.build?.key_hypothesis || ''}</p> <h5 class="font-semibold text-blue-700">MVP å»ºè­°: ${data.build?.mvp_suggestion?.name || ''}</h5> <p class="text-sm text-gray-700 mb-2">${data.build?.mvp_suggestion?.description || ''}</p> <ul class="list-disc list-inside text-xs text-gray-600">${(data.build?.mvp_suggestion?.features || []).map(f => `<li>${(typeof f === 'object' && f !== null) ? Object.values(f).join('ï¼š ') : f}</li>`).join('')}</ul> </div> <div class="bg-green-50 p-5 rounded-lg border border-green-200"> <h4 class="font-bold text-green-800 text-2xl mb-3">2. è¡¡é‡</h4> <h5 class="font-semibold text-green-700">é—œéµæŒ‡æ¨™</h5><ul class="text-sm text-gray-700 mb-4 space-y-2">${(data.measure?.key_metrics || []).map(m => `<li><strong>${m.metric}:</strong> ${m.definition}</li>`).join('')}</ul> <h5 class="font-semibold text-green-700">è¡¡é‡æ–¹æ³•</h5> <p class="text-sm text-gray-700">${data.measure?.measurement_method || ''}</p> </div> <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-200"> <h4 class="font-bold text-yellow-800 text-2xl mb-3">3. å­¸ç¿’</h4> <h5 class="font-semibold text-yellow-700">æ±ºç­–é»: å …æŒæˆ–è½‰å‘?</h5> <p class="text-sm text-gray-700 mb-4">${data.learn?.pivot_or_persevere || ''}</p> <h5 class="font-semibold text-yellow-700">å­¸ç¿’å•é¡Œ</h5> <ul class="list-disc list-inside text-sm text-gray-700">${(data.learn?.learning_questions || []).map(q => `<li>${(typeof q === 'object' && q !== null) ? Object.values(q).join('ï¼š ') : q}</li>`).join('')}</ul> </div> </div>`;
        }

        function renderTenTypes(data) {
            const container = document.getElementById('ten-types-result');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">åå¤§å‰µæ–°é¡å‹æ©Ÿæœƒé»</h3> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> ${(data.categories || []).map(c => `<div class="bg-michigan-blue-lightest p-5 rounded-lg"> <h4 class="font-bold text-michigan-blue text-lg mb-2">${c.name}</h4> <p class="text-xs text-gray-600 mb-4">${c.description}</p> <div class="space-y-4"> ${(c.types || []).map(t => `<div class="bg-white p-3 rounded-md"> <h5 class="font-semibold text-gray-800 text-sm">${t.type_name}</h5> <ul class="list-disc list-inside text-xs text-gray-600 mt-2"> ${(t.ideas || []).map(i => `<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join('')} </ul> </div>`).join('')} </div> </div>`).join('')} </div>`;
        }

        function renderFinalRecommendationsCore(data) {
            const container = document.getElementById('final-recommendations');
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç‰ˆå„ªå…ˆç´šçŸ©é™£çµæ§‹
            const isEnhanced = data.priority_matrix;
            
            if (isEnhanced) {
                // æ–°ç‰ˆï¼šå„ªå…ˆç´šçŸ©é™£æ¸²æŸ“
                const matrix = data.priority_matrix;
                const allocation = data.resource_allocation_summary;
                
                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- æ ¸å¿ƒæ´å¯Ÿ -->
                        <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize">
                            <h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸ’¡ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h4>
                            <p class="text-gray-800 leading-relaxed">${data?.strategic_insight || 'AI ç¶œåˆå‰å››éšæ®µï¼ˆå¤–éƒ¨ç’°å¢ƒã€åƒ¹å€¼ä¸»å¼µã€ç‡Ÿé‹æ¨¡å¼èˆ‡é¡§å®¢æ—…ç¨‹ï¼‰çš„åˆ†æçµæœï¼Œåˆ¤æ–·ä¼æ¥­ç›®å‰æ­£è™•æ–¼ã€Œå“ç‰Œå†å®šä½èˆ‡æºé€šã€ã€ã€Œäººæ‰èˆ‡çµ„ç¹”èƒ½åŠ›é‡æ§‹ã€ä»¥åŠã€Œå‰µæ–°æŠ•è³‡èˆ‡è³‡æºé…ç½®ã€ä¸‰é‡æ‹‰æ‰¯çš„è½‰å‹é—œéµæœŸã€‚æ ¸å¿ƒç­–ç•¥å‘½é¡Œæ˜¯ï¼šå¦‚ä½•åœ¨ä¸çŠ§ç‰²ç¾æœ‰ç²åˆ©èˆ‡ç‡Ÿé‹ç©©å®šçš„å‰æä¸‹ï¼Œå»ºç«‹ä¸‹ä¸€éšæ®µæˆé•·å¼•æ“ã€‚ä»¥ä¸‹æ‘˜è¦èšç„¦æ–¼çŸ­ã€ä¸­ã€é•·æœŸçš„è¡Œå‹•ä¸»è»¸ã€è³‡æºé…ç½®é‚è¼¯èˆ‡æ²»ç†é‡é»ï¼Œè©³ç´°ä¾æ“šèˆ‡é‡åŒ–åˆ†æè«‹åƒé–±ä¸‹è¼‰ä¹‹å®Œæ•´å°ˆæ¥­è¨ºæ–·å ±å‘Šã€‚'}</p>
                        </div>
                        
                        <!-- åŸ·è¡Œå„ªå…ˆç´šçŸ©é™£ -->
                        <div class="bg-white p-6 rounded-xl border-2 border-michigan-blue card-shadow">
                            <h3 class="font-bold text-michigan-blue text-2xl mb-4 text-center">ğŸ“Š åŸ·è¡Œå„ªå…ˆç´šçŸ©é™£ï¼ˆ2Ã—2ï¼‰</h3>
                            <p class="text-sm text-gray-600 text-center mb-6">åŸºæ–¼å½±éŸ¿åŠ›èˆ‡å¯è¡Œæ€§çš„æˆ°ç•¥åˆ†é¡</p>
                            
                            <!-- 2x2 çŸ©é™£è¦–è¦ºåŒ– -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <!-- å¿«é€Ÿè‡´å‹ (å³ä¸Š) -->
                                <div class="bg-green-50 p-5 rounded-xl border-2 border-green-500 relative">
                                    <div class="absolute top-2 right-2 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                        ${allocation?.quick_wins || '50%'}
                                    </div>
                                    <h4 class="font-bold text-green-800 text-lg mb-2">ğŸš€ å¿«é€Ÿè‡´å‹</h4>
                                    <p class="text-xs text-green-700 mb-3">é«˜å½±éŸ¿ Ã— é«˜å¯è¡Œæ€§</p>
                                    ${matrix.quick_wins?.length > 0 ? `
                                    <div class="space-y-2">
                                        ${matrix.quick_wins.map((item, idx) => `
                                            <div class="bg-white p-3 rounded-lg border border-green-200">
                                                <p class="font-semibold text-sm text-green-900">${idx + 1}. ${item.initiative}</p>
                                                <div class="flex gap-2 mt-2">
                                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">å½±éŸ¿ ${item.impact}/10</span>
                                                    <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">å¯è¡Œ ${item.feasibility}/10</span>
                                                </div>
                                                <p class="text-xs text-gray-600 mt-2">${item.why_quick_win}</p>
                                                ${item.estimated_timeline ? `<p class="text-xs text-green-600 mt-1">â±ï¸ ${item.estimated_timeline}</p>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                    ` : '<p class="text-xs text-gray-500">æš«ç„¡é …ç›®</p>'}
                                </div>
                                
                                <!-- æˆ°ç•¥è³­æ³¨ (å·¦ä¸Š) -->
                                <div class="bg-yellow-50 p-5 rounded-xl border-2 border-yellow-500 relative">
                                    <div class="absolute top-2 right-2 bg-yellow-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                        ${allocation?.big_bets || '30%'}
                                    </div>
                                    <h4 class="font-bold text-yellow-800 text-lg mb-2">ğŸ¯ æˆ°ç•¥è³­æ³¨</h4>
                                    <p class="text-xs text-yellow-700 mb-3">é«˜å½±éŸ¿ Ã— ä½å¯è¡Œæ€§</p>
                                    ${matrix.big_bets?.length > 0 ? `
                                    <div class="space-y-2">
                                        ${matrix.big_bets.map((item, idx) => `
                                            <div class="bg-white p-3 rounded-lg border border-yellow-200">
                                                <p class="font-semibold text-sm text-yellow-900">${idx + 1}. ${item.initiative}</p>
                                                <div class="flex gap-2 mt-2">
                                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">å½±éŸ¿ ${item.impact}/10</span>
                                                    <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">å¯è¡Œ ${item.feasibility}/10</span>
                                                </div>
                                                <p class="text-xs text-gray-600 mt-2">${item.why_big_bet}</p>
                                                ${item.key_challenges ? `<p class="text-xs text-red-600 mt-1">âš ï¸ æŒ‘æˆ°ï¼š${item.key_challenges}</p>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                    ` : '<p class="text-xs text-gray-500">æš«ç„¡é …ç›®</p>'}
                                </div>
                                
                                <!-- å¡«å……é …ç›® (å³ä¸‹) -->
                                <div class="bg-blue-50 p-5 rounded-xl border-2 border-blue-400 relative">
                                    <div class="absolute top-2 right-2 bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                        ${allocation?.fill_ins || '15%'}
                                    </div>
                                    <h4 class="font-bold text-blue-800 text-lg mb-2">ğŸ“ å¡«å……é …ç›®</h4>
                                    <p class="text-xs text-blue-700 mb-3">ä½å½±éŸ¿ Ã— é«˜å¯è¡Œæ€§</p>
                                    ${matrix.fill_ins?.length > 0 ? `
                                    <div class="space-y-2">
                                        ${matrix.fill_ins.slice(0, 3).map((item, idx) => `
                                            <div class="bg-white p-2 rounded-lg border border-blue-200">
                                                <p class="text-xs text-blue-900">${idx + 1}. ${item.initiative}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ` : '<p class="text-xs text-gray-500">æš«ç„¡é …ç›®</p>'}
                                </div>
                                
                                <!-- é‡‘éŒ¢é™·é˜± (å·¦ä¸‹) -->
                                <div class="bg-gray-100 p-5 rounded-xl border-2 border-gray-400 relative">
                                    <div class="absolute top-2 right-2 bg-gray-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                        ${allocation?.money_pits || '5%'}
                                    </div>
                                    <h4 class="font-bold text-gray-800 text-lg mb-2">â›” é‡‘éŒ¢é™·é˜±</h4>
                                    <p class="text-xs text-gray-700 mb-3">ä½å½±éŸ¿ Ã— ä½å¯è¡Œæ€§</p>
                                    ${matrix.money_pits?.length > 0 ? `
                                    <div class="space-y-2">
                                        ${matrix.money_pits.slice(0, 2).map((item, idx) => `
                                            <div class="bg-white p-2 rounded-lg border border-gray-300">
                                                <p class="text-xs text-gray-700">${item.initiative}</p>
                                                <p class="text-xs text-red-600 mt-1">âŒ ${item.why_avoid}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ` : '<p class="text-xs text-green-600">âœ… ç„¡éœ€é¿å…çš„é …ç›®</p>'}
                                </div>
                            </div>
                            
                            <!-- ç­–ç•¥çµ„åˆè¨ºæ–·èˆ‡è³‡æºé…ç½® -->
                            <div class="bg-white p-5 rounded-xl border border-michigan-blue/20 mt-4">
                                <h5 class="font-bold text-michigan-blue mb-2">ğŸ’¼ ç­–ç•¥çµ„åˆè¨ºæ–·èˆ‡è³‡æºé…ç½®</h5>
                                <div class="flex flex-wrap gap-2 mb-3 text-[11px]">
                                    <span class="px-2 py-1 rounded-full bg-michigan-blue-lightest text-michigan-blue border border-michigan-blue/30">ç­–ç•¥é¢¨æ ¼ï¼šç©©å¥è½‰å‹ï¼ˆBalanced Transformation Portfolioï¼‰</span>
                                    <span class="px-2 py-1 rounded-full bg-green-50 text-green-700 border border-green-200">é¢¨éšªå–å‘ï¼šä¸­åº¦ã€å¯æ§å¯¦é©—ï¼ˆManaged Experimentationï¼‰</span>
                                    <span class="px-2 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-200">æ²»ç†ç„¦é»ï¼šè³‡æºå†åˆ†é…èˆ‡æ±ºç­–ç¯€å¥ï¼ˆResource Rebalancing & Governance Cadenceï¼‰</span>
                                </div>
                                <p class="text-sm text-gray-800 mb-3 leading-relaxed">
                                    æ ¹æ“šåŸ·è¡Œå„ªå…ˆç´šçŸ©é™£èˆ‡è¡Œå‹•çµ„åˆï¼ŒAI å»ºè­°ç›®å‰æ•´é«”è³‡æºå¤§è‡´é…ç½®ç‚ºï¼š
                                    <strong>${allocation?.quick_wins || '50%'}</strong> ç”¨æ–¼ã€Œå¿«é€Ÿè‡´å‹ã€ã€
                                    <strong>${allocation?.big_bets || '30%'}</strong> ç”¨æ–¼ã€Œæˆ°ç•¥è³­æ³¨ã€ã€
                                    <strong>${allocation?.fill_ins || '15%'}</strong> ä½œç‚ºã€Œå¡«å……é …ç›®ã€ï¼Œä¸¦ç›¡é‡å°‡ã€Œé‡‘éŒ¢é™·é˜±ã€æ§åˆ¶åœ¨
                                    <strong>${allocation?.money_pits || '5%'}</strong> ä»¥ä¸‹ã€‚æ­¤çµ„åˆä»£è¡¨çµ„ç¹”åœ¨ã€Œç©©å¥ä¿®è£œé—œéµç—›é»ã€èˆ‡ã€Œä¸­æœŸæˆé•·æŠ•è³‡ã€ä¹‹é–“å–å¾—ç›¸å°å¹³è¡¡ã€‚
                                </p>
                                <ul class="list-disc list-inside text-xs text-gray-700 space-y-1">
                                    <li><strong>çŸ­æœŸè§€é»ï¼š</strong>è¼ƒé«˜æ¯”ä¾‹çš„ã€Œå¿«é€Ÿè‡´å‹ã€æœ‰åŠ©æ–¼åœ¨è½‰å‹åˆæœŸï¼Œé€éå¯è¦‹æˆæœå¿«é€Ÿå›æ‡‰ç—›é»ã€å»ºç«‹å…§éƒ¨ä¿¡ä»»èˆ‡å­¸ç¿’å‹•èƒ½ã€‚</li>
                                    <li><strong>ä¸­æœŸè§€é»ï¼š</strong>ã€Œæˆ°ç•¥è³­æ³¨ã€è³‡æºæ‡‰èšç„¦åœ¨å°‘æ•¸é—œéµä¸»é¡Œï¼Œä¾‹å¦‚æ–°å•†æ¥­æ¨¡å¼é©—è­‰ã€æ•¸æ“šåŒ–èƒ½åŠ›å»ºæ§‹æˆ–é—œéµäººæ‰åŸ¹è‚²ï¼Œä¸¦æ­é…æ˜ç¢ºçš„å¯¦é©—è¨­è¨ˆèˆ‡è©•ä¼°ç¯€é»ã€‚</li>
                                    <li><strong>ç‡Ÿé‹ç©©å®šï¼š</strong>ã€Œå¡«å……é …ç›®ã€å¯ç”¨ä¾†ç¶­è­·æ—¢æœ‰ç‡Ÿé‹èˆ‡æµç¨‹å„ªåŒ–ï¼Œé¿å…åœ¨è¿½æ±‚å‰µæ–°æ™‚çŠ§ç‰²ç¾æœ‰å®¢æˆ¶é«”é©—èˆ‡ç²åˆ©èƒ½åŠ›ã€‚</li>
                                    <li><strong>é¢¨éšªæ§ç®¡ï¼š</strong>è‹¥å¯¦éš›åŸ·è¡Œä¸­ã€Œé‡‘éŒ¢é™·é˜±ã€æ¯”ä¾‹æŒçºŒé«˜æ–¼å»ºè­°å€¼ï¼Œä»£è¡¨ç›®å‰æŠ•è³‡çµ„åˆä¸­å¯èƒ½å­˜åœ¨å ±é…¬ä¸æ˜æˆ–èˆ‡ç­–ç•¥ä¸»è»¸åé›¢çš„é …ç›®ï¼Œå»ºè­°å®šæœŸæª¢è¦–ä¸¦æœæ–·åœæ­¢æˆ–èª¿æ•´ã€‚</li>
                                </ul>
                            </div>
                        <!-- ç«‹å³è¡Œå‹• -->
                        <div class="bg-green-50 p-5 rounded-lg border-l-4 border-green-500">
                            <h4 class="font-bold text-green-800 text-lg mb-3">ğŸš€ ç«‹å³è¡Œå‹•ï¼ˆ30å¤©å…§ï¼‰</h4>
                            ${data.immediate_actions?.length > 0 ? `
                            <div class="space-y-2">
                                ${data.immediate_actions.map((a, idx) => `
                                    <div class="bg-white p-3 rounded-lg border border-green-200">
                                        <div class="flex items-start gap-2">
                                            <span class="bg-green-600 text-white font-bold px-2 py-1 rounded text-xs flex-shrink-0">${idx + 1}</span>
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800">${a.action}</p>
                                                <div class="flex gap-3 mt-1 text-xs text-gray-600">
                                                    ${a.owner ? `<span>ğŸ‘¤ ${a.owner}</span>` : ''}
                                                    ${a.deadline ? `<span>ğŸ“… ${a.deadline}</span>` : ''}
                                                    ${a.from_category ? `<span class="text-green-600">ä¾†è‡ªï¼š${a.from_category}</span>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : '<p class="text-gray-500">æš«ç„¡ç«‹å³è¡Œå‹•é …ç›®</p>'}
                        </div>
                        
                        <!-- å­£åº¦è·¯ç·šåœ– -->
                        <div class="bg-white p-5 rounded-lg border">
                            <h4 class="font-bold text-michigan-blue text-lg mb-3">ğŸ—ºï¸ å­£åº¦åŸ·è¡Œè·¯ç·šåœ–</h4>
                            ${data.quarterly_roadmap?.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                ${data.quarterly_roadmap.map(q => `
                                    <div class="bg-michigan-blue-lightest p-4 rounded-lg">
                                        <h5 class="font-bold text-michigan-blue mb-1">${q.quarter}</h5>
                                        <p class="text-sm text-gray-700 mb-2">${q.focus}</p>
                                        ${q.quick_wins_count ? `<p class="text-xs text-green-600">ğŸš€ å¿«é€Ÿè‡´å‹ ${q.quick_wins_count} é …</p>` : ''}
                                        ${q.big_bets_progress ? `<p class="text-xs text-yellow-600 mt-1">ğŸ¯ ${q.big_bets_progress}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ` : '<p class="text-gray-500">æš«ç„¡è·¯ç·šåœ–</p>'}
                        </div>
                        
                                                <!-- AI é¡§å•è¦–è§’å°çµ -->
                        <div class="bg-michigan-blue-lightest/60 p-4 rounded-xl border border-michigan-blue/30">
                            <h4 class="font-bold text-michigan-blue text-sm mb-2">ğŸ“Œ AI é¡§å•è¦–è§’å°çµ</h4>
                            <ul class="list-disc list-inside text-xs text-gray-800 space-y-1 leading-relaxed">
                                <li>ç›®å‰ç­–ç•¥çµ„åˆå‘ˆç¾å‡º<strong>ã€Œå…ˆç©©å®šæ ¸å¿ƒåƒ¹å€¼ï¼Œå†é€éæœ‰ç´€å¾‹å¯¦é©—æ¢ç´¢æ–°æˆé•·æ›²ç·šã€</strong>çš„æ¼¸é€²å¼è½‰å‹è·¯å¾‘ï¼Œé©åˆè™•æ–¼å“ç‰Œã€å…§éƒ¨èƒ½åŠ›èˆ‡å•†æ¥­æ¨¡å¼åŒæ™‚éœ€è¦æ ¡æº–çš„çµ„ç¹”ã€‚</li>
                                <li>è‹¥è‘£äº‹æœƒæˆ–é«˜éšç®¡ç†åœ˜éšŠæœŸå¾…æ›´ç©æ¥µçš„æˆé•·æ–œç‡ï¼Œå¯åœ¨å¹´åº¦é ç®—èˆ‡å°ˆæ¡ˆæª¢è¨ç¯€å¥ä¸­ï¼Œæœ‰æ„è­˜åœ°å°‡éƒ¨åˆ†ã€Œå¡«å……é …ç›®ã€èˆ‡ä½æ•ˆæŠ•è³‡ï¼Œé‡é…ç½®åˆ°ç¶“éåˆæ­¥é©—è­‰çš„ã€Œæˆ°ç•¥è³­æ³¨ã€èˆ‡æ–°å•†æ¥­æ¨¡å¼å¯¦é©—ã€‚</li>
                                <li>å»ºè­°å°‡æœ¬é çš„è¡Œå‹•èˆ‡è³‡æºé…ç½®ç´å…¥å¹´åº¦ PMOï¼ç­–ç•¥åŸ·è¡Œä¾‹æœƒï¼Œé€éå­£ç¯€æ€§æª¢è¦–èˆ‡æ•¸æ“šå›é¥‹ï¼Œé€æ­¥å½¢æˆé©åˆæœ¬ä¼æ¥­æƒ…å¢ƒçš„ã€Œç­–ç•¥åŸ·è¡Œèˆ‡å­¸ç¿’å„€è¡¨æ¿ã€ã€‚</li>
                            </ul>
                        </div>

                        <!-- ä¸‰æ§‹é¢è¨ºæ–·è¦–è§’ -->
                        <div class="bg-white p-5 rounded-xl border border-dashed border-michigan-blue/30">
                            <h4 class="font-bold text-michigan-blue text-sm mb-3">ğŸ“Š é¡§å®¢åƒ¹å€¼ãƒ»å…§éƒ¨èƒ½åŠ›ãƒ»å•†æ¥­æ¨¡å¼ä¸‰æ§‹é¢</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs text-gray-800">
                                <div>
                                    <h5 class="font-bold mb-1">é¡§å®¢åƒ¹å€¼ï¼ˆValue Propositionï¼‰</h5>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>å¾ SCAMPER èˆ‡è—æµ·ç­–ç•¥èƒå–å…·å·®ç•°åŒ–çš„å“ç‰Œæ‰¿è«¾èˆ‡é«”é©—ä¸»å¼µã€‚</li>
                                        <li>æª¢è¦–é—œéµç—›é»æ˜¯å¦è¢«å…·é«”å°æ‡‰åˆ°ã€Œå¿«é€Ÿè‡´å‹ã€èˆ‡çŸ­æœŸè¡Œå‹•ä¸­ã€‚</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-bold mb-1">å…§éƒ¨èƒ½åŠ›ï¼ˆOperating Modelï¼‰</h5>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>é‹ç”¨è¨­è¨ˆæ€ç¶­èˆ‡ç²¾å¯¦å‰µæ¥­çš„è¿­ä»£æ©Ÿåˆ¶ï¼Œå¼·åŒ–è·¨éƒ¨é–€å”ä½œèˆ‡å­¸ç¿’å¾ªç’°ã€‚</li>
                                        <li>è©•ä¼°äººæ‰æ§‹æˆã€æµç¨‹èˆ‡æ²»ç†æ©Ÿåˆ¶æ˜¯å¦æ”¯æ’ä¸­æœŸæˆ°ç•¥è³­æ³¨èˆ‡æˆé•·ç›®æ¨™ã€‚</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-bold mb-1">å•†æ¥­æ¨¡å¼ï¼ˆBusiness Modelï¼‰</h5>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>æª¢æŸ¥æ”¶å…¥ä¾†æºã€æˆæœ¬çµæ§‹èˆ‡é—œéµå¤¥ä¼´æ˜¯å¦èˆ‡é•·æœŸé¡˜æ™¯èˆ‡å“ç‰Œå®šä½ä¸€è‡´ã€‚</li>
                                        <li>æ€è€ƒå“ªäº›å‰µæ–°æ§‹æƒ³å¯é€²ä¸€æ­¥ç”¢å“åŒ–ã€å¹³å°åŒ–æˆ–æœå‹™åŒ–ï¼Œå½¢æˆå¯æ“´å¼µçš„æˆé•·å¼•æ“ã€‚</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

<!-- é•·æœŸé¡˜æ™¯ -->
                        <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize">
                            <h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸ”® é•·æœŸé¡˜æ™¯ï¼ˆ1-3å¹´ï¼‰</h4>
                            <p class="text-gray-800 leading-relaxed">${data?.long_term_vision || ''}</p>
                        </div>
                    </div>
                `;
            } else {
                // èˆŠç‰ˆï¼šå‘ä¸‹ç›¸å®¹æ¸²æŸ“
                container.innerHTML = `<div class="space-y-6"> <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize"><h4 class="font-bold text-michigan-blue text-lg mb-2">æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h4><p class="text-gray-800">${data?.strategic_insight || ''}</p></div> <div class="bg-michigan-blue-lightest p-5 rounded-lg border-l-4 border-michigan-blue"><h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸš€ ç«‹å³è¡Œå‹• (30å¤©å…§)</h4><ul class="list-disc list-inside text-gray-800 space-y-1">${(data?.immediate_actions || []).map(a => `<li>${(typeof a === 'object' && a !== null) ? Object.values(a).join('ï¼š ') : a}</li>`).join('')}</ul></div> <div class="bg-white p-5 rounded-lg border"><h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸ—ºï¸ å­£åº¦åŸ·è¡Œè·¯ç·šåœ–</h4><div class="space-y-2">${(data?.quarterly_roadmap || []).map(q => `<div><strong class="text-michigan-blue">${q.quarter}:</strong> ${q.focus}</div>`).join('')}</div></div> <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize"><h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸ”® é•·æœŸé¡˜æ™¯</h4><p class="text-gray-800">${data?.long_term_vision || ''}</p></div> </div>`;
            }

        
                function buildFinalSummaryHeader(finalData) {
            try {
                const ctx = (window.diagnosisData && diagnosisData.context) ? diagnosisData.context : {};
                const results = (window.diagnosisData && diagnosisData.analysisResults) ? diagnosisData.analysisResults : {};
                const selected = (window.diagnosisData && Array.isArray(diagnosisData.selectedModels))
                    ? diagnosisData.selectedModels
                    : Object.keys(results || {});

                const models = selected.map(function(id) {
                    var meta = (typeof window.availableModels !== 'undefined' && Array.isArray(availableModels))
                        ? availableModels.find(function(m) { return m.id === id; })
                        : null;
                    return {
                        id: id,
                        name: meta ? meta.name : id,
                        result: results[id] || {}
                    };
                });

                function escapeHTML(str) {
                    return String(str || '').replace(/[&<>"]/g, function (s) {
                        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' })[s] || s;
                    });
                }

                function safeText(txt, fallback) {
                    if (fallback === void 0) fallback = '';
                    return (typeof txt === 'string' && txt.trim().length > 0) ? txt.trim() : fallback;
                }

                var overviewHtml = [
                    '<section class="mb-6">',
                    '  <div class="bg-white p-5 rounded-lg border flex flex-col md:flex-row md:items-center md:justify-between gap-4">',
                    '    <div>',
                    '      <h3 class="text-lg font-bold text-michigan-blue mb-1">ğŸ“˜ å°ˆæ¡ˆæ¦‚è¦</h3>',
                    '      <p class="text-sm text-gray-700 mb-1"><span class="font-semibold">ç”¢æ¥­ï¼š</span>' + escapeHTML(ctx.industry || 'æœªå¡«å¯«') + '</p>',
                    '      <p class="text-sm text-gray-700 mb-1"><span class="font-semibold">å…¬å¸è¦æ¨¡ï¼š</span>' + escapeHTML(ctx.companySize || 'æœªå¡«å¯«') + '</p>',
                    '      <p class="text-sm text-gray-700 mb-1"><span class="font-semibold">å•†æ¥­æ¨¡å¼ï¼š</span>' + escapeHTML(ctx.businessModel || 'æœªå¡«å¯«') + '</p>',
                    '    </div>',
                    '    <div class="bg-michigan-blue-lightest rounded-lg p-4 md:w-1/2">',
                    '      <h4 class="text-sm font-semibold text-michigan-blue mb-1">ğŸ¯ æœ¬æ¬¡è¨ºæ–·èšç„¦æŒ‘æˆ°</h4>',
                    '      <p class="text-sm text-gray-800 leading-snug">' + escapeHTML(ctx.problemDescription || 'å°šæœªè¼¸å…¥å…·é«”æŒ‘æˆ°èªªæ˜ã€‚') + '</p>',
                    '    </div>',
                    '  </div>',
                    '</section>'
                ].join('\n');

                var modelSummaryCards = models.map(function(m) {
                    var r = m.result || {};
                    var summary =
                        safeText(r.summary_insight) ||
                        safeText(r.strategic_insights) ||
                        safeText(r.core_insight) ||
                        '';
                    if (!summary) {
                        summary = 'æ­¤æ¨¡å‹å·²å®Œæˆåˆ†æï¼Œè©³ç´°å…§å®¹è«‹è¦‹ä¸‹è¼‰å ±å‘Šæˆ–å‰ä¸€éšæ®µåˆ†æå„€è¡¨æ¿ã€‚';
                    }
                    if (summary.length > 160) {
                        summary = summary.slice(0, 160) + 'â€¦';
                    }
                    return [
                        '<div class="bg-white p-4 rounded-lg border">',
                        '  <h4 class="text-sm font-bold text-michigan-blue mb-1">ğŸ” ' + escapeHTML(m.name) + '</h4>',
                        '  <p class="text-xs text-gray-700 leading-snug">' + escapeHTML(summary) + '</p>',
                        '</div>'
                    ].join('\n');
                }).join('\n');

                var modelsHtml = models.length ? [
                    '<section class="mb-6">',
                    '  <div class="flex items-center justify-between mb-2">',
                    '    <h3 class="text-lg font-bold text-michigan-blue">ğŸ“Š æ¨¡å‹åˆ†æç¸½è¦½</h3>',
                    '    <p class="text-xs text-gray-500">æœ¬æ¬¡å…±ä½¿ç”¨ ' + models.length + ' å€‹åˆ†ææ¨¡å‹</p>',
                    '  </div>',
                    '  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">',
                    modelSummaryCards,
                    '  </div>',
                    '</section>'
                ].join('\n') : '';

                var modelDetailCards = models.map(function(m) {
                    var r = m.result || {};
                    var main =
                        safeText(r.summary_insight) ||
                        safeText(r.strategic_insights) ||
                        safeText(r.core_insight) ||
                        '';
                    var extra =
                        safeText(r.detailed_insight) ||
                        safeText(r.detailed_summary) ||
                        safeText(r.full_analysis);
                    var combined = main;
                    if (extra && extra !== main) {
                        combined = combined ? (combined + '\n\n' + extra) : extra;
                    }
                    if (!combined) {
                        combined = 'æ­¤æ¨¡å‹çš„è©³ç´°å…§å®¹å¯æ–¼åˆ†æå„€è¡¨æ¿æˆ–ä¸‹è¼‰å ±å‘Šä¸­æŸ¥çœ‹ï¼Œå»ºè­°ç¾å ´ä¾å¯¦éš›æƒ…æ³è£œå……èªªæ˜ã€‚';
                    }
                    return [
                        '<div class="bg-white p-4 rounded-lg border shadow-sm">',
                        '  <h4 class="text-sm font-bold text-michigan-blue mb-2">ğŸ” ' + escapeHTML(m.name) + ' â€” è©³ç´°èªªæ˜</h4>',
                        '  <p class="text-xs text-gray-700 leading-relaxed whitespace-pre-line">' + escapeHTML(combined) + '</p>',
                        '</div>'
                    ].join('\n');
                }).join('\n');

                var modelDetailsHtml = models.length ? [
                    '<section class="mb-8">',
                    '  <h3 class="text-lg font-bold text-michigan-blue mb-1">ğŸ“‚ å„æ¨¡å‹é‡é»è§£æï¼ˆç¾å ´èªªæ˜ç‰ˆï¼‰</h3>',
                    '  <p class="text-xs text-gray-500 mb-3">æ­¤å€å¡ŠåŒ¯æ•´æ¯å€‹æ¨¡å‹çš„å®Œæ•´é‡é»ï¼Œå¯åœ¨èˆ‡æ±ºç­–é«˜å±¤æˆ–å®¢æˆ¶è¨è«–æ™‚é€ä¸€è¬›è§£ã€‚</p>',
                    '  <div class="space-y-3">',
                    modelDetailCards,
                    '  </div>',
                    '</section>'
                ].join('\n') : '';

                var modelNames = models.map(function(m) { return m.name; }).join('ã€') || 'å¤šç¨®è¨ºæ–·æ¨¡å‹';
                var strategicLine =
                    safeText(finalData && finalData.strategic_insight) ||
                    ('ç¶œåˆ ' + modelNames + ' çš„å¯©è¦–çµæœï¼Œæœ¬æ¬¡è¨ºæ–·å·²å‹¾å‹’å‡ºå„ªå…ˆè™•ç†çš„å•é¡Œå€å¡Šèˆ‡è³‡æºé…ç½®æ–¹å‘ï¼Œå»ºè­°ä½œç‚ºæœªä¾† 3â€“12 å€‹æœˆç­–ç•¥è¦åŠƒèˆ‡å°ˆæ¡ˆè¨­è¨ˆçš„ä¾æ“šã€‚');

                var crossInsightHtml = [
                    '<section class="mb-8">',
                    '  <div class="bg-michigan-blue-lightest p-4 rounded-lg border-l-4 border-michigan-blue">',
                    '    <h3 class="text-lg font-bold text-michigan-blue mb-1">ğŸ§  è·¨æ¨¡å‹æ•´åˆæ´å¯Ÿ</h3>',
                    '    <p class="text-sm text-gray-800 leading-relaxed">' + escapeHTML(strategicLine) + '</p>',
                    '  </div>',
                    '</section>'
                ].join('\n');

                return [
                    '<div class="mb-6 space-y-6">',
                    overviewHtml,
                    modelsHtml,
                    modelDetailsHtml,
                    crossInsightHtml,
                    '</div>'
                ].join('\n');
            } catch (e) {
                console.warn('buildFinalSummaryHeader ç™¼ç”ŸéŒ¯èª¤', e);
                return '';
            }
        }

        function renderFinalRecommendations(data) {
            renderFinalRecommendationsCore(data);
            try {
                const container = document.getElementById('final-recommendations');
                if (!container) return;
                const header = buildFinalSummaryHeader(data);
                if (header && header.trim().length > 0) {
                    container.innerHTML = header + container.innerHTML;
                }
            } catch (e) {
                console.warn('renderFinalRecommendations wrapper ç™¼ç”ŸéŒ¯èª¤', e);
            }
        }

        }
        
        function renderErrorCard(modelId, message) {
            const model = availableModels.find(m => m.id === modelId);
            const container = document.createElement('div');
            container.className = 'bg-red-100 p-6 rounded-xl border-l-4 border-red-500 card-shadow';
            container.innerHTML = `<h4 class="font-bold text-red-800 text-xl">${model.name} åˆ†æå¤±æ•—</h4> <p class="text-red-700 mt-2">åŸå› ï¼š${message}</p> <p class="text-red-600 text-sm mt-2">å»ºè­°ï¼šè«‹æª¢æŸ¥API Keyè¨­å®šæˆ–ç¶²è·¯é€£ç·šï¼Œæˆ–ç°¡åŒ–å•é¡Œæè¿°å¾Œé‡è©¦ã€‚</p>`;
            document.getElementById('analysis-dashboard').appendChild(container);
        }
        
        function renderFinalRecommendationsError(message) {
            const container = document.getElementById('final-recommendations');
            container.innerHTML = `<div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-500"><h4 class="font-bold text-red-800">æ•´åˆè¨ºæ–·å ±å‘Šç”Ÿæˆå¤±æ•—</h4><p class="text-sm text-red-700 mt-1">åŸå› ï¼š${message}</p></div>`;
        }
        
        function giveFeedback(button, modelId, rating) {
            console.log(`Feedback for ${modelId}: ${rating}`);
            const parent = button.parentElement;
            parent.querySelectorAll('.feedback-button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }

        function safeJSONParse(rawString) {
            try { 
                return JSON.parse(rawString); 
            } catch (e1) {
                try {
                    // å˜—è©¦æå– ```json``` å€å¡Š
                    const match = rawString.match(/```json\s*([\s\S]*?)\s*```/);
                    if (match && match[1]) return JSON.parse(match[1]);
                    
                    // å˜—è©¦æå–ç¬¬ä¸€å€‹å®Œæ•´ JSON ç‰©ä»¶
                    const start = rawString.indexOf('{');
                    const end = rawString.lastIndexOf('}');
                    if (start > -1 && end > -1) {
                        let jsonStr = rawString.substring(start, end + 1);
                        
                        // å¸¸è¦‹éŒ¯èª¤ä¿®å¾©
                        // 1. ç§»é™¤å¤šé¤˜çš„é€—è™Ÿï¼ˆç‰©ä»¶/é™£åˆ—æœ«å°¾ï¼‰
                        jsonStr = jsonStr.replace(/,\s*([}\]])/g, '$1');
                        
                        // 2. ç§»é™¤æ§åˆ¶å­—å…ƒ
                        jsonStr = jsonStr.replace(/[\x00-\x1F\x7F]/g, '');
                        
                        // 3. å†æ¬¡å˜—è©¦è§£æ
                        return JSON.parse(jsonStr);
                    }
                    
                    throw new Error("åœ¨å­—ä¸²ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„JSONã€‚");
                } catch (e2) {
                    console.error("JSON è§£æéŒ¯èª¤:", e2);
                    console.error("éŒ¯èª¤è¨Šæ¯:", e2.message);
                    console.error("åŸå§‹å­—ä¸²é•·åº¦:", rawString.length);
                    console.error("åŸå§‹å­—ä¸²å‰ 500 å­—:", rawString.substring(0, 500));
                    console.error("åŸå§‹å­—ä¸²å¾Œ 500 å­—:", rawString.substring(Math.max(0, rawString.length - 500)));
                    
                    // å˜—è©¦æ‰¾åˆ°éŒ¯èª¤ä½ç½®é™„è¿‘çš„å…§å®¹
                    const errorMatch = e2.message.match(/position (\d+)/);
                    if (errorMatch) {
                        const pos = parseInt(errorMatch[1]);
                        console.error("éŒ¯èª¤ä½ç½®é™„è¿‘:", rawString.substring(Math.max(0, pos - 100), Math.min(rawString.length, pos + 100)));
                    }
                    
                    return { 
                        error: true, 
                        message: `AI å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æã€‚éŒ¯èª¤: ${e2.message}` 
                    };
                }
            }
        }
        // Phase 2A: ç«¶çˆ­ç­–ç•¥å»ºè­°å ±å‘Šç”Ÿæˆå‡½æ•¸
        function generateCompetitiveStrategyReport(cs) {
            let html = `
                <div class="section" style="background:#f8f9ff;padding:20px;border-radius:10px;margin-top:20px">
                    <h4 style="color:#4c51bf;margin-top:0">ğŸ¯ ç«¶çˆ­ç­–ç•¥å»ºè­°</h4>
                    
                    <!-- æ¨è–¦ç­–ç•¥ -->
                    <div style="background:#fff;padding:15px;border-radius:8px;border-left:4px solid #4c51bf;margin-bottom:15px">
                        <h5 style="color:#4c51bf;margin:0 0 10px 0">ğŸ’¡ æ¨è–¦ç­–ç•¥</h5>
                        <p style="font-size:1.1em;font-weight:bold;margin:0">${cs.recommended_strategy}</p>
                    </div>
                    
                    <!-- ä¸‰å¤§ç­–ç•¥è©•ä¼° -->
                    <h5 style="color:#333;margin-top:20px">ğŸ“Š æ³¢ç‰¹ä¸‰å¤§åŸºæœ¬ç­–ç•¥è©•ä¼°</h5>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px">
            `;
            
            (cs.porter_generic_strategies || []).forEach(strategy => {
                const feasibilityColor = 
                    strategy.feasibility === 'é«˜' ? '#10b981' :
                    strategy.feasibility === 'ä¸­' ? '#f59e0b' : '#ef4444';
                
                html += `
                    <div style="background:#fff;padding:15px;border-radius:8px;border:1px solid #e5e7eb">
                        <h6 style="color:#1f2937;margin:0 0 10px 0">${strategy.strategy}</h6>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                            <span style="color:#6b7280;font-size:0.9em">é©åˆåº¦</span>
                            <span style="font-size:1.5em;font-weight:bold;color:#4c51bf">${strategy.score}/10</span>
                        </div>
                        <div style="margin-bottom:10px">
                            <span style="color:#6b7280;font-size:0.9em">å¯è¡Œæ€§ï¼š</span>
                            <span style="background:${feasibilityColor};color:#fff;padding:3px 8px;border-radius:4px;font-size:0.85em;font-weight:600">
                                ${strategy.feasibility}
                            </span>
                        </div>
                        <p style="font-size:0.9em;color:#6b7280;margin:0">${strategy.reason}</p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <!-- å‰ 3 å¤§é—œéµè¡Œå‹• -->
                    <h5 style="color:#333;margin-top:20px">ğŸš€ å‰ 3 å¤§é—œéµè¡Œå‹•å»ºè­°</h5>
                    <div style="margin-top:15px">
            `;
            
            (cs.top_3_actions || []).forEach((action, idx) => {
                html += `
                    <div style="background:#fff;padding:15px;border-radius:8px;border-left:4px solid #6366f1;margin-bottom:12px">
                        <h6 style="color:#1f2937;margin:0 0 8px 0">${idx + 1}. ${action.action}</h6>
                        <p style="font-size:0.9em;color:#6b7280;margin:0 0 8px 0">
                            <strong style="color:#4c51bf">ç­–ç•¥ä¾æ“šï¼š</strong>${action.strategic_basis}
                        </p>
                        <p style="font-size:0.9em;color:#6b7280;margin:0">
                            <strong style="color:#10b981">é æœŸæˆæœï¼š</strong>${action.expected_outcome}
                        </p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        
        function generateReport() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const currentDate = new Date().toLocaleDateString('zh-TW');
            const fileName = `A2PSDM_æˆ°ç•¥è¨ºæ–·å ±å‘Š_${currentDate.replace(/\//g, '')}`;
            const companyName = diagnosisData.context?.industry ? `${diagnosisData.context.industry}ä¼æ¥­` : 'ç›®æ¨™ä¼æ¥­';
            
            showLoading('æ­£åœ¨ç”¢ç”Ÿå ±å‘Š...');

            let htmlContent = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>${fileName}</title><style>body{font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;line-height:1.8;padding:40px;padding-top:100px;max-width:1000px;margin:auto;color:#333;background:#fdfdfd}.print-btn-container{position:fixed;top:0;left:0;width:100%;background:rgba(0,39,76,0.9);padding:15px;text-align:center;z-index:1000;border-bottom:4px solid #FFCB05;box-shadow:0 4px 10px rgba(0,0,0,0.2)}.print-btn{background:#FFCB05;color:#00274C;font-weight:bold;padding:15px 30px;border-radius:10px;border:none;cursor:pointer;font-size:18px;transition:all 0.3s ease}.print-btn:hover{background:#FFF2A6}.header{text-align:center;border-bottom:4px solid #00274c;padding-bottom:30px;margin-bottom:40px}.header h1{color:#00274c;font-size:2.5em;margin-bottom:10px}.header .subtitle{color:#ffcb05;background:#00274c;padding:8px 20px;display:inline-block;border-radius:20px;font-weight:700}.meta-info{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px;border-left:5px solid #ffcb05}.section{margin-bottom:40px;page-break-inside:avoid}.section h2{color:#00274c;border-bottom:2px solid #ffcb05;padding-bottom:10px;margin-bottom:20px;font-size:1.8em}.section h3{color:#00274c;margin-top:25px;margin-bottom:15px;font-size:1.5em;border-left:4px solid #00274c;padding-left:10px}.section h4{color:#00274c;margin-top:20px;margin-bottom:10px;font-size:1.2em;font-weight:700}.section h5{color:#333;margin:10px 0 5px;font-size:1em;font-weight:700}.executive-summary{background:linear-gradient(135deg,#e8f0f7,#f0f8ff);padding:25px;border-radius:15px;border:1px solid #00274c;margin-bottom:30px}.analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}.analysis-card{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:20px;box-shadow:0 4px 8px #0000000d}.swot-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0}.swot-card{padding:15px;border-radius:8px;border-left:5px solid}.swot-strengths{background:#d4edda;border-left-color:#28a745}.swot-weaknesses{background:#f8d7da;border-left-color:#dc3545}.swot-opportunities{background:#d1ecf1;border-left-color:#17a2b8}.swot-threats{background:#fff3cd;border-left-color:#ffc107}.recommendation-box{background:linear-gradient(135deg,#fff2a6,#ffcb05);padding:20px;border-radius:10px;margin:15px 0;border:1px solid #00274c}.action-item{background:#f8f9fa;padding:15px;margin:10px 0;border-left:4px solid #00274c;border-radius:5px}ul,ol{padding-left:25px;margin:10px 0}li{margin-bottom:8px;line-height:1.6}.footer{margin-top:50px;padding-top:30px;border-top:2px solid #00274c;text-align:center;color:#666}.page-break{page-break-before:always}@media print{.print-btn-container{display:none}body{padding:40px !important}}</style></head><body>`;

            if (isMobile) {
                htmlContent += `<div class="print-btn-container"><button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ å„²å­˜ç‚º PDF</button></div>`;
            }

            htmlContent += `<div class="header"><h1>AI æˆ°ç•¥è¨ºæ–·å ±å‘Š</h1><div class="subtitle">A2PSDM Ã— ç‹åšå£« Ã— ç³»çµ±æ€ç¶­åˆ†æ</div></div><div class="meta-info"><h4>ğŸ“‹ è¨ºæ–·åŸºæœ¬è³‡è¨Š</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px"><div><strong>è¨ºæ–·å°è±¡ï¼š</strong>${companyName}</div><div><strong>ç”¢æ¥­åˆ¥ï¼š</strong>${diagnosisData.context?.industry||"N/A"}</div><div><strong>ä¼æ¥­è¦æ¨¡ï¼š</strong>${diagnosisData.context?.companySize||"N/A"}</div><div><strong>å•†æ¥­æ¨¡å¼ï¼š</strong>${diagnosisData.context?.businessModel||"N/A"}</div><div><strong>å ±å‘Šæ—¥æœŸï¼š</strong>${currentDate}</div><div><strong>è¨ºæ–·æ¨¡å‹ï¼š</strong>${diagnosisData.selectedModels?diagnosisData.selectedModels.map(m => (availableModels.find(am => am.id === m)?.name || m)).join(", "):"N/A"}</div></div></div><div class="section"><h2>ğŸ¯ æ ¸å¿ƒæŒ‘æˆ°æè¿°</h2><div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:5px solid #dc3545"><p style="font-size:1.1em;line-height:1.8;margin:0">${diagnosisData.context?.problem||"æœªæä¾›å…·é«”æŒ‘æˆ°æè¿°"}</p></div></div>`;
            if (diagnosisData.finalRecommendations?.strategic_insight) { htmlContent += `<div class="section"><h2>ğŸ“Š åŸ·è¡Œæ‘˜è¦</h2><div class="executive-summary"><h3 style="margin-top:0;color:#00274c">æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h3><p style="font-size:1.1em;line-height:1.8">${diagnosisData.finalRecommendations.strategic_insight}</p></div></div>`; }
            htmlContent += `<div class="section page-break"><h2>ğŸ“ˆ åˆå§‹ç­–ç•¥åˆ†æ</h2></div>`;
            if (diagnosisData.analysisResults?.swot) { 
                const swotData = diagnosisData.analysisResults.swot;
                const isEnhanced = swotData.diagnosis && swotData.strategy_matrix;
                
                if (isEnhanced) {
                    // æ–°ç‰ˆä¸‰å±¤æ·±å…¥æ ¼å¼
                    const diag = swotData.diagnosis;
                    const matrix = swotData.strategy_matrix;
                    const priorities = swotData.top_3_priorities || [];
                    
                    htmlContent += `<div class="section"><h3>SWOT æˆ°ç•¥åˆ†æï¼ˆä¸‰å±¤æ·±å…¥ç‰ˆï¼‰</h3>`;
                    
                    // ç¬¬ä¸€å±¤ï¼šè¨ºæ–·å±¤
                    htmlContent += `<h4>ç¬¬ä¸€å±¤ï¼šè¨ºæ–·å±¤</h4><div class="swot-grid">`;
                    htmlContent += `<div class="swot-card swot-strengths"><h4>ğŸ’ª å„ªå‹¢ (S)</h4><ul>${(diag.strengths||[]).map(s=>`<li><strong>${s.point}</strong><br><small style="color:#2d5016">æ ¹å› ï¼š${s.root_cause}</small></li>`).join("")}</ul></div>`;
                    htmlContent += `<div class="swot-card swot-weaknesses"><h4>âš ï¸ åŠ£å‹¢ (W)</h4><ul>${(diag.weaknesses||[]).map(w=>`<li><strong>${w.point}</strong><br><small style="color:#721c24">æ ¹å› ï¼š${w.root_cause}</small></li>`).join("")}</ul></div>`;
                    htmlContent += `<div class="swot-card swot-opportunities"><h4>ğŸš€ æ©Ÿæœƒ (O)</h4><ul>${(diag.opportunities||[]).map(o=>`<li><strong>${o.point}</strong><br><small style="color:#004085">èƒŒæ™¯ï¼š${o.root_cause}</small></li>`).join("")}</ul></div>`;
                    htmlContent += `<div class="swot-card swot-threats"><h4>âš¡ å¨è„… (T)</h4><ul>${(diag.threats||[]).map(t=>`<li><strong>${t.point}</strong><br><small style="color:#856404">æ ¹å› ï¼š${t.root_cause}</small></li>`).join("")}</ul></div>`;
                    htmlContent += `</div>`;
                    
                    // ç¬¬äºŒå±¤ï¼šæˆ°ç•¥çŸ©é™£
                    htmlContent += `<h4 style="margin-top:30px">ç¬¬äºŒå±¤ï¼šSWOT æˆ°ç•¥çŸ©é™£</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:15px">`;
                    htmlContent += `<div style="background:#d4edda;padding:15px;border-radius:8px;border-left:5px solid #28a745"><h5 style="color:#155724;margin-top:0">ğŸ’ªğŸš€ SO ç­–ç•¥ï¼ˆå„ªå‹¢-æ©Ÿæœƒï¼‰</h5>${(matrix.SO||[]).map((s,i)=>`<div style="background:#fff;padding:10px;border-radius:5px;margin-bottom:8px"><strong>ç­–ç•¥${i+1}:</strong> ${s.strategy}<br><small style="color:#666">${s.rationale}</small></div>`).join("")}</div>`;
                    htmlContent += `<div style="background:#fff3cd;padding:15px;border-radius:8px;border-left:5px solid #ffc107"><h5 style="color:#856404;margin-top:0">âš ï¸ğŸš€ WO ç­–ç•¥ï¼ˆåŠ£å‹¢-æ©Ÿæœƒï¼‰</h5>${(matrix.WO||[]).map((s,i)=>`<div style="background:#fff;padding:10px;border-radius:5px;margin-bottom:8px"><strong>ç­–ç•¥${i+1}:</strong> ${s.strategy}<br><small style="color:#666">${s.rationale}</small></div>`).join("")}</div>`;
                    htmlContent += `<div style="background:#d1ecf1;padding:15px;border-radius:8px;border-left:5px solid #17a2b8"><h5 style="color:#0c5460;margin-top:0">ğŸ’ªâš¡ ST ç­–ç•¥ï¼ˆå„ªå‹¢-å¨è„…ï¼‰</h5>${(matrix.ST||[]).map((s,i)=>`<div style="background:#fff;padding:10px;border-radius:5px;margin-bottom:8px"><strong>ç­–ç•¥${i+1}:</strong> ${s.strategy}<br><small style="color:#666">${s.rationale}</small></div>`).join("")}</div>`;
                    htmlContent += `<div style="background:#f8d7da;padding:15px;border-radius:8px;border-left:5px solid #dc3545"><h5 style="color:#721c24;margin-top:0">âš ï¸âš¡ WT ç­–ç•¥ï¼ˆåŠ£å‹¢-å¨è„…ï¼‰</h5>${(matrix.WT||[]).map((s,i)=>`<div style="background:#fff;padding:10px;border-radius:5px;margin-bottom:8px"><strong>ç­–ç•¥${i+1}:</strong> ${s.strategy}<br><small style="color:#666">${s.rationale}</small></div>`).join("")}</div>`;
                    htmlContent += `</div>`;
                    
                    // ç¬¬ä¸‰å±¤ï¼šå‰ 3 å„ªå…ˆç­–ç•¥
                    if (priorities.length > 0) {
                        htmlContent += `<h4 style="margin-top:30px">ç¬¬ä¸‰å±¤ï¼šå‰ 3 å„ªå…ˆåŸ·è¡Œç­–ç•¥</h4><div class="recommendation-box" style="background:#fff9e6;border-left:5px solid #ffcb05">`;
                        priorities.forEach(p => {
                            const resourceColor = p.resource_requirement === 'ä½' ? '#28a745' : (p.resource_requirement === 'ä¸­' ? '#ffc107' : '#dc3545');
                            htmlContent += `<div style="background:#fff;padding:15px;border-radius:8px;margin-bottom:12px;border:2px solid #00274c">`;
                            htmlContent += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">`;
                            htmlContent += `<span style="background:#00274c;color:#ffcb05;font-weight:bold;padding:5px 12px;border-radius:50%;font-size:1.2em">${p.rank}</span>`;
                            htmlContent += `<span style="background:#e8f0f7;color:#00274c;padding:4px 10px;border-radius:12px;font-size:0.85em;font-weight:600">${p.type} ç­–ç•¥</span>`;
                            htmlContent += `<span style="background:${resourceColor};color:#fff;padding:4px 10px;border-radius:12px;font-size:0.85em;font-weight:600">è³‡æºéœ€æ±‚ï¼š${p.resource_requirement}</span>`;
                            htmlContent += `</div>`;
                            htmlContent += `<h5 style="color:#00274c;margin:8px 0">${p.strategy}</h5>`;
                            htmlContent += `<p style="margin:5px 0;font-size:0.95em"><strong>å„ªå…ˆåŸå› ï¼š</strong>${p.why_priority}</p>`;
                            htmlContent += `<p style="margin:5px 0;font-size:0.95em;color:#155724"><strong>é æœŸæ•ˆç›Šï¼š</strong>${p.expected_benefit}</p>`;
                            htmlContent += `</div>`;
                        });
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `</div>`;
                } else {
                    // èˆŠç‰ˆå‘ä¸‹ç›¸å®¹
                    htmlContent += `<div class="section"><h3>SWOT æˆ°ç•¥åˆ†æ</h3><div class="swot-grid"><div class="swot-card swot-strengths"><h4>ğŸ’ª å„ªå‹¢ (S)</h4><ul>${(swotData.strengths||[]).map(s=>`<li>${(typeof s === 'object' && s !== null) ? Object.values(s).join('ï¼š ') : s}</li>`).join("")}</ul></div><div class="swot-card swot-weaknesses"><h4>âš ï¸ åŠ£å‹¢ (W)</h4><ul>${(swotData.weaknesses||[]).map(w=>`<li>${(typeof w === 'object' && w !== null) ? Object.values(w).join('ï¼š ') : w}</li>`).join("")}</ul></div><div class="swot-card swot-opportunities"><h4>ğŸš€ æ©Ÿæœƒ (O)</h4><ul>${(swotData.opportunities||[]).map(o=>`<li>${(typeof o === 'object' && o !== null) ? Object.values(o).join('ï¼š ') : o}</li>`).join("")}</ul></div><div class="swot-card swot-threats"><h4>âš¡ å¨è„… (T)</h4><ul>${(swotData.threats||[]).map(t=>`<li>${(typeof t === 'object' && t !== null) ? Object.values(t).join('ï¼š ') : t}</li>`).join("")}</ul></div></div></div>`;
                }
            }
            if (diagnosisData.analysisResults?.porters) { const p=diagnosisData.analysisResults.porters;htmlContent+=`<div class="section"><h3>ç”¢æ¥­ç«¶çˆ­åŠ›åˆ†æ (æ³¢ç‰¹äº”åŠ›)</h3><div class="analysis-grid">${(p.forces||[]).map(f=>{const l=f.level==="é«˜"?"#dc3545":f.level==="ä¸­"?"#ffc107":"#28a745";return`<div class="analysis-card"><h4>${f.name} <span style="background:${l};color:#fff;padding:3px 8px;border-radius:12px;font-size:.8em;float:right">${f.level}</span></h4><p>${f.reason}</p></div>`}).join("")}</div><div class="recommendation-box"><h4 style="margin-top:0">ğŸ“‹ ç”¢æ¥­ç«¶çˆ­ç¸½çµ</h4><p style="margin-bottom:0">${p.summary||""}</p></div></div>`;
            // Phase 2A å¢å¼·ï¼šç«¶çˆ­ç­–ç•¥å»ºè­°
            if (p.competitive_strategy) {
                htmlContent += generateCompetitiveStrategyReport(p.competitive_strategy);
            }
            }
            if(diagnosisData.analysisResults?.pestel){const p=diagnosisData.analysisResults.pestel,l={political:"ğŸ›ï¸ æ”¿æ²»",economic:"ğŸ’° ç¶“æ¿Ÿ",social:"ğŸ‘¥ ç¤¾æœƒ",technological:"ğŸ”¬ æŠ€è¡“",environmental:"ğŸŒ ç’°å¢ƒ",legal:"âš–ï¸ æ³•å¾‹"};htmlContent+=`<div class="section"><h3>ç¸½é«”ç’°å¢ƒåˆ†æ (PESTEL)</h3><div class="analysis-grid">${Object.entries(p).map(([k,v])=>`<div class="analysis-card"><h4>${l[k]||k}</h4><ul>${(v||[]).map(i=>`<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join("")}</ul></div>`).join("")}</div></div>`}
            if(diagnosisData.analysisResults?.vpc){const v=diagnosisData.analysisResults.vpc;htmlContent+=`<div class="section"><h3>åƒ¹å€¼ä¸»å¼µåˆ†æ (VPC)</h3><div class="analysis-grid"><div class="analysis-card"><h4>âœ¨ åƒ¹å€¼åœ°åœ–</h4><h5>ç”¢å“èˆ‡æœå‹™</h5><ul>${(v.value_map?.products_services||[]).map(i=>`<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join("")}</ul><h5>ç—›é»è§£æ–¹</h5><ul>${(v.value_map?.pain_relievers||[]).map(i=>`<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join("")}</ul><h5>ç²ç›Šå‰µé€ è€…</h5><ul>${(v.value_map?.gain_creators||[]).map(i=>`<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ‘¤ é¡§å®¢è¼ªå»“</h4><h5>é¡§å®¢ä»»å‹™</h5><ul>${(v.customer_profile?.jobs||[]).map(i=>`<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join("")}</ul><h5>ç—›é»</h5><ul>${(v.customer_profile?.pains||[]).map(i=>`<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join("")}</ul><h5>æœŸæœ›ç²ç›Š</h5><ul>${(v.customer_profile?.gains||[]).map(i=>`<li>${(typeof i === 'object' && i !== null) ? Object.values(i).join('ï¼š ') : i}</li>`).join("")}</ul></div></div></div>`}
            if(diagnosisData.analysisResults?.bmc){const b=diagnosisData.analysisResults.bmc;htmlContent+=`<div class="section"><h3>å•†æ¥­æ¨¡å¼åˆ†æ (BMC)</h3><div class="analysis-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"><div class="analysis-card"><h4>ğŸ¤ é—œéµåˆä½œå¤¥ä¼´</h4><ul>${(b.key_partnerships||[]).map(p=>`<li>${(typeof p === 'object' && p !== null) ? Object.values(p).join('ï¼š ') : p}</li>`).join("")}</ul></div><div class="analysis-card"><h4>âš¡ é—œéµæ´»å‹•</h4><ul>${(b.key_activities||[]).map(a=>`<li>${(typeof a === 'object' && a !== null) ? Object.values(a).join('ï¼š ') : a}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ åƒ¹å€¼ä¸»å¼µ</h4><ul>${(b.value_propositions||[]).map(v=>`<li>${(typeof v === 'object' && v !== null) ? Object.values(v).join('ï¼š ') : v}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ‘¥ é¡§å®¢é—œä¿‚</h4><ul>${(b.customer_relationships||[]).map(r=>`<li>${(typeof r === 'object' && r !== null) ? Object.values(r).join('ï¼š ') : r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ¯ ç›®æ¨™å®¢ç¾¤</h4><ul>${(b.customer_segments||[]).map(s=>`<li>${(typeof s === 'object' && s !== null) ? Object.values(s).join('ï¼š ') : s}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ”‘ é—œéµè³‡æº</h4><ul>${(b.key_resources||[]).map(r=>`<li>${(typeof r === 'object' && r !== null) ? Object.values(r).join('ï¼š ') : r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ“¢ é€šè·¯ç®¡é“</h4><ul>${(b.channels||[]).map(c=>`<li>${(typeof c === 'object' && c !== null) ? Object.values(c).join('ï¼š ') : c}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ’° æ”¶ç›Šæµ</h4><ul>${(b.revenue_streams||[]).map(r=>`<li>${(typeof r === 'object' && r !== null) ? Object.values(r).join('ï¼š ') : r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ’¸ æˆæœ¬çµæ§‹</h4><ul>${(b.cost_structure||[]).map(c=>`<li>${(typeof c === 'object' && c !== null) ? Object.values(c).join('ï¼š ') : c}</li>`).join("")}</ul></div></div></div>`}
            // --- [æ–°åŠ å…¥] å ±è¡¨åŠ å…¥å®¢æˆ¶æ—…ç¨‹ ---
            if(diagnosisData.analysisResults?.customerJourney){const c=diagnosisData.analysisResults.customerJourney;
            // Phase 2B: ç—›é»é¡è‰²æ˜ å°„å‡½æ•¸
            const getPainColor=(score)=>{if(score<=3)return'#28a745';if(score<=6)return'#ffc107';return'#dc3545';};
            
            htmlContent+=`<div class="section"><h3>ğŸ§­ å®¢æˆ¶æ—…ç¨‹åˆ†æ (Customer Journey)</h3><div class="recommendation-box"><h4 style="margin-top:0">é¸ç”¨æ¨¡å‹: ${c.model_chosen||"N/A"}</h4><p style="margin-bottom:0">${c.reason_for_choice||""}</p></div><div class="analysis-grid">${(c.stages||[]).map(s=>{
                let stageHtml=`<div class="analysis-card"><h4>${s.stage_name}</h4><p>${s.description}</p><h5>ğŸ¯ é—œéµæ¥è§¸é»</h5><ul style="padding-left:20px">${(s.key_touchpoints||[]).map(k=>`<li>${(typeof k==='object'&&k!==null)?Object.values(k).join('ï¼š '):k}</li>`).join("")}</ul>`;
                
                // Phase 2B: ç—›é»åˆ†æå€å¡Š
                if(s.pain_points&&s.pain_points.length>0){
                    const overallScore=s.overall_pain_score||5;
                    const painColor=getPainColor(overallScore);
                    stageHtml+=`<h5 style="margin-top:15px">ğŸ”¥ ç—›é»åˆ†æ <span style="float:right;color:${painColor};font-weight:bold">${overallScore}/10</span></h5><div class="pain-points-list" style="margin-top:10px;display:flex;flex-direction:column;gap:10px">`;
                    s.pain_points.forEach(pain=>{
                        const pColor=getPainColor(pain.intensity||5);
                        stageHtml+=`<div class="pain-point-item" style="background:#fff;padding:12px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border-left:4px solid ${pColor}"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><strong>${pain.description||''}</strong><span class="pain-badge" style="padding:4px 10px;border-radius:12px;background:${pColor};color:#fff;font-size:0.85em;font-weight:bold">${pain.intensity||5}/10</span></div><div style="font-size:0.85em;color:#666"><span style="display:inline-block;padding:2px 8px;background:#f0f0f0;border-radius:4px;margin-right:8px">${pain.category||'æœªåˆ†é¡'}</span>ğŸ’¡ ${pain.solution_hint||'è«‹è«®è©¢å°ˆå®¶'}</div></div>`;
                    });
                    stageHtml+=`</div>`;
                }
                
                stageHtml+=`</div>`;
                return stageHtml;
            }).join("")}</div><div class="executive-summary" style="background:#f0f8ff"><h4 style="margin-top:0">é—œéµæ´å¯Ÿç¸½çµ</h4><p style="margin-bottom:0">${c.summary_insight||""}</p></div></div>`
            // Phase 2B: ç—›é»ç†±åŠ›åœ–
            if(c.stages&&c.stages.length>0&&c.stages.some(s=>s.overall_pain_score)){
                const maxStages=c.stages.length;
                const cellWidth=Math.min(120,Math.floor(800/maxStages));
                htmlContent+=`<div class="section" style="background:#f8f9fa;padding:20px;border-radius:10px;margin-top:20px"><h4 style="color:#dc3545;margin-top:0">ğŸ”¥ ç—›é»ç†±åŠ›åœ–</h4><p style="color:#666;font-size:0.9em;margin-bottom:15px">è¦–è¦ºåŒ–å‘ˆç¾å„éšæ®µç—›é»å¼·åº¦åˆ†ä½ˆï¼Œé¡è‰²è¶Šæ·±è¡¨ç¤ºç—›é»è¶Šåš´é‡</p><div class="heatmap-container" style="overflow-x:auto;padding:10px 0"><div style="display:flex;gap:10px;min-width:${maxStages*(cellWidth+10)}px">`;
                
                c.stages.forEach(stage=>{
                    const score=stage.overall_pain_score||5;
                    const color=getPainColor(score);
                    const bgOpacity=Math.round((score/10)*255).toString(16).padStart(2,'0');
                    const severity=score<=3?'è¼•å¾®':score<=6?'ä¸­ç­‰':'åš´é‡';
                    htmlContent+=`<div class="heatmap-cell" style="flex:1;min-width:${cellWidth}px;padding:15px;background:linear-gradient(135deg,${color}${bgOpacity},${color}${Math.round((score/10)*200).toString(16).padStart(2,'0')});border-radius:8px;border:2px solid ${color};text-align:center;transition:transform 0.3s ease,box-shadow 0.3s ease;cursor:pointer" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 5px 15px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'"><div style="font-weight:bold;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,0.5);margin-bottom:10px">${stage.stage_name}</div><div style="font-size:2em;font-weight:bold;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.5)">${score}</div><div style="font-size:0.85em;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,0.5);margin-top:5px">${severity}ç—›é»</div></div>`;
                });
                
                htmlContent+=`</div></div><div style="display:flex;justify-content:center;gap:20px;margin-top:20px;padding-top:15px;border-top:1px solid #dee2e6"><div style="display:flex;align-items:center;gap:8px"><div style="width:30px;height:20px;background:#28a745;border-radius:4px"></div><span style="font-size:0.9em">è¼•å¾® (1-3)</span></div><div style="display:flex;align-items:center;gap:8px"><div style="width:30px;height:20px;background:#ffc107;border-radius:4px"></div><span style="font-size:0.9em">ä¸­ç­‰ (4-6)</span></div><div style="display:flex;align-items:center;gap:8px"><div style="width:30px;height:20px;background:#dc3545;border-radius:4px"></div><span style="font-size:0.9em">åš´é‡ (7-10)</span></div></div>`;
                
                // é—œéµæ´å¯Ÿ
                const highPainStages=c.stages.filter(s=>(s.overall_pain_score||0)>=7);
                const avgPain=c.stages.reduce((sum,s)=>sum+(s.overall_pain_score||0),0)/c.stages.length;
                htmlContent+=`<div style="background:#fff;padding:15px;border-radius:8px;margin-top:15px;border-left:4px solid #dc3545"><h5 style="color:#dc3545;margin:0 0 10px 0">ğŸ¯ é—œéµæ´å¯Ÿ</h5><ul style="margin:0;padding-left:20px;color:#333"><li>å®¢æˆ¶æ—…ç¨‹æ•´é«”ç—›é»å¼·åº¦ï¼š<strong>${avgPain.toFixed(1)}/10</strong></li>`;
                
                if(highPainStages.length>0){
                    htmlContent+=`<li>é«˜ç—›é»éšæ®µï¼ˆâ‰¥7åˆ†ï¼‰ï¼š<strong>${highPainStages.map(s=>s.stage_name).join('ã€')}</strong> - éœ€å„ªå…ˆæ”¹å–„</li>`;
                }else{
                    htmlContent+=`<li>æš«ç„¡é«˜ç—›é»éšæ®µï¼ˆâ‰¥7åˆ†ï¼‰ï¼Œæ•´é«”å®¢æˆ¶é«”é©—è‰¯å¥½</li>`;
                }
                
                htmlContent+=`</ul></div></div>`;
            }
            }
            
            htmlContent += `<div class="section page-break"><h2>ğŸ’¡ å‰µæ–°æ–¹æ¡ˆè¨­è¨ˆå·¥å…·ç®±</h2></div>`;
            if(diagnosisData.scamper){const s=diagnosisData.scamper;htmlContent+=`<div class="section"><h3>ğŸ§© SCAMPER å‰µæ–°è§£æ±ºæ–¹æ¡ˆ</h3>${(s.strategic_insights||[]).length>0?`<h4>ğŸ¯ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h4><div class="analysis-grid">${s.strategic_insights.map(i=>`<div class="analysis-card" style="border-left:5px solid #ffcb05"><h5>${i.issue}</h5><p>${i.description}</p><p style="font-size:.9em;color:#666"><strong>æ•¸æ“šä¾æ“š:</strong> ${(i.data_sources||[]).join(", ")}</p></div>`).join("")}</div>`:""}<h4 style="margin-top:20px">ğŸ’¡ å…·é«”å‰µæ–°æ–¹æ¡ˆ</h4>${(s.scamper_solutions||[]).map(s=>`<div class="analysis-card" style="margin-bottom:15px"><h5>${s.technique}: ${s.solution.title}</h5><p>${s.solution.description}</p><ul><li><strong>å°æ‡‰è­°é¡Œ:</strong> ${s.target_pain || s.strategic_issue || "æœªæ˜ç¢ºæŒ‡å®šç—›é»"}</li><li><strong>é æœŸæ•ˆç›Š:</strong> ${(s.solution.expected_benefits||[]).join(", ")}</li></ul></div>`).join("")}${(s.priority_ranking||[]).length>0?`<h4 style="margin-top:20px">ğŸš€ å„ªå…ˆå¯¦æ–½å»ºè­°</h4><ol>${s.priority_ranking.slice(0,5).map(p=>`<li>${(typeof p === 'object' && p !== null) ? (p.title || 'ç„¡æ¨™é¡Œå»ºè­°') : p}</li>`).join("")}</ol>`:""}</div>`}
            if(false && diagnosisData.blue_ocean){const b=diagnosisData.blue_ocean,r=a=>(a||[]).map(i=>`<div class="analysis-card" style="padding:15px;margin-bottom:10px"><h5>${i.action}</h5><p style="font-size:.9em;margin:0">${i.rationale}</p></div>`).join("");htmlContent+=`<div class="section"><h3>ğŸŒŠ è—æµ·ç­–ç•¥åˆ†æ (ERRC)</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div style="background:#f8d7da;padding:15px;border-radius:8px"><h4 style="color:#721c24">ğŸš« æ¶ˆé™¤</h4>${r(b.eliminate)}</div><div style="background:#fff3cd;padding:15px;border-radius:8px"><h4 style="color:#856404">ğŸ“‰ æ¸›å°‘</h4>${r(b.reduce)}</div><div style="background:#d1ecf1;padding:15px;border-radius:8px"><h4 style="color:#0c5460">ğŸ“ˆ æå‡</h4>${r(b.raise)}</div><div style="background:#d4edda;padding:15px;border-radius:8px"><h4 style="color:#155724">âœ¨ å‰µé€ </h4>${r(b.create)}</div></div></div>`}
            if(diagnosisData.design_thinking){htmlContent+=`<div class="section"><h3>ğŸ§  è¨­è¨ˆæ€ç¶­æµç¨‹</h3>${(diagnosisData.design_thinking.stages||[]).map(s=>`<div class="analysis-card" style="margin-bottom:15px;border-left:5px solid #00274c"><h4>${s.stage}</h4><p>${s.description}</p><h5>é—œéµè¡Œå‹•/å•é¡Œ:</h5><ul>${(s.actions||[]).map(a=>`<li>${a}</li>`).join("")}</ul></div>`).join("")}</div>`}
            if(diagnosisData.lean_startup){const l=diagnosisData.lean_startup;htmlContent+=`<div class="section"><h3>ğŸš€ ç²¾å¯¦å‰µæ¥­è¡Œå‹•è¨ˆç•«</h3><h4>${l.title||""}</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px"><div class="analysis-card" style="background:#d1ecf1"><h4>1. å»ºç«‹</h4><h5>é—œéµå‡è¨­</h5><p>${l.build?.key_hypothesis||""}</p><h5>MVPå»ºè­°: ${l.build?.mvp_suggestion?.name||""}</h5><p>${l.build?.mvp_suggestion?.description||""}</p><ul>${(l.build?.mvp_suggestion?.features||[]).map(f=>`<li>${f}</li>`).join("")}</ul></div><div class="analysis-card" style="background:#d4edda"><h4>2. è¡¡é‡</h4><h5>é—œéµæŒ‡æ¨™</h5><ul>${(l.measure?.key_metrics||[]).map(m=>`<li><strong>${m.metric}:</strong> ${m.definition}</li>`).join("")}</ul><h5>è¡¡é‡æ–¹æ³•</h5><p>${l.measure?.measurement_method||""}</p></div><div class="analysis-card" style="background:#fff3cd"><h4>3. å­¸ç¿’</h4><h5>æ±ºç­–é»</h5><p>${l.learn?.pivot_or_persevere||""}</p><h5>å­¸ç¿’å•é¡Œ</h5><ul>${(l.learn?.learning_questions||[]).map(q=>`<li>${q}</li>`).join("")}</ul></div></div></div>`}
            if(diagnosisData.ten_types){htmlContent+=`<div class="section"><h3>ğŸ”Ÿ åå¤§å‰µæ–°é¡å‹æ©Ÿæœƒé»</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">${(diagnosisData.ten_types.categories||[]).map(c=>`<div class="analysis-card" style="background:#e8f0f7"><h4>${c.name}</h4><p style="font-size:.9em">${c.description}</p>${(c.types||[]).map(t=>`<div style="background:#fff;padding:10px;border-radius:5px;margin-top:10px"><h5>${t.type_name}</h5><ul>${(t.ideas||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div>`).join("")}</div>`).join("")}</div></div>`}
            if (diagnosisData.finalRecommendations) { 
                const f = diagnosisData.finalRecommendations; 
                const isEnhanced = f.priority_matrix && f.resource_allocation_summary;
                
                
            
            // Phase 2C: è—æµ·ç­–ç•¥åˆ†æ
            if(diagnosisData.analysisResults?.blueOcean){
                const bo=diagnosisData.analysisResults.blueOcean;
                
                htmlContent+=`<div class="section"><h3>ğŸŒŠ è—æµ·ç­–ç•¥åˆ†æ (Blue Ocean Strategy)</h3>`;
                
                // å››é …è¡Œå‹•æ¶æ§‹
                if(bo.four_actions){
                    const actions=bo.four_actions;
                    htmlContent+=`<h4 style="margin-top:0">å››é …è¡Œå‹•æ¶æ§‹</h4><div class="blue-ocean-matrix" style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:30px">`;
                    
                    // æ¸›é™¤ï¼ˆå·¦ä¸Šï¼‰
                    htmlContent+=`<div class="bo-quadrant" style="padding:20px;border-radius:8px;border:2px solid #dc3545;background:#ffe6e6"><h5 style="color:#dc3545;margin-top:0">âŒ æ¸›é™¤ (Eliminate)</h5><div style="font-size:0.9em;color:#666;margin-bottom:10px">å“ªäº›ç”¢æ¥­ç¿’ä»¥ç‚ºå¸¸çš„å…ƒç´ æ‡‰è©²è¢«æ¸›é™¤ï¼Ÿ</div>`;
                    if(actions.eliminate&&actions.eliminate.length>0){
                        actions.eliminate.forEach(item=>{
                            const i=(typeof item==='object')?item.item:item;
                            const r=(typeof item==='object')?item.reason:'';
                            htmlContent+=`<div style="background:#fff;padding:10px;margin-bottom:8px;border-radius:6px;border-left:3px solid #dc3545"><strong>â€¢ ${i}</strong>${r?'<div style="font-size:0.85em;color:#666;margin-top:5px">'+r+'</div>':''}</div>`;
                        });
                    }else{
                        htmlContent+=`<div style="color:#999;font-style:italic">æš«ç„¡å»ºè­°</div>`;
                    }
                    htmlContent+=`</div>`;
                    
                    // æå‡ï¼ˆå³ä¸Šï¼‰
                    htmlContent+=`<div class="bo-quadrant" style="padding:20px;border-radius:8px;border:2px solid #28a745;background:#e6f9e6"><h5 style="color:#28a745;margin-top:0">ğŸ“ˆ æå‡ (Raise)</h5><div style="font-size:0.9em;color:#666;margin-bottom:10px">å“ªäº›å…ƒç´ æ‡‰è©²è¢«å¤§å¹…æå‡åˆ°ç”¢æ¥­å‰æ‰€æœªæœ‰çš„æ°´æº–ï¼Ÿ</div>`;
                    if(actions.raise&&actions.raise.length>0){
                        actions.raise.forEach(item=>{
                            const i=(typeof item==='object')?item.item:item;
                            const r=(typeof item==='object')?item.reason:'';
                            htmlContent+=`<div style="background:#fff;padding:10px;margin-bottom:8px;border-radius:6px;border-left:3px solid #28a745"><strong>â€¢ ${i}</strong>${r?'<div style="font-size:0.85em;color:#666;margin-top:5px">'+r+'</div>':''}</div>`;
                        });
                    }else{
                        htmlContent+=`<div style="color:#999;font-style:italic">æš«ç„¡å»ºè­°</div>`;
                    }
                    htmlContent+=`</div>`;
                    
                    // é™ä½ï¼ˆå·¦ä¸‹ï¼‰
                    htmlContent+=`<div class="bo-quadrant" style="padding:20px;border-radius:8px;border:2px solid #ffc107;background:#fff9e6"><h5 style="color:#856404;margin-top:0">ğŸ“‰ é™ä½ (Reduce)</h5><div style="font-size:0.9em;color:#666;margin-bottom:10px">å“ªäº›å…ƒç´ æ‡‰è©²è¢«é™ä½åˆ°ç”¢æ¥­æ¨™æº–ä»¥ä¸‹ï¼Ÿ</div>`;
                    if(actions.reduce&&actions.reduce.length>0){
                        actions.reduce.forEach(item=>{
                            const i=(typeof item==='object')?item.item:item;
                            const r=(typeof item==='object')?item.reason:'';
                            htmlContent+=`<div style="background:#fff;padding:10px;margin-bottom:8px;border-radius:6px;border-left:3px solid #ffc107"><strong>â€¢ ${i}</strong>${r?'<div style="font-size:0.85em;color:#666;margin-top:5px">'+r+'</div>':''}</div>`;
                        });
                    }else{
                        htmlContent+=`<div style="color:#999;font-style:italic">æš«ç„¡å»ºè­°</div>`;
                    }
                    htmlContent+=`</div>`;
                    
                    // å‰µé€ ï¼ˆå³ä¸‹ï¼‰
                    htmlContent+=`<div class="bo-quadrant" style="padding:20px;border-radius:8px;border:2px solid #007bff;background:#e6f2ff"><h5 style="color:#007bff;margin-top:0">âœ¨ å‰µé€  (Create)</h5><div style="font-size:0.9em;color:#666;margin-bottom:10px">å“ªäº›ç”¢æ¥­å¾æœªæä¾›çš„å…ƒç´ æ‡‰è©²è¢«å‰µé€ å‡ºä¾†ï¼Ÿ</div>`;
                    if(actions.create&&actions.create.length>0){
                        actions.create.forEach(item=>{
                            const i=(typeof item==='object')?item.item:item;
                            const r=(typeof item==='object')?item.reason:'';
                            htmlContent+=`<div style="background:#fff;padding:10px;margin-bottom:8px;border-radius:6px;border-left:3px solid #007bff"><strong>â€¢ ${i}</strong>${r?'<div style="font-size:0.85em;color:#666;margin-top:5px">'+r+'</div>':''}</div>`;
                        });
                    }else{
                        htmlContent+=`<div style="color:#999;font-style:italic">æš«ç„¡å»ºè­°</div>`;
                    }
                    htmlContent+=`</div>`;
                    
                    htmlContent+=`</div>`;
                }
                // åƒ¹å€¼æ›²ç·šå°æ¯”åœ–ï¼šå·²ç§»é™¤ï¼ˆé¿å…å¹²æ“¾åˆ†æèˆ‡æ•¸æ“šçœŸå¯¦æ€§çˆ­è­°ï¼‰
                
                // æˆ°ç•¥æ´å¯Ÿ
                if(bo.strategic_insights){
                    htmlContent+=`<div class="recommendation-box" style="background:#e6f2ff;border-left:4px solid #007bff;margin-top:20px"><h4 style="color:#007bff;margin-top:0">ğŸ¯ æˆ°ç•¥æ´å¯Ÿ</h4><p style="margin-bottom:0">${bo.strategic_insights}</p></div>`;
                }
                
                htmlContent+=`</div>`;
            }htmlContent += `<div class="section page-break"><h2>ğŸš€ æˆ°ç•¥å»ºè­°èˆ‡è¡Œå‹•æ–¹æ¡ˆ</h2>`;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å„ªå…ˆç´šçŸ©é™£
                if (isEnhanced && f.priority_matrix) {
                    const matrix = f.priority_matrix;
                    const allocation = f.resource_allocation_summary;
                    
                    // æ ¸å¿ƒæ´å¯Ÿ
                    if (f.strategic_insight) {
                        htmlContent += `<div class="executive-summary"><h3 style="margin-top:0">ğŸ’¡ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h3><p style="font-size:1.1em;line-height:1.8">${f.strategic_insight}</p></div>`;
                    }
                    
                    // å„ªå…ˆç´šçŸ©é™£
                    htmlContent += `<div class="section"><h3>ğŸ“Š åŸ·è¡Œå„ªå…ˆç´šçŸ©é™£ï¼ˆ2Ã—2ï¼‰</h3><p style="text-align:center;color:#666;margin-bottom:20px">åŸºæ–¼å½±éŸ¿åŠ›èˆ‡å¯è¡Œæ€§çš„æˆ°ç•¥åˆ†é¡</p>`;
                    htmlContent += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px">`;
                    
                    // å¿«é€Ÿè‡´å‹
                    htmlContent += `<div style="background:#d4edda;padding:20px;border-radius:10px;border-left:5px solid #28a745;position:relative">`;
                    htmlContent += `<div style="position:absolute;top:10px;right:10px;background:#28a745;color:#fff;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9em">${allocation?.quick_wins||'50%'}</div>`;
                    htmlContent += `<h4 style="color:#155724;margin-top:0">ğŸš€ å¿«é€Ÿè‡´å‹</h4><p style="font-size:0.85em;color:#155724;margin-bottom:15px">é«˜å½±éŸ¿ Ã— é«˜å¯è¡Œæ€§</p>`;
                    if (matrix.quick_wins?.length > 0) {
                        matrix.quick_wins.forEach((item, idx) => {
                            htmlContent += `<div style="background:#fff;padding:12px;border-radius:8px;margin-bottom:10px;border:1px solid #28a745"><p style="margin:0;font-weight:600;color:#155724">${idx+1}. ${item.initiative}</p><p style="margin:5px 0 0;font-size:0.85em;color:#666"><span style="background:#cce5ff;padding:2px 6px;border-radius:3px;margin-right:5px">å½±éŸ¿ ${item.impact}/10</span><span style="background:#d4edda;padding:2px 6px;border-radius:3px">å¯è¡Œ ${item.feasibility}/10</span></p></div>`;
                        });
                    } else {
                        htmlContent += `<p style="font-size:0.9em;color:#666">æš«ç„¡é …ç›®</p>`;
                    }
                    htmlContent += `</div>`;
                    
                    // æˆ°ç•¥è³­æ³¨
                    htmlContent += `<div style="background:#fff3cd;padding:20px;border-radius:10px;border-left:5px solid #ffc107;position:relative">`;
                    htmlContent += `<div style="position:absolute;top:10px;right:10px;background:#ffc107;color:#000;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9em">${allocation?.big_bets||'30%'}</div>`;
                    htmlContent += `<h4 style="color:#856404;margin-top:0">ğŸ¯ æˆ°ç•¥è³­æ³¨</h4><p style="font-size:0.85em;color:#856404;margin-bottom:15px">é«˜å½±éŸ¿ Ã— ä½å¯è¡Œæ€§</p>`;
                    if (matrix.big_bets?.length > 0) {
                        matrix.big_bets.forEach((item, idx) => {
                            htmlContent += `<div style="background:#fff;padding:12px;border-radius:8px;margin-bottom:10px;border:1px solid #ffc107"><p style="margin:0;font-weight:600;color:#856404">${idx+1}. ${item.initiative}</p><p style="margin:5px 0 0;font-size:0.85em;color:#666"><span style="background:#cce5ff;padding:2px 6px;border-radius:3px;margin-right:5px">å½±éŸ¿ ${item.impact}/10</span><span style="background:#f8d7da;padding:2px 6px;border-radius:3px">å¯è¡Œ ${item.feasibility}/10</span></p></div>`;
                        });
                    } else {
                        htmlContent += `<p style="font-size:0.9em;color:#666">æš«ç„¡é …ç›®</p>`;
                    }
                    htmlContent += `</div>`;
                    
                    // å¡«å……é …ç›®
                    htmlContent += `<div style="background:#d1ecf1;padding:20px;border-radius:10px;border-left:5px solid #17a2b8;position:relative">`;
                    htmlContent += `<div style="position:absolute;top:10px;right:10px;background:#17a2b8;color:#fff;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9em">${allocation?.fill_ins||'15%'}</div>`;
                    htmlContent += `<h4 style="color:#0c5460;margin-top:0">ğŸ“ å¡«å……é …ç›®</h4><p style="font-size:0.85em;color:#0c5460;margin-bottom:15px">ä½å½±éŸ¿ Ã— é«˜å¯è¡Œæ€§</p>`;
                    if (matrix.fill_ins?.length > 0) {
                        matrix.fill_ins.slice(0,3).forEach((item, idx) => {
                            htmlContent += `<div style="background:#fff;padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #17a2b8"><p style="margin:0;font-size:0.9em;color:#0c5460">${idx+1}. ${item.initiative}</p></div>`;
                        });
                    } else {
                        htmlContent += `<p style="font-size:0.9em;color:#666">æš«ç„¡é …ç›®</p>`;
                    }
                    htmlContent += `</div>`;
                    
                    // é‡‘éŒ¢é™·é˜±
                    htmlContent += `<div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:5px solid #6c757d;position:relative">`;
                    htmlContent += `<div style="position:absolute;top:10px;right:10px;background:#6c757d;color:#fff;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9em">${allocation?.money_pits||'5%'}</div>`;
                    htmlContent += `<h4 style="color:#495057;margin-top:0">â›” é‡‘éŒ¢é™·é˜±</h4><p style="font-size:0.85em;color:#495057;margin-bottom:15px">ä½å½±éŸ¿ Ã— ä½å¯è¡Œæ€§</p>`;
                    if (matrix.money_pits?.length > 0) {
                        matrix.money_pits.slice(0,2).forEach((item, idx) => {
                            htmlContent += `<div style="background:#fff;padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #6c757d"><p style="margin:0;font-size:0.9em;color:#495057">${item.initiative}</p><p style="margin:3px 0 0;font-size:0.8em;color:#dc3545">âŒ ${item.why_avoid}</p></div>`;
                        });
                    } else {
                        htmlContent += `<p style="font-size:0.9em;color:#28a745">âœ… ç„¡éœ€é¿å…çš„é …ç›®</p>`;
                    }
                    htmlContent += `</div>`;
                    
                    htmlContent += `</div>`;
                    
                    // è³‡æºé…ç½®æ‘˜è¦
                    htmlContent += `<div class="recommendation-box" style="background:#e8f0f7"><h4 style="margin-top:0">ğŸ’° å»ºè­°è³‡æºé…ç½®æ¯”ä¾‹</h4><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;text-align:center">`;
                    htmlContent += `<div><div style="font-size:1.5em;font-weight:bold;color:#28a745">${allocation?.quick_wins||'50%'}</div><div style="font-size:0.9em;color:#666">å¿«é€Ÿè‡´å‹</div></div>`;
                    htmlContent += `<div><div style="font-size:1.5em;font-weight:bold;color:#ffc107">${allocation?.big_bets||'30%'}</div><div style="font-size:0.9em;color:#666">æˆ°ç•¥è³­æ³¨</div></div>`;
                    htmlContent += `<div><div style="font-size:1.5em;font-weight:bold;color:#17a2b8">${allocation?.fill_ins||'15%'}</div><div style="font-size:0.9em;color:#666">å¡«å……é …ç›®</div></div>`;
                    htmlContent += `<div><div style="font-size:1.5em;font-weight:bold;color:#6c757d">${allocation?.money_pits||'5%'}</div><div style="font-size:0.9em;color:#666">é‡‘éŒ¢é™·é˜±</div></div>`;
                    htmlContent += `</div></div></div>`;
                }
                
                // ç«‹å³è¡Œå‹•ï¼ˆå…¼å®¹æ–°èˆŠæ ¼å¼ï¼‰
                htmlContent += `<div class="recommendation-box" style="background:#d4edda;border-left:5px solid #28a745"><h3 style="margin-top:0">âš¡ ç«‹å³è¡Œå‹•æ–¹æ¡ˆ (30å¤©å…§)</h3>`;
                if (f.immediate_actions && f.immediate_actions.length > 0) {
                    const firstAction = f.immediate_actions[0];
                    const isEnhancedAction = typeof firstAction === 'object' && firstAction.action;
                    
                    if (isEnhancedAction) {
                        // æ–°ç‰ˆï¼šç‰©ä»¶æ ¼å¼
                        htmlContent += `<div class="action-item">`;
                        f.immediate_actions.forEach((a, idx) => {
                            htmlContent += `<div style="background:#fff;padding:15px;border-radius:8px;margin-bottom:12px;border-left:4px solid #28a745">`;
                            htmlContent += `<div style="display:flex;align-items:start;gap:10px">`;
                            htmlContent += `<span style="background:#28a745;color:#fff;font-weight:bold;padding:5px 12px;border-radius:50%;flex-shrink:0">${idx+1}</span>`;
                            htmlContent += `<div style="flex:1"><p style="margin:0;font-weight:600;color:#155724">${a.action}</p>`;
                            if (a.owner) htmlContent += `<p style="margin:5px 0 0;font-size:0.9em;color:#666">ğŸ‘¤ è² è²¬äººï¼š${a.owner}</p>`;
                            if (a.deadline) htmlContent += `<p style="margin:5px 0 0;font-size:0.9em;color:#666">ğŸ“… æœŸé™ï¼š${a.deadline}</p>`;
                            if (a.from_category) htmlContent += `<p style="margin:5px 0 0;font-size:0.85em;color:#28a745">ä¾†è‡ªï¼š${a.from_category}</p>`;
                            htmlContent += `</div></div></div>`;
                        });
                        htmlContent += `</div>`;
                    } else {
                        // èˆŠç‰ˆï¼šå­—ä¸²æ ¼å¼
                        htmlContent += `<ol>`;
                        f.immediate_actions.forEach(a => {
                            const actionText = (typeof a === 'object' && a !== null) ? Object.values(a).join('ï¼š ') : a;
                            htmlContent += `<li style="margin-bottom:8px">${actionText}</li>`;
                        });
                        htmlContent += `</ol>`;
                    }
                } else {
                    htmlContent += `<p style="color:#666">æš«ç„¡ç«‹å³è¡Œå‹•é …ç›®</p>`;
                }
                htmlContent += `</div>`;
                
                // å­£åº¦è·¯ç·šåœ–ï¼ˆå…¼å®¹æ–°èˆŠæ ¼å¼ï¼‰
                htmlContent += `<h3>ğŸ—ºï¸ å­£åº¦åŸ·è¡Œè·¯ç·šåœ–</h3>`;
                if (f.quarterly_roadmap && f.quarterly_roadmap.length > 0) {
                    const firstQuarter = f.quarterly_roadmap[0];
                    const isEnhancedQuarter = firstQuarter.quick_wins_count !== undefined || firstQuarter.big_bets_progress;
                    
                    if (isEnhancedQuarter) {
                        // æ–°ç‰ˆï¼šå«å¿«é€Ÿè‡´å‹æ•¸é‡èˆ‡æˆ°ç•¥è³­æ³¨é€²åº¦
                        htmlContent += `<div class="analysis-grid">`;
                        f.quarterly_roadmap.forEach(q => {
                            htmlContent += `<div class="analysis-card" style="background:#e8f0f7">`;
                            htmlContent += `<h4 style="color:#00274c">${q.quarter}</h4>`;
                            htmlContent += `<p style="margin:10px 0;color:#333">${q.focus}</p>`;
                            if (q.quick_wins_count) htmlContent += `<p style="font-size:0.9em;color:#28a745;margin:5px 0">ğŸš€ å¿«é€Ÿè‡´å‹ ${q.quick_wins_count} é …</p>`;
                            if (q.big_bets_progress) htmlContent += `<p style="font-size:0.9em;color:#ffc107;margin:5px 0">ğŸ¯ ${q.big_bets_progress}</p>`;
                            htmlContent += `</div>`;
                        });
                        htmlContent += `</div>`;
                    } else {
                        // èˆŠç‰ˆï¼šåƒ…å« quarter èˆ‡ focus
                        htmlContent += `<div class="analysis-grid">`;
                        f.quarterly_roadmap.forEach(q => {
                            htmlContent += `<div class="analysis-card">`;
                            htmlContent += `<h4>${q.quarter}</h4>`;
                            htmlContent += `<p>${q.focus}</p>`;
                            htmlContent += `</div>`;
                        });
                        htmlContent += `</div>`;
                    }
                } else {
                    htmlContent += `<p style="color:#666">æš«ç„¡è·¯ç·šåœ–</p>`;
                }
                
                // é•·æœŸé¡˜æ™¯
                htmlContent += `<div class="recommendation-box" style="background:#fff9e6;border-left:5px solid #ffcb05"><h3 style="margin-top:0">ğŸ”® é•·æœŸé¡˜æ™¯</h3><p style="font-size:1.1em;line-height:1.8;margin-bottom:0">${f.long_term_vision || 'æš«ç„¡é•·æœŸé¡˜æ™¯æè¿°'}</p></div>`;
                
                htmlContent += `</div>`;
            }
            htmlContent += `<div class="footer"><h3>é—œæ–¼ A2PSDM é¡§å•æœå‹™</h3><p><strong>ç‹åšå£«</strong> | A2PSDM</p><p>å¯†è¥¿æ ¹å¤§å­¸åšå£« Ã— 30å¹´ç”¢æ¥­ç¶“é©— Ã— AIå‰µæ–°æ•´åˆ</p><p>æœ¬å ±å‘Šç”± A2PSDM AI è¨ºæ–·å¹³å°ç”Ÿæˆ | Â© 2025 A2PSDM</p><p style="margin-top:20px;font-size:.9em;color:#888">å¦‚éœ€æ·±åº¦è«®è©¢æœå‹™ï¼Œè«‹è¯ç¹«ï¼šdr.cliffwang@a2psdm.com</p></div></body></html>`;

            try {
                if (isMobile) {
                    // è¡Œå‹•è£ç½®ï¼šé–‹å•Ÿå¸¶æœ‰åˆ—å°æŒ‰éˆ•çš„æ–°åˆ†é 
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                } else {
                    // æ¡Œé¢è£ç½®ï¼šä¸‹è¼‰ HTML æª”æ¡ˆ
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${fileName}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                 console.error('å ±å‘Šç”Ÿæˆå¤±æ•—:', error);
                alert('æŠ±æ­‰ï¼Œå ±å‘Šç”Ÿæˆå¤±æ•—ã€‚');
            } finally {
                hideLoading();
            }
        }

        function scheduleConsultation() {
            const subject = encodeURIComponent('A2PSDMæ·±åº¦æˆ°ç•¥è«®è©¢é ç´„ç”³è«‹');
            const body = encodeURIComponent(`ç‹åšå£«åœ˜éšŠï¼š\n\næˆ‘å·²é€éAIè¨ºæ–·å¹³å°å®Œæˆåˆæ­¥åˆ†æï¼Œå¸Œæœ›é ç´„æ·±åº¦è«®è©¢ã€‚\n\nè¨ºæ–·æŒ‘æˆ°ï¼š${diagnosisData.context?.problem || 'å¾…å¡«å¯«'}\n\næœŸå¾…æ‚¨çš„å°ˆæ¥­æŒ‡å°ï¼`);
            window.open(`mailto:dr.cliffwang@a2psdm.com?subject=${subject}&body=${body}`);
        }

        window.onload = () => {
            const modelSelectionDiv = document.getElementById('model-selection');
            availableModels.forEach(model => {
                const modelElement = document.createElement('div');
                modelElement.innerHTML = `<input type="checkbox" id="model-${model.id}" value="${model.id}" class="hidden model-checkbox" checked><label for="model-${model.id}" class="block border-2 border-gray-300 rounded-lg p-4 cursor-pointer transition-all duration-200 hover:border-michigan-blue"><h4 class="font-bold text-michigan-blue">${model.name}</h4><p class="text-sm text-gray-600 mt-1">${model.description}</p></label>`;
                modelSelectionDiv.appendChild(modelElement);
            });
            try {
                const s = getSettings();
                if (s.provider) document.getElementById('aiProvider').value = s.provider;
                if (s.apiKey) document.getElementById('apiKey').value = s.apiKey;
                runtimeSettings = s;
            } catch(e){ console.warn('è¨­å®šè¼‰å…¥å¤±æ•—', e); }
            updateProgress(1);
        };
    </script>

    <script>
      // å®‰å…¨è¦†å¯«ï¼šç¢ºä¿ renderFinalRecommendations ä¸€å®šå­˜åœ¨ï¼Œé¿å…éšæ®µ 5 å ±éŒ¯
      (function () {
        function safeText(v) {
          return (v === null || v === undefined) ? '' : String(v);
        }

        window.renderFinalRecommendations = function (data) {
          try {
            const container = document.getElementById('final-recommendations');
            if (!container) return;

            const finalData = data || (window.diagnosisData && diagnosisData.finalRecommendations) || {};
            const isEnhanced = finalData && finalData.priority_matrix;

            // å…ˆç”¨åŸæœ¬çš„ Core å‡½æ•¸æ¸²æŸ“ä¸»è¦å…§å®¹ï¼ˆè‹¥å­˜åœ¨ï¼‰
            if (typeof window.renderFinalRecommendationsCore === 'function') {
              try {
                renderFinalRecommendationsCore(finalData);
              } catch (e) {
                console.warn('renderFinalRecommendationsCore åŸ·è¡Œå¤±æ•—ï¼Œæ”¹ç”¨ç°¡åŒ–ç‰ˆæ¸²æŸ“', e);
                container.innerHTML = '<div class="bg-red-50 border-l-4 border-red-400 p-4 rounded"><p class="text-sm text-red-700">åŸæœ¬çš„æœ€çµ‚å ±å‘Šæ¸²æŸ“ç™¼ç”ŸéŒ¯èª¤ï¼Œå·²æ”¹ç”¨ç°¡åŒ–ç‰ˆå‘ˆç¾ã€‚</p></div>';
              }
            } else {
              // è‹¥ Core å‡½æ•¸ä¸å­˜åœ¨ï¼Œä½¿ç”¨èˆŠç‰ˆç°¡åŒ–å‘ˆç¾ï¼Œè‡³å°‘è®“ç•«é¢æœ‰å…§å®¹
              const insight = safeText(finalData.strategic_insight || '');
              const actions = (finalData.immediate_actions || [])
                .map(a => `<li>${(typeof a === 'object' && a !== null) ? Object.values(a).join('ï¼š ') : a}</li>`)
                .join('');

              container.innerHTML = `
                <div class="space-y-6">
                  <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize">
                    <h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸ’¡ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h4>
                    <p class="text-gray-800 leading-relaxed">${insight}</p>
                  </div>
                  ${actions ? `
                  <div class="bg-michigan-blue-lightest p-5 rounded-lg border-l-4 border-michigan-blue">
                    <h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸš€ ç«‹å³è¡Œå‹• (30å¤©å…§)</h4>
                    <ul class="list-disc list-inside text-gray-800 space-y-1">${actions}</ul>
                  </div>` : ''}
                </div>
              `;
            }

            // å†å˜—è©¦æ’å…¥æ‘˜è¦ Headerï¼ˆè‹¥æœ‰é€™å€‹å‡½æ•¸ï¼‰
            if (typeof window.buildFinalSummaryHeader === 'function') {
              try {
                const header = buildFinalSummaryHeader(finalData) || '';
                if (header && header.trim().length > 0) {
                  container.innerHTML = header + container.innerHTML;
                }
              } catch (e) {
                console.warn('buildFinalSummaryHeader åŸ·è¡Œå¤±æ•—', e);
              }
            }
          } catch (e) {
            console.error('renderFinalRecommendations è¦†å¯«ç‰ˆæœ¬ç™¼ç”ŸéŒ¯èª¤', e);
            if (typeof window.renderFinalRecommendationsError === 'function') {
              renderFinalRecommendationsError(e.message || String(e));
            }
          }
        };
      })();
    </script>
</body>
</html>

