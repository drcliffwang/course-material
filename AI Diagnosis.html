<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2PSDM AI è¨ºæ–·å¹³å° - ç‹åšå£«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        :root {
            --michigan-blue: #00274C; --michigan-maize: #FFCB05;
            --michigan-blue-light: #4A90A4; --michigan-blue-dark: #001B2E;
            --michigan-maize-light: #FFF2A6; --michigan-blue-lightest: #E8F0F7;
        }
        .text-michigan-blue { color: var(--michigan-blue); }
        .bg-michigan-blue { background-color: var(--michigan-blue); }
        .border-michigan-maize { border-color: var(--michigan-maize); }
        .text-michigan-maize { color: var(--michigan-maize); }
        .bg-michigan-maize { background-color: var(--michigan-maize); }
        .bg-michigan-blue-lightest { background-color: var(--michigan-blue-lightest); }
        .bg-michigan-maize-lightest { background-color: var(--michigan-maize-lightest); }

        .header-gradient { background: linear-gradient(135deg, var(--michigan-blue) 0%, var(--michigan-blue-light) 100%); }
        .michigan-button {
            background: linear-gradient(135deg, var(--michigan-blue), var(--michigan-blue-light)); color: var(--michigan-maize);
            transition: all 0.3s ease; border: 2px solid transparent; font-weight: 600;
        }
        .michigan-button:hover {
            background: var(--michigan-blue-dark); border-color: var(--michigan-maize);
            transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 39, 76, 0.4);
        }
        .michigan-button-secondary {
            background: var(--michigan-maize); color: var(--michigan-blue); border: 2px solid var(--michigan-blue);
            transition: all 0.3s ease; font-weight: 600;
        }
        .michigan-button-secondary:hover {
            background: var(--michigan-maize-light); transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 203, 5, 0.4);
        }
        .focus-michigan:focus {
            outline: none; box-shadow: 0 0 0 3px rgba(255, 203, 5, 0.3); border-color: var(--michigan-maize);
        }
        .card-shadow { box-shadow: 0 4px 16px rgba(0, 39, 76, 0.1); }
        .progress-bar-container { background-color: #e0e0e0; border-radius: 9999px; overflow: hidden; }
        .progress-bar {
            background-color: var(--michigan-maize); height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .model-checkbox:checked + label {
            border-color: var(--michigan-blue); background-color: var(--michigan-blue-lightest);
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 39, 76, 0.1);
        }
        .feedback-button {
            background-color: #e2e8f0; border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .feedback-button:hover { background-color: #cbd5e1; transform: scale(1.1); }
        .feedback-button.selected { background-color: var(--michigan-maize); }
        /* --- [æ–°å¢] å‰µæ–°æ–¹æ³•é ç±¤æ¨£å¼ --- */
        .innovation-tab {
            cursor: pointer; padding: 10px 20px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500; color: #4a5568;
        }
        .innovation-tab:hover {
            color: var(--michigan-blue);
            background-color: var(--michigan-blue-lightest);
        }
        .innovation-tab.active {
            color: var(--michigan-blue);
            border-bottom-color: var(--michigan-maize);
            font-weight: 700;
        }
        .innovation-content {
            display: none;
        }
        .innovation-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <header class="header-gradient shadow-lg border-b-4 border-michigan-maize sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="Cliff Baby Pic by GPT.jpg" alt="ç‹åšå£«" class="h-16 w-16 rounded-full border-2 border-michigan-maize object-cover" onerror="this.onerror=null; this.src='https://placehold.co/64x64/FFCB05/00274C?text=Dr.Wang';">
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-michigan-maize">A2PSDM AIè¨ºæ–·å¹³å°</h1>
                        <p class="text-sm text-white">ç‹åšå£« Ã— ç³»çµ±æ€ç¶­ Ã— å‰µæ–°æ¿€ç™¼</p>
                    </div>
                </div>
            </div>
             <!-- é€²åº¦æ¢ -->
            <div class="mt-4">
                <div id="progress-container" class="progress-bar-container h-2.5 w-full">
                    <div id="progress-bar" class="progress-bar" style="width: 10%;"></div>
                </div>
                <div id="progress-label" class="text-center text-xs text-white mt-1">éšæ®µ 1 / 5: èƒŒæ™¯è¨­å®š</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="space-y-8">
            <!-- API è¨­å®š -->
            <div id="api-settings" class="bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200 mb-8">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">AI å¼•æ“è¨­å®š</h2>
                <p class="text-gray-600 mb-2">API Key: ä½¿ç”¨(Gemini, GPT, Deepseek)æ¨¡å‹ï¼Œè«‹æ–¼æ­¤è™•è¨­å®šã€‚</p>
                <!-- [ä¿®æ”¹] æ–°å¢ API Key å–å¾—èªªæ˜ -->
                <p class="text-sm text-gray-500 mb-6">
                    æ‚¨çš„API Key é‡‘é‘°åªæœƒå„²å­˜åœ¨æ‚¨ç›®å‰çš„ç€è¦½å™¨ä¸­, å¯å¾ 
                    <a href="https://aistudio.google.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">Google AI Studio</a> (æ¨è–¦,å…è²»ä¸­), 
                    <a href="https://platform.deepseek.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">Deepseek</a>, æˆ– 
                    <a href="https://platform.openai.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">OpenAI</a> å–å¾—ã€‚
                </p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="aiProvider" class="block text-sm font-semibold text-michigan-blue mb-2">AI æœå‹™æä¾›å•†</label>
                        <select id="aiProvider" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                            <option value="gemini">Gemini (é è¨­)</option>
                            <option value="openai">OpenAI GPT</option>
                            <option value="deepseek">DeepSeek</option>
                        </select>
                    </div>
                    <div>
                        <label for="apiKey" class="block text-sm font-semibold text-michigan-blue mb-2">API Key (é¸å¡«)</label>
                        <input type="password" id="apiKey" placeholder="ä½¿ç”¨ API Key è«‹å¡«å¯«" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                    </div>
                </div>
                <div class="text-right mt-6">
                    <button onclick="saveSettings()" class="michigan-button px-6 py-3 rounded-lg">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </div>

            <!-- éšæ®µ 1: ä¼æ¥­èƒŒæ™¯è¨­å®š -->
            <div id="stage-1" class="bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">éšæ®µ 1: ä¼æ¥­èƒŒæ™¯è¨­å®š</h2>
                <p class="text-gray-600 mb-6">æä¾›æº–ç¢ºçš„èƒŒæ™¯è³‡è¨Šï¼Œå°‡è®“AIçš„åˆ†ææ›´è²¼è¿‘æ‚¨çš„çœŸå¯¦æƒ…æ³ã€‚</p>
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <input id="industry" type="text" placeholder="æ‰€å±¬ç”¢æ¥­ (ä¾‹å¦‚: åŠå°é«”)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                    <select id="companySize" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan" aria-label="ä¼æ¥­è¦æ¨¡">
                        <option value="æ–°å‰µå…¬å¸ (1-50äºº)">ä¼æ¥­è¦æ¨¡: æ–°å‰µå…¬å¸</option>
                        <option value="ä¸­å°å‹ä¼æ¥­ (51-500äºº)">ä¼æ¥­è¦æ¨¡: ä¸­å°å‹ä¼æ¥­</option>
                        <option value="å¤§å‹ä¼æ¥­ (501-2000äºº)">ä¼æ¥­è¦æ¨¡: å¤§å‹ä¼æ¥­</option>
                        <option value="ä¸Šå¸‚/è·¨åœ‹å…¬å¸ (2000äººä»¥ä¸Š)">ä¼æ¥­è¦æ¨¡: ä¸Šå¸‚/è·¨åœ‹å…¬å¸</option>
                    </select>
                    <input id="businessModel" type="text" placeholder="ä¸»è¦å•†æ¥­æ¨¡å¼ (ä¾‹å¦‚: B2Bç¡¬é«”éŠ·å”®)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-michigan">
                </div>
                <!-- [ä¿®æ”¹] åŠ å…¥å¸¶å…¥ç¯„ä¾‹æŒ‰éˆ• -->
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-sm font-semibold text-michigan-blue">è«‹ç°¡è¦æè¿°æ‚¨çš„æ ¸å¿ƒæŒ‘æˆ°ï¼š</label>
                    <button onclick="loadExampleChallenge()" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg transition-colors">
                        å¸¶å…¥ç¯„ä¾‹
                    </button>
                </div>
                <textarea id="problemDescription" rows="4" placeholder="ä¾‹å¦‚ï¼šå¸‚å ´ç«¶çˆ­æ¿€çƒˆã€æŠ€è¡“è½‰å‹å›°é›£ã€ç‡Ÿæ”¶æˆé•·ç·©æ…¢..." class="w-full px-4 py-4 border-2 border-gray-300 rounded-lg focus-michigan resize-none"></textarea>
                <div class="text-center mt-6">
                    <button onclick="goToStage(2)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg">â¡ï¸ é¸æ“‡è¨ºæ–·æ¨¡å‹</button>
                </div>
            </div>

            <!-- éšæ®µ 2: é¸æ“‡è¨ºæ–·æ¨¡å‹ -->
            <div id="stage-2" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-4">éšæ®µ 2: é¸æ“‡è¨ºæ–·æ¨¡å‹å·¥å…·ç®±</h2>
                <p class="text-gray-600 mb-6">è«‹é¸æ“‡æ‚¨å¸Œæœ› AI é‹ç”¨çš„ç®¡ç†åˆ†ææ¨¡å‹ã€‚é¸æ“‡è¶Šå¤šï¼Œåˆ†æç¶­åº¦è¶Šå…¨é¢ï¼Œä½†æ‰€éœ€æ™‚é–“ä¹Ÿè¶Šé•·ã€‚</p>
                <div id="model-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Models will be inserted here by JS -->
                </div>
                <div class="text-center mt-6 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(1)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸ è¿”å›èƒŒæ™¯è¨­å®š</button>
                    <button id="stage2-action-btn" onclick="runAnalysis()" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ”¬ é–‹å§‹æ·±åº¦åˆ†æ</button>
                </div>
            </div>

            <!-- éšæ®µ 3: åˆ†æå„€è¡¨æ¿ -->
            <div id="stage-3" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">éšæ®µ 3: AI ç­–ç•¥åˆ†æå„€è¡¨æ¿</h2>
                <div id="analysis-dashboard" class="space-y-6">
                    <!-- Analysis results will be appended here -->
                </div>
                 <div class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(2)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸ è¿”å›æ¨¡å‹é¸æ“‡</button>
                    <button onclick="goToStage(4)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ’¡ é€²å…¥å‰µæ–°æ–¹æ¡ˆè¨­è¨ˆ</button>
                </div>
            </div>

            <!-- éšæ®µ 4: å‰µæ–°è¨­è¨ˆ (å°å…¥é ç±¤) -->
            <div id="stage-4" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                 <h2 class="text-2xl font-bold text-michigan-blue mb-2">éšæ®µ 4: å‰µæ–°æ–¹æ¡ˆè¨­è¨ˆå·¥å…·ç®±</h2>
                 <p class="text-gray-600 mb-6">åŸºæ–¼å‰è¿°åˆ†æï¼ŒAI å°‡é‹ç”¨å¤šç¨®å‰µæ–°æ–¹æ³•ï¼Œç³»çµ±æ€§åœ°ç‚ºæ‚¨æ¿€ç™¼çªç ´æ€§çš„è§£æ±ºæ–¹æ¡ˆã€‚</p>
                
                 <!-- å‰µæ–°æ–¹æ³•é ç±¤ -->
                <div class="border-b border-gray-200 mb-6">
                    <nav id="innovation-tabs" class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button onclick="showInnovationTab('scamper')" class="innovation-tab active" data-tab="scamper">SCAMPER</button>
                        <button onclick="showInnovationTab('blue_ocean')" class="innovation-tab" data-tab="blue_ocean">è—æµ·ç­–ç•¥</button>
                        <button onclick="showInnovationTab('design_thinking')" class="innovation-tab" data-tab="design_thinking">è¨­è¨ˆæ€ç¶­</button>
                        <button onclick="showInnovationTab('lean_startup')" class="innovation-tab" data-tab="lean_startup">ç²¾å¯¦å‰µæ¥­</button>
                        <button onclick="showInnovationTab('ten_types')" class="innovation-tab" data-tab="ten_types">åå¤§å‰µæ–°é¡å‹</button>
                    </nav>
                </div>

                <!-- å‰µæ–°æ–¹æ³•å…§å®¹å®¹å™¨ -->
                <div id="innovation-content-container">
                    <div id="innovation-content-scamper" class="innovation-content active">
                        <div id="scamper-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-blue_ocean" class="innovation-content">
                        <div id="blue-ocean-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-design_thinking" class="innovation-content">
                         <div id="design-thinking-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-lean_startup" class="innovation-content">
                        <div id="lean-startup-result" class="space-y-6"></div>
                    </div>
                    <div id="innovation-content-ten_types" class="innovation-content">
                         <div id="ten-types-result" class="space-y-6"></div>
                    </div>
                </div>

                <div class="text-center mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                    <button onclick="goToStage(3)" class="michigan-button-secondary px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">â¬…ï¸ è¿”å›åˆ†æå„€è¡¨æ¿</button>
                    <button onclick="goToStage(5)" class="michigan-button px-10 py-4 rounded-lg text-lg shadow-lg w-full md:w-auto">ğŸ“„ ç”¢ç”Ÿæœ€çµ‚å ±å‘Š</button>
                </div>
            </div>
            
            <!-- éšæ®µ 5: æœ€çµ‚å ±å‘Šèˆ‡è¡Œå‹•æ–¹æ¡ˆ -->
            <div id="stage-5" class="hidden bg-white rounded-xl shadow-lg card-shadow p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-michigan-blue mb-6">éšæ®µ 5: æ•´åˆè¨ºæ–·å ±å‘Šèˆ‡è¡Œå‹•æ–¹æ¡ˆ</h2>
                <div id="final-recommendations" class="mb-8">
                    <!-- Final recommendations will be here -->
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex flex-wrap justify-center items-center gap-4">
                        <button onclick="goToStage(4)" class="michigan-button-secondary px-8 py-4 rounded-lg text-lg shadow-lg">â¬…ï¸ è¿”å›å‰µæ–°è¨­è¨ˆ</button>
                        <button onclick="generateReport()" class="michigan-button px-8 py-4 rounded-lg text-lg shadow-lg">ğŸ“¥ ä¸‹è¼‰å°ˆæ¥­è¨ºæ–·å ±å‘Š</button>
                        <button onclick="scheduleConsultation()" class="michigan-button-secondary px-8 py-4 rounded-lg text-lg shadow-lg">ğŸ“… é ç´„ç‹åšå£«æ·±åº¦è«®è©¢</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 text-center shadow-2xl max-w-sm mx-auto">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-michigan-blue mx-auto mb-6"></div>
            <p class="text-xl font-semibold text-michigan-blue mb-2">ç‹åšå£«çš„AIé¡§å•æ­£åœ¨ç‚ºæ‚¨åˆ†æ...</p>
            <p id="loadingMessage" class="text-sm text-gray-600">å•Ÿå‹•ç³»çµ±æ€§æ€ç¶­å¼•æ“</p>
        </div>
    </div>
    
    <footer class="bg-michigan-blue text-white py-8 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p class="font-semibold text-michigan-maize">A2PSDM | ç‹åšå£«</p>
            <p class="text-gray-400 mt-1">Â© 2025 A2PSDM Ã— å¯†è¥¿æ ¹å¤§å­¸å­¸è¡“å‚³æ‰¿ Ã— AIå‰µæ–°æŠ€è¡“</p>
        </div>
    </footer>

    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
        let diagnosisData = { stage: 1 };
        
        // è¨­å®šä¿å­˜ï¼šlocalStorage
        const SETTINGS_KEY = 'a2psdm_ai_settings_v1';
        function getSettings() {
            try {
                const raw = localStorage.getItem(SETTINGS_KEY);
                return raw ? JSON.parse(raw) : { provider: 'gemini', apiKey: '' };
            } catch(e) {
                return { provider: 'gemini', apiKey: '' };
            }
        }
        function setSettings(s) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
        }
        let runtimeSettings = getSettings();

        const DR_WANG_PERSONA = `æ‚¨æ˜¯ä¸€ä½åœ¨å¯†è¥¿æ ¹å¤§å­¸å—éåš´æ ¼å­¸è¡“è¨“ç·´ã€æ“æœ‰30å¹´ç”¢æ¥­é¡§å•ç¶“é©—çš„åšå£«ç´šå°ˆå®¶ç‹å•Ÿå²³ã€‚æ‚¨çš„åˆ†æçµåˆäº†ç³»çµ±æ€§ã€çµæ§‹åŒ–çš„é‚è¼¯æ€ç¶­èˆ‡å‰µæ–°çš„è§£æ±ºæ–¹æ¡ˆè¨­è¨ˆã€‚è«‹ä»¥å°ˆæ¥­ã€ç²¾æº–ã€å…·æ´å¯ŸåŠ›çš„èªæ°£ï¼Œæä¾›æˆ°ç•¥å±¤ç´šçš„å»ºè­°ï¼Œä¸¦åªä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚`;
        
        const availableModels = [
            { id: 'swot', name: 'SWOT åˆ†æ', description: 'è©•ä¼°å…§éƒ¨å„ªåŠ£å‹¢èˆ‡å¤–éƒ¨æ©Ÿæœƒå¨è„…ï¼Œæä¾›æˆ°ç•¥å…¨å±€è§€ã€‚' },
            { id: 'porters', name: 'æ³¢ç‰¹äº”åŠ›åˆ†æ', description: 'åˆ†æç”¢æ¥­ç«¶çˆ­çµæ§‹ï¼Œåˆ¤æ–·ç”¢æ¥­å¸å¼•åŠ›èˆ‡ç²åˆ©æ½›åŠ›ã€‚' },
            { id: 'pestel', name: 'PESTEL åˆ†æ', description: 'æƒæç¸½é«”ç’°å¢ƒä¸­çš„æ”¿æ²»ã€ç¶“æ¿Ÿã€ç¤¾æœƒã€æŠ€è¡“ã€ç’°å¢ƒã€æ³•å¾‹ç­‰é—œéµå› ç´ ã€‚' },
            { id: 'bmc', name: 'å•†æ¥­æ¨¡å¼ (BMC)', description: 'è§£æ§‹ä¸¦å¯è¦–åŒ–å•†æ¥­æ¨¡å¼çš„ä¹å€‹æ ¸å¿ƒè¦ç´ ï¼Œå°‹æ‰¾å‰µæ–°é»ã€‚' },
            { id: 'vpc', name: 'åƒ¹å€¼ä¸»å¼µåˆ†æ (VPC)', description: 'è¨­è¨ˆé¡§å®¢çœŸæ­£éœ€è¦çš„ç”¢å“èˆ‡æœå‹™ï¼Œå‰µé€ åƒ¹å€¼å¥‘åˆã€‚' }
        ];

        // --- [æ–°å¢] å¸¶å…¥ç¯„ä¾‹æŒ‘æˆ°çš„å‡½æ•¸ ---
        function loadExampleChallenge() {
            document.getElementById('industry').value = "ä»£å·¥å‚³ç”¢OEM/ODM";
            document.getElementById('companySize').value = "ä¸­å°å‹ä¼æ¥­ (51-500äºº)";
            document.getElementById('businessModel').value = "å‚³çµ±è»Šä»¶èˆ‡é‡‘å±¬åŠ å·¥";
            const exampleText = "éå»äºŒåå¹´ï¼Œæˆ‘å€‘å¾åšå‚³çµ±è»Šä»¶èˆ‡é‡‘å±¬åŠ å·¥çš„ä»£å·¥å‚³ç”¢ï¼Œæ“´å±•åˆ°æ¨¡çµ„åŒ–çµ„è£èˆ‡ODMï¼Œé–‹å§‹ç´¯ç©æŠ€è¡“èˆ‡è¨­è¨ˆèƒ½é‡ã€‚10å¹´å‰é–‹å§‹å“ç‰Œä¹‹è·¯ã€‚æˆ‘å€‘èˆ‡ä¸–ç•Œç´šæ‰‹å·¥å…·å“ç‰Œè¯ååˆä½œï¼Œé€æ¼¸æ‰“éŸ¿åè™Ÿï¼›ç›®å‰å“ç‰Œç‡Ÿæ”¶å ç¸½ç‡Ÿæ”¶çš„ä¸‰åˆ†ä¹‹ä¸€ï¼Œä¹Ÿå°‡å…¬å¸æ¯›åˆ©æé«˜å…©æˆã€‚ç„¶è€Œï¼Œåšå“ç‰Œéœ€è¦çš„äººæ‰èˆ‡ä»£å·¥çš„äººæ‰ï¼Œæ˜¯å…©ç¨®æˆªç„¶ä¸åŒçš„ã€Œç‰©ç¨®ã€ ã€‚æˆ‘å€‘å¾å¤–éƒ¨æ‰¾äººä¾†åšå“ç‰Œï¼Œå›°é›£é‡é‡ï¼šé¦–å…ˆï¼Œé–‹ä¸èµ·å¸‚å ´è¡Œæƒ…åƒ¹ï¼›å…¶æ¬¡ï¼Œäººæ‰é€²ä¾†é›£ä»¥æºé€šã€æ°´åœŸä¸æœï¼›ç¬¬ä¸‰ï¼Œç£¨åˆä¸é †å¾Œé›¢è·ï¼Œåˆå¾—å¾é ­ä¾†éã€‚å¦æ–¹é¢ï¼Œæˆ‘å€‘ä¹ŸåŒæ­¥å…§éƒ¨åŸ¹é¤Šã€‚å·¥å» è£¡çš„è€å“¡å·¥è¦å¾éå»çš„ã€Œäº¤è²¨é‚è¼¯ã€åˆ‡æ›åˆ°ã€Œåƒ¹å€¼å‰µé€ é‚è¼¯ã€ï¼Œéœ€è¦æ™‚é–“ç£¨ã€‚ä½†å®¢æˆ¶ã€å¸‚å ´ã€ç«¶çˆ­è€…æ­¥æ­¥ç·Šé€¼ï¼Œç©¶ç«Ÿè¦æŠ•å…¥è³‡æºåŸ¹é¤ŠåŸæœ‰åœ˜éšŠï¼Œä»¥æ±‚ç©©å®šæ–‡åŒ–ã€æ…¢æ…¢è½‰å‹ï¼Ÿé‚„æ˜¯å¾å¤–éƒ¨æ‹›å‹Ÿå“ç‰Œé«˜æ‰‹ï¼Œå†’è‘—æ–‡åŒ–è¡çªçš„é¢¨éšªï¼Œä¾†æ›å–è½‰å‹é€Ÿåº¦ï¼Ÿåšå“ç‰Œï¼Œç”¢å“åªæ˜¯å…¥å ´åˆ¸ï¼ŒçœŸæ­£çš„æˆ°å ´åœ¨æ–¼ã€Œçµ„ç¹”èƒ½ä¸èƒ½è·Ÿä¸Šå“ç‰Œè…³æ­¥ã€ã€‚";
            document.getElementById('problemDescription').value = exampleText;
        }

        // --- UI æ§åˆ¶ ---
        function updateProgress(stage) {
            diagnosisData.stage = stage;
            const totalStages = 5;
            const percentage = (stage / totalStages) * 100;
            const labels = ["èƒŒæ™¯è¨­å®š", "é¸æ“‡æ¨¡å‹", "åˆ†æå„€è¡¨æ¿", "å‰µæ–°è¨­è¨ˆ", "æœ€çµ‚å ±å‘Š"];
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-label').textContent = `éšæ®µ ${stage} / ${totalStages}: ${labels[stage-1]}`;
        }
        
        async function goToStage(stageNumber) {
            if (stageNumber === 2) {
                const newContext = {
                    industry: document.getElementById('industry').value.trim(),
                    companySize: document.getElementById('companySize').value,
                    businessModel: document.getElementById('businessModel').value.trim(),
                    problem: document.getElementById('problemDescription').value.trim()
                };

                if (!newContext.industry || !newContext.problem) {
                    alert('è«‹å¡«å¯«ã€Œæ‰€å±¬ç”¢æ¥­ã€èˆ‡ã€Œæ ¸å¿ƒæŒ‘æˆ°ã€ä»¥åˆ©åˆ†æã€‚'); 
                    return;
                }
                
                if(JSON.stringify(diagnosisData.context) !== JSON.stringify(newContext)) {
                    diagnosisData.analysisResults = {};
                    diagnosisData.scamper = null;
                    diagnosisData.blue_ocean = null;
                    diagnosisData.design_thinking = null;
                    diagnosisData.lean_startup = null;
                    diagnosisData.ten_types = null;
                    diagnosisData.finalRecommendations = null;
                }
                diagnosisData.context = newContext;
            }
            
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`stage-${i}`).classList.add('hidden');
            }
            document.getElementById('api-settings').classList.add('hidden');

            const targetStage = document.getElementById(`stage-${stageNumber}`);
            if (targetStage) {
                targetStage.classList.remove('hidden');
                updateProgress(stageNumber);
                window.scrollTo({ top: targetStage.offsetTop - 120, behavior: 'smooth' });
                
                if (stageNumber === 2) {
                    const actionButton = document.getElementById('stage2-action-btn');
                    const analysisDone = diagnosisData.analysisResults && Object.keys(diagnosisData.analysisResults).length > 0;
                    if (analysisDone) {
                        actionButton.textContent = 'â¡ï¸ æŸ¥çœ‹åˆ†æçµæœ';
                        actionButton.onclick = () => goToStage(3);
                    } else {
                        actionButton.textContent = 'ğŸ”¬ é–‹å§‹æ·±åº¦åˆ†æ';
                        actionButton.onclick = runAnalysis;
                    }
                }

                if (stageNumber === 4 && !diagnosisData.scamper) {
                    showInnovationTab('scamper');
                } else if (stageNumber === 5 && !diagnosisData.finalRecommendations) {
                    await generateFinalRecommendationsAnalysis();
                }
            }
        }
        
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        function saveSettings() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            runtimeSettings = { provider, apiKey };
            setSettings(runtimeSettings);
            
            let message = 'âœ… è¨­å®šå·²å„²å­˜ï¼\n\n';
            
            if (provider === 'gemini') {
                message += 'ğŸ¯ Gemini å·²å„ªåŒ–ç‚ºæœ€ä½³å‰ç«¯é«”é©—ï¼Œå°‡æä¾›ç©©å®šçš„åˆ†ææœå‹™ã€‚';
            } else {
                message += `âš ï¸ ${provider.toUpperCase()} è¨­å®šå®Œæˆã€‚\n\n`;
                message += 'ğŸ“‹ ç›¸å®¹æ€§èªªæ˜ï¼š\n';
                message += 'â€¢ ç³»çµ±å·²æ¡ç”¨ç¶“éé©—è­‰çš„ API èª¿ç”¨æ¶æ§‹\n';
                message += 'â€¢ å¦‚é‡é€£ç·šå•é¡Œï¼Œå°‡æä¾›è©³ç´°è¨ºæ–·è³‡è¨Š\n';
                message += 'â€¢ å»ºè­°åŒæ™‚è¨­å®š Gemini ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ';
            }
            
            alert(message);
            
            testConnectivity(provider, apiKey).catch(e => 
                console.warn('é€£ç·šæ¸¬è©¦çµæœ:', e.message)
            );
        }

        async function callAI(prompt, retries = 3, delay = 1000) {
            const provider = (runtimeSettings?.provider || 'gemini').toLowerCase();
            const key = runtimeSettings?.apiKey || '';

            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    let response;
                    if (provider === 'gemini') {
                        response = await callGeminiAPI(prompt, key);
                    } else if (provider === 'openai') {
                        if (!key) throw new Error('OpenAI éœ€è¦ API Keyï¼Œè«‹å…ˆè¨­å®šã€‚');
                        response = await callOpenAIAPI(prompt, key);
                    } else if (provider === 'deepseek') {
                        if (!key) throw new Error('DeepSeek éœ€è¦ API Keyï¼Œè«‹å…ˆè¨­å®šã€‚');
                        response = await callDeepSeekAPI(prompt, key);
                    } else {
                        throw new Error('ä¸æ”¯æ´çš„ AI æä¾›å•†');
                    }
                    return response;
                } catch (error) {
                    console.error(`AI èª¿ç”¨å¤±æ•— (å˜—è©¦ ${attempt + 1}/${retries + 1}):`, error);
                    if (error.message.includes('API key not valid') || error.message.includes('æ¬Šé™') || error.message.includes('API Key')) {
                        throw new Error(`API Key é©—è­‰å¤±æ•—æˆ–æ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥æ‚¨çš„ ${provider.toUpperCase()} API Key è¨­å®šã€‚`);
                    }
                    if (attempt < retries) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, attempt)));
                        continue;
                    }
                    throw new Error(`å˜—è©¦ ${retries + 1} æ¬¡å¾Œï¼ŒAI åˆ†æä»ç„¶å¤±æ•—: ${error.message}`);
                }
            }
        }

        async function callGeminiAPI(prompt, apiKey) {
            const model = 'gemini-2.5-flash';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const combinedPrompt = `${DR_WANG_PERSONA}\n\n[è¨ºæ–·åˆ†æè«‹æ±‚]\n${prompt}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: combinedPrompt }] }],
                generationConfig: { 
                    temperature: 0.5, topK: 40, topP: 0.95,
                    response_mime_type: "application/json",
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `Gemini API éŒ¯èª¤ ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\nè©³ç´°éŒ¯èª¤ï¼š${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\nå›æ‡‰å…§å®¹ï¼š${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (!candidate?.content?.parts?.[0]?.text) {
                 if (result.promptFeedback?.blockReason) {
                    throw new Error(`Gemini è«‹æ±‚è¢«é˜»æ“‹ï¼ŒåŸå› ï¼š${result.promptFeedback.blockReason}`);
                }
                throw new Error(`Gemini å›æ‡‰æ ¼å¼ç•°å¸¸ï¼š${JSON.stringify(result, null, 2)}`);
            }
            return candidate.content.parts[0].text;
        }

        async function callOpenAIAPI(prompt, apiKey) {
            const apiUrl = 'https://api.openai.com/v1/chat/completions';
            const payload = {
                model: 'gpt-4o-mini',
                messages: [ { role: 'system', content: DR_WANG_PERSONA }, { role: 'user', content: prompt } ],
                response_format: { type: "json_object" },
                temperature: 0.5
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `OpenAI API éŒ¯èª¤ ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\nè©³ç´°éŒ¯èª¤ï¼š${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\nå›æ‡‰å…§å®¹ï¼š${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            if (!result.choices?.[0]?.message?.content) { throw new Error(`OpenAI å›æ‡‰æ ¼å¼ç•°å¸¸ï¼š${JSON.stringify(result, null, 2)}`); }
            return result.choices[0].message.content;
        }

        async function callDeepSeekAPI(prompt, apiKey) {
            const apiUrl = 'https://api.deepseek.com/v1/chat/completions';
            const payload = {
                model: 'deepseek-chat',
                messages: [ { role: 'system', content: DR_WANG_PERSONA }, { role: 'user', content: prompt } ],
                response_format: { type: "json_object" },
                temperature: 0.5
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!response.ok) {
                let errorDetails = `DeepSeek API éŒ¯èª¤ ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorDetails += `\nè©³ç´°éŒ¯èª¤ï¼š${JSON.stringify(errorBody.error?.message || errorBody, null, 2)}`;
                } catch (e) {
                    errorDetails += `\nå›æ‡‰å…§å®¹ï¼š${await response.text()}`;
                }
                throw new Error(errorDetails);
            }
            const result = await response.json();
            if (!result.choices?.[0]?.message?.content) { throw new Error(`DeepSeek å›æ‡‰æ ¼å¼ç•°å¸¸ï¼š${JSON.stringify(result, null, 2)}`); }
            return result.choices[0].message.content;
        }

        async function testConnectivity(provider, apiKey) {
            try {
                if (!apiKey && provider !== 'gemini') { return false; }
                const testPrompt = 'Hello, this is a connection test, please reply with only {"status": "ok"}';
                const response = await callAI(testPrompt);
                console.log('é€£ç·šæ¸¬è©¦æˆåŠŸ', response);
                return true;
            } catch (error) {
                console.error('é€£ç·šæ¸¬è©¦å¤±æ•—:', error.message);
                return false;
            }
        }

        async function runAnalysis() {
            const selectedModels = Array.from(document.querySelectorAll('.model-checkbox:checked')).map(cb => cb.value);
            if (selectedModels.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†ææ¨¡å‹ã€‚'); 
                return;
            }
  
            let orderedModels = selectedModels.slice();
            const vpcIndex = orderedModels.indexOf('vpc');
            const bmcIndex = orderedModels.indexOf('bmc');
            if (vpcIndex > -1 && bmcIndex > -1 && vpcIndex > bmcIndex) {
                 orderedModels = orderedModels.filter(m => m !== 'vpc');
                 orderedModels.splice(bmcIndex, 0, 'vpc');
            }
           
            diagnosisData.selectedModels = orderedModels;
            diagnosisData.analysisResults = {};

            goToStage(3);
            const dashboard = document.getElementById('analysis-dashboard');
            dashboard.innerHTML = '';

            for (const modelId of orderedModels) {
                showLoading(`æ­£åœ¨åŸ·è¡Œ ${availableModels.find(m=>m.id === modelId).name}...`);
                try {
                    const prompt = window[`get${modelId.charAt(0).toUpperCase() + modelId.slice(1)}Prompt`]();
                    const response = await callAI(prompt);
                    const result = safeJSONParse(response);
                    if (result.error) throw new Error(result.message);
                    diagnosisData.analysisResults[modelId] = result;
                    renderAnalysisCard(modelId, result);
                } catch (error) {
                    console.error(`${modelId} åˆ†æå¤±æ•—:`, error);
                    renderErrorCard(modelId, error.message);
                }
            }
            hideLoading();
            
            const actionButton = document.getElementById('stage2-action-btn');
            actionButton.textContent = 'â¡ï¸ æŸ¥çœ‹åˆ†æçµæœ';
            actionButton.onclick = () => goToStage(3);
        }

        async function showInnovationTab(method) {
            document.querySelectorAll('.innovation-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === method));
            document.querySelectorAll('.innovation-content').forEach(content => content.classList.toggle('active', content.id === `innovation-content-${method}`));
            if (!diagnosisData[method]) {
                const generator = window[`generate${method.charAt(0).toUpperCase() + method.slice(1)}Analysis`];
                if (generator) await generator();
            }
        }

        async function generateAnalysisForMethod(method, promptFunction, renderFunction) {
            const methodKey = method.toLowerCase().replace(/ /g, '_');
            showLoading(`AI æ­£åœ¨é‹ç”¨ ${method.toUpperCase()} é€²è¡Œå‰µæ–°è¨­è¨ˆ...`);
            try {
                const prompt = promptFunction();
                const response = await callAI(prompt);
                const result = safeJSONParse(response);
                if (result.error) throw new Error(result.message);
                diagnosisData[methodKey] = result; 
                renderFunction(result);
            } catch (error) {
                console.error(`${method} åˆ†æå¤±æ•—:`, error);
                const container = document.getElementById(`${methodKey}-result`);
                if(container) {
                    container.innerHTML = `<div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-500"><h4 class="font-bold text-red-800">${method} å‰µæ–°æ–¹æ¡ˆç”Ÿæˆå¤±æ•—</h4><p class="text-sm text-red-700 mt-1">åŸå› ï¼š${error.message}</p></div>`;
                }
            } finally {
                hideLoading();
            }
        }
        
        async function generateScamperAnalysis() { await generateAnalysisForMethod('SCAMPER', getScamperPrompt, renderScamper); }
        async function generateBlue_oceanAnalysis() { await generateAnalysisForMethod('Blue Ocean', getBlueOceanPrompt, renderBlueOcean); }
        async function generateDesign_thinkingAnalysis() { await generateAnalysisForMethod('Design Thinking', getDesignThinkingPrompt, renderDesignThinking); }
        async function generateLean_startupAnalysis() { await generateAnalysisForMethod('Lean Startup', getLeanStartupPrompt, renderLeanStartup); }
        async function generateTen_typesAnalysis() { await generateAnalysisForMethod('Ten Types', getTenTypesPrompt, renderTenTypes); }
        
        async function generateFinalRecommendationsAnalysis() {
            showLoading('AI æ­£åœ¨æ•´åˆæœ€çµ‚æˆ°ç•¥å»ºè­°...');
            try {
                const finalPrompt = getFinalRecommendationsPrompt();
                const finalResponse = await callAI(finalPrompt);
                const finalResult = safeJSONParse(finalResponse);
                if (finalResult.error) throw new Error(finalResult.message);
                diagnosisData.finalRecommendations = finalResult;
                renderFinalRecommendations(finalResult);
            } catch (error) {
                console.error('æœ€çµ‚å»ºè­°ç”Ÿæˆå¤±æ•—:', error);
                renderFinalRecommendationsError(error.message);
            } finally {
                hideLoading();
            }
        }
        
        function getBasePromptContext() {
            return `
                **ä¼æ¥­èƒŒæ™¯:**
                - ç”¢æ¥­: ${diagnosisData.context.industry}
                - è¦æ¨¡: ${diagnosisData.context.companySize}
                - å•†æ¥­æ¨¡å¼: ${diagnosisData.context.businessModel}
                - æ ¸å¿ƒæŒ‘æˆ°: ${diagnosisData.context.problem}
                **å·²å®Œæˆçš„ç­–ç•¥åˆ†ææ‘˜è¦ (JSONæ ¼å¼):**
                ${JSON.stringify(diagnosisData.analysisResults || {}, null, 2)}
                è«‹ä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸¦åš´æ ¼éµå®ˆæŒ‡å®šçš„JSONè¼¸å‡ºæ ¼å¼ã€‚
            `;
        }

        function getSwotPrompt() {
            return `${getBasePromptContext()}
            è«‹å°æ­¤ä¼æ¥­è¿›è¡ŒSWOTåˆ†æã€‚ç‚ºæ¯å€‹è±¡é™æä¾› 3 åˆ° 4 å€‹æœ€é—œéµçš„æ´å¯Ÿã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "strengths": [], "weaknesses": [], "opportunities": [], "threats": [] }`;
        }

        function getPortersPrompt() {
            return `${getBasePromptContext()}
            è«‹é‹ç”¨æ³¢ç‰¹äº”åŠ›æ¨¡å‹åˆ†æã€‚ç‚ºæ¯ä¸€ç¨®åŠ›é‡é€²è¡Œè©•åˆ†ï¼ˆé«˜ã€ä¸­ã€ä½ï¼‰ä¸¦æä¾›ç†ç”±ï¼Œæœ€å¾Œçµ¦å‡ºç¸½çµã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "forces": [ {"name": "æ–°é€²å…¥è€…çš„å¨è„…", "level": "é«˜/ä¸­/ä½", "reason": ""} ], "summary": "" }`;
        }
        
        function getPestelPrompt() {
             return `${getBasePromptContext()}
            è«‹é‹ç”¨PESTELæ¨¡å‹åˆ†æã€‚ç‚ºæ¯å€‹å› ç´ æ‰¾å‡º 2-3 å€‹æœ€ç›¸é—œçš„è¶¨å‹¢æˆ–å½±éŸ¿ã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "political": [], "economic": [], "social": [], "technological": [], "environmental": [], "legal": [] }`;
        }

        function getVpcPrompt() {
            return `${getBasePromptContext()}
            è«‹é€²è¡Œåƒ¹å€¼ä¸»å¼µåˆ†æ(VPC)ã€‚ç‚ºã€Œé¡§å®¢è¼ªå»“ã€èˆ‡ã€Œåƒ¹å€¼åœ°åœ–ã€å„å€å¡Šæä¾› 2-3 å€‹æ´å¯Ÿã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "customer_profile": { "jobs": [], "pains": [], "gains": [] }, "value_map": { "products_services": [], "pain_relievers": [], "gain_creators": [] } }`;
        }

        function getBmcPrompt() {
            return `${getBasePromptContext()}
            è«‹å»ºæ§‹å•†æ¥­æ¨¡å¼ BMCã€‚ç‚ºä¹å€‹æ¨¡å¡Šå„æä¾›2-3å€‹æ ¸å¿ƒè¦é»ã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "customer_segments": [], "value_propositions": [], "channels": [], "customer_relationships": [], "revenue_streams": [], "key_activities": [], "key_resources": [], "key_partnerships": [], "cost_structure": [] }`;
        }

        function getScamperPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨SCAMPERç™¼æƒ³å‰µæ–°æ–¹æ¡ˆã€‚å…ˆæç…‰3-4å€‹ã€Œæˆ°ç•¥è­°é¡Œã€ï¼Œå†é‡å°è­°é¡Œç”¨ä¸ƒæŠ€æ³•æ§‹æ€æ–¹æ¡ˆï¼Œæœ€å¾Œé¸å‡ºå‰5å„ªå…ˆæ–¹æ¡ˆã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "strategic_insights": [ { "issue": "", "description": "", "data_sources": [] } ], "scamper_solutions": [ { "technique": "S/C/A/M/P/E/R", "strategic_issue": "", "solution": { "title": "", "description": "", "expected_benefits": [] } } ], "priority_ranking": [] }`;
        }

        function getBlueOceanPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œè—æµ·ç­–ç•¥ã€çš„ã€Œå››é …è¡Œå‹•æ¶æ§‹ã€(ERRC)é‡æ§‹ç”¢æ¥­å…ƒç´ ã€‚ç‚ºã€Œæ¶ˆé™¤ã€ã€ã€Œæ¸›å°‘ã€ã€ã€Œæå‡ã€ã€ã€Œå‰µé€ ã€å„æå‡º 2-3 å€‹ç­–ç•¥å»ºè­°ã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "eliminate": [ {"action": "", "rationale": ""} ], "reduce": [ {"action": "", "rationale": ""} ], "raise": [ {"action": "", "rationale": ""} ], "create": [ {"action": "", "rationale": ""} ] }`;
        }

        function getDesignThinkingPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œè¨­è¨ˆæ€ç¶­ã€äº”éšæ®µï¼Œè¦åŠƒä»¥ä½¿ç”¨è€…ç‚ºä¸­å¿ƒçš„è§£æ±ºæ–¹æ¡ˆæµç¨‹ã€‚ç‚ºæ¯éšæ®µæä¾› 2-3 å€‹é—œéµè¡Œå‹•æˆ–å•é¡Œã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "stages": [ { "stage": "1. åŒç†å¿ƒ", "description": "", "actions": [] } ] }`;
        }
        
        function getLeanStartupPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œç²¾å¯¦å‰µæ¥­ã€å¾ªç’°ï¼Œæå‡ºå¿«é€Ÿé©—è­‰å•†æ¥­æ§‹æƒ³çš„è¡Œå‹•è¨ˆç•«ã€‚å®šç¾©å‡è¨­ã€MVPèˆ‡è¡¡é‡æŒ‡æ¨™ã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "title": "", "build": { "phase_name": "å»ºç«‹", "key_hypothesis": "", "mvp_suggestion": { "name": "", "description": "", "features": [] } }, "measure": { "phase_name": "è¡¡é‡", "key_metrics": [ {"metric": "", "definition": ""} ], "measurement_method": "" }, "learn": { "phase_name": "å­¸ç¿’", "pivot_or_persevere": "", "learning_questions": [] } }`;
        }

        function getTenTypesPrompt() {
            return `${getBasePromptContext()}
            [ä»»å‹™] é‹ç”¨ã€Œåå¤§å‰µæ–°é¡å‹ã€æ¡†æ¶ï¼Œå¾ã€Œçµæ§‹ã€ã€ã€Œç”¢å“ã€å’Œã€Œé«”é©—ã€ä¸‰ç¶­åº¦ï¼Œç‚ºå„é¡å‹æä¾› 1-2 å€‹å‰µæ–°æ§‹æƒ³ã€‚
            [è¼¸å‡ºæ ¼å¼(JSONï¼Œåš´æ ¼éµå®ˆ)]
            { "categories": [ { "name": "çµæ§‹", "description": "", "types": [ {"type_name": "", "ideas": []} ] } ] }`;
        }

        function getFinalRecommendationsPrompt() {
             const innovationSummary = {};
             if (diagnosisData.scamper) innovationSummary.scamper = diagnosisData.scamper.priority_ranking;
             if (diagnosisData.blue_ocean) innovationSummary.blue_ocean = diagnosisData.blue_ocean;
             if (diagnosisData.design_thinking) innovationSummary.design_thinking = { stage1: diagnosisData.design_thinking.stages[0].actions, stage2: diagnosisData.design_thinking.stages[1].actions};
             if (diagnosisData.lean_startup) innovationSummary.lean_startup = { hypothesis: diagnosisData.lean_startup.build.key_hypothesis, mvp: diagnosisData.lean_startup.build.mvp_suggestion.name };
             if (diagnosisData.ten_types) innovationSummary.ten_types = { top_idea: diagnosisData.ten_types.categories[0].types[0].ideas[0] };
             const allDataSummary = JSON.stringify({ context: diagnosisData.context, analysisResults: diagnosisData.analysisResults, innovationSummary: innovationSummary }, null, 2);
             return `${DR_WANG_PERSONA}
            è¨ºæ–·æ•¸æ“šæ‘˜è¦: ${allDataSummary}
            è«‹ç¶œåˆæ‰€æœ‰ä¿¡æ¯ï¼Œæä¾›æ•´åˆæˆ°ç•¥å»ºè­°ã€‚åŒ…å«ï¼š1. æ ¸å¿ƒæ´å¯Ÿ, 2. ç«‹å³è¡Œå‹•(30å¤©), 3. å­£åº¦è·¯ç·šåœ–, 4. é•·æœŸé¡˜æ™¯ã€‚
            **è¼¸å‡ºæ ¼å¼ (åš´æ ¼éµå®ˆæ­¤JSONçµæ§‹):**
            { "strategic_insight": "", "immediate_actions": [], "quarterly_roadmap": [ {"quarter": "Q1", "focus": ""} ], "long_term_vision": "" }`;
        }

        // --- æ¸²æŸ“å‡½æ•¸ ---
        function renderAnalysisCard(modelId, data) {
            const model = availableModels.find(m => m.id === modelId);
            const container = document.createElement('div');
            container.className = 'bg-michigan-blue-lightest p-6 rounded-xl border-l-4 border-michigan-blue card-shadow';
            container.innerHTML = `
                <details open>
                    <summary class="font-bold text-michigan-blue text-xl cursor-pointer list-none flex justify-between items-center">
                        <span>${model.name}</span>
                        <span class="text-sm font-normal text-gray-500 hover:underline">é»æ“Šå±•é–‹/æ”¶åˆ</span>
                    </summary>
                    <div class="mt-4" id="content-${modelId}"></div>
                </details>
                <div class="flex justify-end items-center mt-4 gap-2">
                    <span class="text-xs text-gray-500">é€™å€‹åˆ†ææœ‰å¹«åŠ©å—ï¼Ÿ</span>
                    <button class="feedback-button" onclick="giveFeedback(this, '${modelId}', 'good')">ğŸ‘</button>
                    <button class="feedback-button" onclick="giveFeedback(this, '${modelId}', 'bad')">ğŸ‘</button>
                </div>`;
            document.getElementById('analysis-dashboard').appendChild(container);
            const contentDiv = document.getElementById(`content-${modelId}`);
            window[`render${modelId.charAt(0).toUpperCase() + modelId.slice(1)}`](contentDiv, data);
        }
        
        function renderSwot(container, data) {
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded-lg"><h4 class="font-bold text-green-800 mb-2">å„ªå‹¢(S)</h4><ul class="list-disc list-inside text-sm text-green-700 space-y-1">${(data.strengths || []).map(s => `<li>${s}</li>`).join('')}</ul></div>
                    <div class="bg-red-100 p-4 rounded-lg"><h4 class="font-bold text-red-800 mb-2">åŠ£å‹¢(W)</h4><ul class="list-disc list-inside text-sm text-red-700 space-y-1">${(data.weaknesses || []).map(w => `<li>${w}</li>`).join('')}</ul></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><h4 class="font-bold text-blue-800 mb-2">æ©Ÿæœƒ(O)</h4><ul class="list-disc list-inside text-sm text-blue-700 space-y-1">${(data.opportunities || []).map(o => `<li>${o}</li>`).join('')}</ul></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><h4 class="font-bold text-yellow-800 mb-2">å¨è„…(T)</h4><ul class="list-disc list-inside text-sm text-yellow-700 space-y-1">${(data.threats || []).map(t => `<li>${t}</li>`).join('')}</ul></div>
                </div>`;
        }
        
        function renderPorters(container, data) {
            const levelColor = { 'é«˜': 'bg-red-500', 'ä¸­': 'bg-yellow-500', 'ä½': 'bg-green-500' };
            container.innerHTML = `<div class="space-y-3 mb-4">
                ${(data.forces || []).map(f => `<div class="p-3 bg-white rounded-lg border"><div class="flex items-center justify-between"><h5 class="font-semibold text-michigan-blue">${f.name}</h5><span class="px-3 py-1 text-white text-xs rounded-full ${levelColor[f.level] || 'bg-gray-400'}">${f.level}</span></div><p class="text-sm text-gray-600 mt-1">${f.reason}</p></div>`).join('')}
                </div>
                <div class="p-4 bg-michigan-maize-lightest rounded-lg"><h5 class="font-bold text-michigan-blue">ç¸½çµ</h5><p class="text-sm text-gray-700">${data.summary || ''}</p></div>`;
        }

        function renderPestel(container, data) {
            const labels = { political: 'æ”¿æ²»', economic: 'ç¶“æ¿Ÿ', social: 'ç¤¾æœƒ', technological: 'æŠ€è¡“', environmental: 'ç’°å¢ƒ', legal: 'æ³•å¾‹' };
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${Object.entries(data || {}).map(([key, value]) => `<div class="bg-white p-4 rounded-lg border"><h4 class="font-bold text-michigan-blue mb-2">${labels[key] || key}</h4><ul class="list-disc list-inside text-sm text-gray-700 space-y-1">${(value || []).map(v => `<li>${v}</li>`).join('')}</ul></div>`).join('')}
            </div>`;
        }

        function renderBmc(container, data) {
            const renderList = (items) => (items || []).map(item => `<li>${item}</li>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-5 gap-4 text-xs md:text-sm">
                    <div class="md:col-span-1 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">é—œéµåˆä½œå¤¥ä¼´</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_partnerships)}</ul> </div>
                    <div class="md:col-span-1 space-y-4"> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é—œéµæ´»å‹•</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_activities)}</ul> </div> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é—œéµè³‡æº</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.key_resources)}</ul> </div> </div>
                    <div class="md:col-span-1 bg-michigan-maize-lightest p-2 md:p-4 rounded-lg border-2 border-michigan-maize"> <h4 class="font-bold text-michigan-blue mb-2">åƒ¹å€¼ä¸»å¼µ</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.value_propositions)}</ul> </div>
                    <div class="md:col-span-1 space-y-4"> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é¡§å®¢é—œä¿‚</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.customer_relationships)}</ul> </div> <div class="bg-white p-2 md:p-4 rounded-lg border h-1/2"> <h4 class="font-bold text-michigan-blue mb-2">é€šè·¯</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.channels)}</ul> </div> </div>
                    <div class="md:col-span-1 bg-michigan-maize-lightest p-2 md:p-4 rounded-lg border-2 border-michigan-maize"> <h4 class="font-bold text-michigan-blue mb-2">é¡§å®¢æ—ç¾¤</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.customer_segments)}</ul> </div>
                    <div class="md:col-span-3 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">æˆæœ¬çµæ§‹</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.cost_structure)}</ul> </div>
                    <div class="md:col-span-2 bg-white p-2 md:p-4 rounded-lg border"> <h4 class="font-bold text-michigan-blue mb-2">æ”¶ç›Šæµ</h4> <ul class="list-disc list-inside space-y-1">${renderList(data.revenue_streams)}</ul> </div>
                </div>`;
        }

        function renderVpc(container, data) {
            const renderList = (items) => (items || []).map(item => `<li class="text-sm">${item}</li>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div class="bg-white p-4 rounded-xl border-2 border-michigan-blue h-full flex flex-col"> <h4 class="font-bold text-michigan-blue text-lg mb-3 text-center">åƒ¹å€¼åœ°åœ–</h4> <div class="space-y-4 flex-grow"> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ ç”¢å“èˆ‡æœå‹™</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.products_services)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ’Š ç—›é»è§£æ–¹</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.pain_relievers)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">âœ¨ ç²ç›Šå‰µé€ è€…</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.value_map?.gain_creators)}</ul> </div> </div> </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-michigan-maize h-full flex flex-col"> <h4 class="font-bold text-michigan-blue text-lg mb-3 text-center">é¡§å®¢è¼ªå»“</h4> <div class="space-y-4 flex-grow"> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ‘ æœŸæœ›ç²ç›Š</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.gains)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ‘ ç—›é»</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.pains)}</ul> </div> <hr> <div> <h5 class="font-semibold text-gray-700 mb-2">ğŸ“ é¡§å®¢ä»»å‹™</h5> <ul class="list-disc list-inside space-y-1 text-gray-600">${renderList(data.customer_profile?.jobs)}</ul> </div> </div> </div>
                </div>`;
        }

        function renderScamper(data) {
            const container = document.getElementById('scamper-result');
            if (!data || (!data.strategic_insights?.length && !data.scamper_solutions?.length)) {
                container.innerHTML = `<div class="text-center text-gray-500">AI æœªèƒ½ç”Ÿæˆ SCAMPER å‰µæ–°æ–¹æ¡ˆã€‚</div>`; return;
            }
            container.innerHTML = `
                ${data.strategic_insights?.length ? `<div class="bg-michigan-maize-lightest p-6 rounded-xl border-l-4 border-michigan-maize mb-8 card-shadow"> <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸ¯ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> ${data.strategic_insights.map(i => `<div class="bg-white p-4 rounded-lg border"><h4 class="font-semibold text-michigan-blue mb-2">${i.issue}</h4><p class="text-sm text-gray-700 mb-2">${i.description}</p><div class="text-xs text-gray-500"><strong>æ•¸æ“šä¾æ“šï¼š</strong> ${(i.data_sources || []).join(', ')}</div></div>`).join('')} </div> </div>` : ''}
                ${data.scamper_solutions?.length ? `<div class="mb-8"> <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸ§© SCAMPERå‰µæ–°æ–¹æ¡ˆ</h3> <div class="space-y-4"> ${data.scamper_solutions.map(s => `<details class="bg-white p-4 rounded-xl border card-shadow"><summary class="font-semibold text-michigan-blue cursor-pointer">${s.technique}: ${s.solution.title}</summary><div class="mt-3 pt-3 border-t"><p class="text-sm text-gray-700 mb-2">${s.solution.description}</p><p class="text-xs text-gray-600"><strong>é æœŸæ•ˆç›Š:</strong> ${(s.solution.expected_benefits || []).join(', ')}</p><p class="text-xs text-gray-500 mt-1"><strong>å°æ‡‰è­°é¡Œ:</strong> ${s.strategic_issue}</p></div></details>`).join('')} </div> </div>` : ''}
                ${data.priority_ranking?.length ? `<div class="bg-michigan-blue-lightest p-6 rounded-xl border-l-4 border-michigan-blue card-shadow"> <h3 class="font-bold text-michigan-blue text-xl mb-4">ğŸš€ å„ªå…ˆå¯¦æ–½å»ºè­°</h3> <ol class="list-decimal list-inside space-y-2 text-gray-800"> ${data.priority_ranking.map(p => `<li>${(typeof p === 'object' && p !== null) ? (p.title || 'ç„¡æ¨™é¡Œå»ºè­°') : p}</li>`).join('')} </ol> </div>` : ''}
            `;
        }
        
        function renderBlueOcean(data) {
            const container = document.getElementById('blue-ocean-result');
            const renderActions = (actions) => (actions || []).map(item => `<div class="bg-white p-3 rounded-md border"><h5 class="font-semibold text-gray-800">${item.action}</h5><p class="text-xs text-gray-600 mt-1">${item.rationale}</p></div>`).join('');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">å››é …è¡Œå‹•æ¶æ§‹ (ERRC Grid)</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> <div class="bg-red-50 p-4 rounded-lg"><h4 class="font-bold text-red-700 mb-3">ğŸš« æ¶ˆé™¤</h4><div class="space-y-3">${renderActions(data.eliminate)}</div></div> <div class="bg-yellow-50 p-4 rounded-lg"><h4 class="font-bold text-yellow-700 mb-3">ğŸ“‰ æ¸›å°‘</h4><div class="space-y-3">${renderActions(data.reduce)}</div></div> <div class="bg-blue-50 p-4 rounded-lg"><h4 class="font-bold text-blue-700 mb-3">ğŸ“ˆ æå‡</h4><div class="space-y-3">${renderActions(data.raise)}</div></div> <div class="bg-green-50 p-4 rounded-lg"><h4 class="font-bold text-green-700 mb-3">âœ¨ å‰µé€ </h4><div class="space-y-3">${renderActions(data.create)}</div></div> </div>`;
        }

        function renderDesignThinking(data) {
            const container = document.getElementById('design-thinking-result');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">è¨­è¨ˆæ€ç¶­äº”éšæ®µæµç¨‹</h3> <div class="space-y-4"> ${(data.stages || []).map(s => `<div class="bg-michigan-blue-lightest p-5 rounded-xl border-l-4 border-michigan-blue"> <h4 class="font-bold text-michigan-blue text-lg">${s.stage}</h4> <p class="text-sm text-gray-700 my-2">${s.description}</p> <h5 class="font-semibold text-gray-800 text-sm mb-2">é—œéµè¡Œå‹• / å•é¡Œ:</h5> <ul class="list-disc list-inside text-sm text-gray-600 space-y-1"> ${(s.actions || []).map(a => `<li>${a}</li>`).join('')} </ul> </div>`).join('')} </div>`;
        }

        function renderLeanStartup(data) {
            const container = document.getElementById('lean-startup-result');
            if(!data) return;
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">${data.title || 'ç²¾å¯¦å‰µæ¥­è¡Œå‹•è¨ˆç•«'}</h3> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div class="bg-blue-50 p-5 rounded-lg border border-blue-200"> <h4 class="font-bold text-blue-800 text-2xl mb-3">1. å»ºç«‹</h4> <h5 class="font-semibold text-blue-700">é—œéµå‡è¨­</h5><p class="text-sm text-gray-700 mb-4">${data.build?.key_hypothesis || ''}</p> <h5 class="font-semibold text-blue-700">MVP å»ºè­°: ${data.build?.mvp_suggestion?.name || ''}</h5> <p class="text-sm text-gray-700 mb-2">${data.build?.mvp_suggestion?.description || ''}</p> <ul class="list-disc list-inside text-xs text-gray-600">${(data.build?.mvp_suggestion?.features || []).map(f => `<li>${f}</li>`).join('')}</ul> </div> <div class="bg-green-50 p-5 rounded-lg border border-green-200"> <h4 class="font-bold text-green-800 text-2xl mb-3">2. è¡¡é‡</h4> <h5 class="font-semibold text-green-700">é—œéµæŒ‡æ¨™</h5><ul class="text-sm text-gray-700 mb-4 space-y-2">${(data.measure?.key_metrics || []).map(m => `<li><strong>${m.metric}:</strong> ${m.definition}</li>`).join('')}</ul> <h5 class="font-semibold text-green-700">è¡¡é‡æ–¹æ³•</h5> <p class="text-sm text-gray-700">${data.measure?.measurement_method || ''}</p> </div> <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-200"> <h4 class="font-bold text-yellow-800 text-2xl mb-3">3. å­¸ç¿’</h4> <h5 class="font-semibold text-yellow-700">æ±ºç­–é»: å …æŒæˆ–è½‰å‘?</h5> <p class="text-sm text-gray-700 mb-4">${data.learn?.pivot_or_persevere || ''}</p> <h5 class="font-semibold text-yellow-700">å­¸ç¿’å•é¡Œ</h5> <ul class="list-disc list-inside text-sm text-gray-700">${(data.learn?.learning_questions || []).map(q => `<li>${q}</li>`).join('')}</ul> </div> </div>`;
        }

        function renderTenTypes(data) {
            const container = document.getElementById('ten-types-result');
            container.innerHTML = `<h3 class="font-bold text-michigan-blue text-xl mb-4 text-center">åå¤§å‰µæ–°é¡å‹æ©Ÿæœƒé»</h3> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> ${(data.categories || []).map(c => `<div class="bg-michigan-blue-lightest p-5 rounded-lg"> <h4 class="font-bold text-michigan-blue text-lg mb-2">${c.name}</h4> <p class="text-xs text-gray-600 mb-4">${c.description}</p> <div class="space-y-4"> ${(c.types || []).map(t => `<div class="bg-white p-3 rounded-md"> <h5 class="font-semibold text-gray-800 text-sm">${t.type_name}</h5> <ul class="list-disc list-inside text-xs text-gray-600 mt-2"> ${(t.ideas || []).map(i => `<li>${i}</li>`).join('')} </ul> </div>`).join('')} </div> </div>`).join('')} </div>`;
        }

        function renderFinalRecommendations(data) {
            const container = document.getElementById('final-recommendations');
            container.innerHTML = `<div class="space-y-6"> <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize"><h4 class="font-bold text-michigan-blue text-lg mb-2">æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h4><p class="text-gray-800">${data?.strategic_insight || ''}</p></div> <div class="bg-michigan-blue-lightest p-5 rounded-lg border-l-4 border-michigan-blue"><h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸš€ ç«‹å³è¡Œå‹• (30å¤©å…§)</h4><ul class="list-disc list-inside text-gray-800 space-y-1">${(data?.immediate_actions || []).map(a => `<li>${a}</li>`).join('')}</ul></div> <div class="bg-white p-5 rounded-lg border"><h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸ—ºï¸ å­£åº¦åŸ·è¡Œè·¯ç·šåœ–</h4><div class="space-y-2">${(data?.quarterly_roadmap || []).map(q => `<div><strong class="text-michigan-blue">${q.quarter}:</strong> ${q.focus}</div>`).join('')}</div></div> <div class="bg-michigan-maize-lightest p-5 rounded-lg border-l-4 border-michigan-maize"><h4 class="font-bold text-michigan-blue text-lg mb-2">ğŸ”® é•·æœŸé¡˜æ™¯</h4><p class="text-gray-800">${data?.long_term_vision || ''}</p></div> </div>`;
        }
        
        function renderErrorCard(modelId, message) {
            const model = availableModels.find(m => m.id === modelId);
            const container = document.createElement('div');
            container.className = 'bg-red-100 p-6 rounded-xl border-l-4 border-red-500 card-shadow';
            container.innerHTML = `<h4 class="font-bold text-red-800 text-xl">${model.name} åˆ†æå¤±æ•—</h4> <p class="text-red-700 mt-2">åŸå› ï¼š${message}</p> <p class="text-red-600 text-sm mt-2">å»ºè­°ï¼šè«‹æª¢æŸ¥API Keyè¨­å®šæˆ–ç¶²è·¯é€£ç·šï¼Œæˆ–ç°¡åŒ–å•é¡Œæè¿°å¾Œé‡è©¦ã€‚</p>`;
            document.getElementById('analysis-dashboard').appendChild(container);
        }
        
        function renderFinalRecommendationsError(message) {
            const container = document.getElementById('final-recommendations');
            container.innerHTML = `<div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-500"><h4 class="font-bold text-red-800">æ•´åˆè¨ºæ–·å ±å‘Šç”Ÿæˆå¤±æ•—</h4><p class="text-sm text-red-700 mt-1">åŸå› ï¼š${message}</p></div>`;
        }
        
        function giveFeedback(button, modelId, rating) {
            console.log(`Feedback for ${modelId}: ${rating}`);
            const parent = button.parentElement;
            parent.querySelectorAll('.feedback-button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }

        function safeJSONParse(rawString) {
            try { return JSON.parse(rawString); } catch (e1) {
                try {
                    const match = rawString.match(/```json\s*([\s\S]*?)\s*```/);
                    if (match && match[1]) return JSON.parse(match[1]);
                    const start = rawString.indexOf('{');
                    const end = rawString.lastIndexOf('}');
                    if (start > -1 && end > -1) return JSON.parse(rawString.substring(start, end + 1));
                    throw new Error("åœ¨å­—ä¸²ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„JSONã€‚");
                } catch (e2) {
                    console.error("JSON è§£æéŒ¯èª¤:", e2, "åŸå§‹å­—ä¸²:", rawString);
                    return { error: true, message: "AI å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æã€‚" };
                }
            }
        }
        
        function generateReport() {
            const currentDate = new Date().toLocaleDateString('zh-TW');
            const companyName = diagnosisData.context?.industry ? `${diagnosisData.context.industry}ä¼æ¥­` : 'ç›®æ¨™ä¼æ¥­';
            let htmlContent = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>A2PSDM AI æˆ°ç•¥è¨ºæ–·å ±å‘Š</title><style>body{font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;line-height:1.8;padding:40px;max-width:1000px;margin:auto;color:#333;background:#fdfdfd}.header{text-align:center;border-bottom:4px solid #00274c;padding-bottom:30px;margin-bottom:40px}.header h1{color:#00274c;font-size:2.5em;margin-bottom:10px}.header .subtitle{color:#ffcb05;background:#00274c;padding:8px 20px;display:inline-block;border-radius:20px;font-weight:700}.meta-info{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px;border-left:5px solid #ffcb05}.section{margin-bottom:40px;page-break-inside:avoid}.section h2{color:#00274c;border-bottom:2px solid #ffcb05;padding-bottom:10px;margin-bottom:20px;font-size:1.8em}.section h3{color:#00274c;margin-top:25px;margin-bottom:15px;font-size:1.5em;border-left:4px solid #00274c;padding-left:10px}.section h4{color:#00274c;margin-top:20px;margin-bottom:10px;font-size:1.2em;font-weight:700}.section h5{color:#333;margin:10px 0 5px;font-size:1em;font-weight:700}.executive-summary{background:linear-gradient(135deg,#e8f0f7,#f0f8ff);padding:25px;border-radius:15px;border:1px solid #00274c;margin-bottom:30px}.analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}.analysis-card{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:20px;box-shadow:0 4px 8px #0000000d}.swot-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0}.swot-card{padding:15px;border-radius:8px;border-left:5px solid}.swot-strengths{background:#d4edda;border-left-color:#28a745}.swot-weaknesses{background:#f8d7da;border-left-color:#dc3545}.swot-opportunities{background:#d1ecf1;border-left-color:#17a2b8}.swot-threats{background:#fff3cd;border-left-color:#ffc107}.recommendation-box{background:linear-gradient(135deg,#fff2a6,#ffcb05);padding:20px;border-radius:10px;margin:15px 0;border:1px solid #00274c}.action-item{background:#f8f9fa;padding:15px;margin:10px 0;border-left:4px solid #00274c;border-radius:5px}ul,ol{padding-left:25px;margin:10px 0}li{margin-bottom:8px;line-height:1.6}.footer{margin-top:50px;padding-top:30px;border-top:2px solid #00274c;text-align:center;color:#666}.page-break{page-break-before:always}@media print{body{padding:20px}}</style></head><body><div class="header"><h1>AI æˆ°ç•¥è¨ºæ–·å ±å‘Š</h1><div class="subtitle">A2PSDM Ã— ç‹åšå£« Ã— ç³»çµ±æ€ç¶­åˆ†æ</div></div><div class="meta-info"><h4>ğŸ“‹ è¨ºæ–·åŸºæœ¬è³‡è¨Š</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px"><div><strong>è¨ºæ–·å°è±¡ï¼š</strong>${companyName}</div><div><strong>ç”¢æ¥­åˆ¥ï¼š</strong>${diagnosisData.context?.industry||"N/A"}</div><div><strong>ä¼æ¥­è¦æ¨¡ï¼š</strong>${diagnosisData.context?.companySize||"N/A"}</div><div><strong>å•†æ¥­æ¨¡å¼ï¼š</strong>${diagnosisData.context?.businessModel||"N/A"}</div><div><strong>å ±å‘Šæ—¥æœŸï¼š</strong>${currentDate}</div><div><strong>è¨ºæ–·æ¨¡å‹ï¼š</strong>${diagnosisData.selectedModels?diagnosisData.selectedModels.join(", ").toUpperCase():"N/A"}</div></div></div><div class="section"><h2>ğŸ¯ æ ¸å¿ƒæŒ‘æˆ°æè¿°</h2><div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:5px solid #dc3545"><p style="font-size:1.1em;line-height:1.8;margin:0">${diagnosisData.context?.problem||"æœªæä¾›å…·é«”æŒ‘æˆ°æè¿°"}</p></div></div>`;
            if (diagnosisData.finalRecommendations?.strategic_insight) { htmlContent += `<div class="section"><h2>ğŸ“Š åŸ·è¡Œæ‘˜è¦</h2><div class="executive-summary"><h3 style="margin-top:0;color:#00274c">æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h3><p style="font-size:1.1em;line-height:1.8">${diagnosisData.finalRecommendations.strategic_insight}</p></div></div>`; }
            htmlContent += `<div class="section page-break"><h2>ğŸ“ˆ åˆå§‹ç­–ç•¥åˆ†æ</h2></div>`;
            if (diagnosisData.analysisResults?.swot) { htmlContent += `<div class="section"><h3>SWOT æˆ°ç•¥åˆ†æ</h3><div class="swot-grid"><div class="swot-card swot-strengths"><h4>ğŸ’ª å„ªå‹¢ (S)</h4><ul>${(diagnosisData.analysisResults.swot.strengths||[]).map(s=>`<li>${s}</li>`).join("")}</ul></div><div class="swot-card swot-weaknesses"><h4>âš ï¸ åŠ£å‹¢ (W)</h4><ul>${(diagnosisData.analysisResults.swot.weaknesses||[]).map(w=>`<li>${w}</li>`).join("")}</ul></div><div class="swot-card swot-opportunities"><h4>ğŸš€ æ©Ÿæœƒ (O)</h4><ul>${(diagnosisData.analysisResults.swot.opportunities||[]).map(o=>`<li>${o}</li>`).join("")}</ul></div><div class="swot-card swot-threats"><h4>âš¡ å¨è„… (T)</h4><ul>${(diagnosisData.analysisResults.swot.threats||[]).map(t=>`<li>${t}</li>`).join("")}</ul></div></div></div>`; }
            if (diagnosisData.analysisResults?.porters) { const p=diagnosisData.analysisResults.porters;htmlContent+=`<div class="section"><h3>ç”¢æ¥­ç«¶çˆ­åŠ›åˆ†æ (æ³¢ç‰¹äº”åŠ›)</h3><div class="analysis-grid">${(p.forces||[]).map(f=>{const l=f.level==="é«˜"?"#dc3545":f.level==="ä¸­"?"#ffc107":"#28a745";return`<div class="analysis-card"><h4>${f.name} <span style="background:${l};color:#fff;padding:3px 8px;border-radius:12px;font-size:.8em;float:right">${f.level}</span></h4><p>${f.reason}</p></div>`}).join("")}</div><div class="recommendation-box"><h4 style="margin-top:0">ğŸ“‹ ç”¢æ¥­ç«¶çˆ­ç¸½çµ</h4><p style="margin-bottom:0">${p.summary||""}</p></div></div>`;}
            if(diagnosisData.analysisResults?.pestel){const p=diagnosisData.analysisResults.pestel,l={political:"ğŸ›ï¸ æ”¿æ²»",economic:"ğŸ’° ç¶“æ¿Ÿ",social:"ğŸ‘¥ ç¤¾æœƒ",technological:"ğŸ”¬ æŠ€è¡“",environmental:"ğŸŒ ç’°å¢ƒ",legal:"âš–ï¸ æ³•å¾‹"};htmlContent+=`<div class="section"><h3>ç¸½é«”ç’°å¢ƒåˆ†æ (PESTEL)</h3><div class="analysis-grid">${Object.entries(p).map(([k,v])=>`<div class="analysis-card"><h4>${l[k]||k}</h4><ul>${(v||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div>`).join("")}</div></div>`}
            if(diagnosisData.analysisResults?.vpc){const v=diagnosisData.analysisResults.vpc;htmlContent+=`<div class="section"><h3>åƒ¹å€¼ä¸»å¼µåˆ†æ (VPC)</h3><div class="analysis-grid"><div class="analysis-card"><h4>âœ¨ åƒ¹å€¼åœ°åœ–</h4><h5>ç”¢å“èˆ‡æœå‹™</h5><ul>${(v.value_map?.products_services||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>ç—›é»è§£æ–¹</h5><ul>${(v.value_map?.pain_relievers||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>ç²ç›Šå‰µé€ è€…</h5><ul>${(v.value_map?.gain_creators||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ‘¤ é¡§å®¢è¼ªå»“</h4><h5>é¡§å®¢ä»»å‹™</h5><ul>${(v.customer_profile?.jobs||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>ç—›é»</h5><ul>${(v.customer_profile?.pains||[]).map(i=>`<li>${i}</li>`).join("")}</ul><h5>æœŸæœ›ç²ç›Š</h5><ul>${(v.customer_profile?.gains||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div></div></div>`}
            if(diagnosisData.analysisResults?.bmc){const b=diagnosisData.analysisResults.bmc;htmlContent+=`<div class="section"><h3>å•†æ¥­æ¨¡å¼åˆ†æ (BMC)</h3><div class="analysis-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"><div class="analysis-card"><h4>ğŸ¤ é—œéµåˆä½œå¤¥ä¼´</h4><ul>${(b.key_partnerships||[]).map(p=>`<li>${p}</li>`).join("")}</ul></div><div class="analysis-card"><h4>âš¡ é—œéµæ´»å‹•</h4><ul>${(b.key_activities||[]).map(a=>`<li>${a}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ åƒ¹å€¼ä¸»å¼µ</h4><ul>${(b.value_propositions||[]).map(v=>`<li>${v}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ‘¥ é¡§å®¢é—œä¿‚</h4><ul>${(b.customer_relationships||[]).map(r=>`<li>${r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ¯ ç›®æ¨™å®¢ç¾¤</h4><ul>${(b.customer_segments||[]).map(s=>`<li>${s}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ”‘ é—œéµè³‡æº</h4><ul>${(b.key_resources||[]).map(r=>`<li>${r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ“¢ é€šè·¯ç®¡é“</h4><ul>${(b.channels||[]).map(c=>`<li>${c}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ’° æ”¶ç›Šæµ</h4><ul>${(b.revenue_streams||[]).map(r=>`<li>${r}</li>`).join("")}</ul></div><div class="analysis-card"><h4>ğŸ’¸ æˆæœ¬çµæ§‹</h4><ul>${(b.cost_structure||[]).map(c=>`<li>${c}</li>`).join("")}</ul></div></div></div>`}
            htmlContent += `<div class="section page-break"><h2>ğŸ’¡ å‰µæ–°æ–¹æ¡ˆè¨­è¨ˆå·¥å…·ç®±</h2></div>`;
            if(diagnosisData.scamper){const s=diagnosisData.scamper;htmlContent+=`<div class="section"><h3>ğŸ§© SCAMPER å‰µæ–°è§£æ±ºæ–¹æ¡ˆ</h3>${(s.strategic_insights||[]).length>0?`<h4>ğŸ¯ æ ¸å¿ƒæˆ°ç•¥æ´å¯Ÿ</h4><div class="analysis-grid">${s.strategic_insights.map(i=>`<div class="analysis-card" style="border-left:5px solid #ffcb05"><h5>${i.issue}</h5><p>${i.description}</p><p style="font-size:.9em;color:#666"><strong>æ•¸æ“šä¾æ“š:</strong> ${(i.data_sources||[]).join(", ")}</p></div>`).join("")}</div>`:""}<h4 style="margin-top:20px">ğŸ’¡ å…·é«”å‰µæ–°æ–¹æ¡ˆ</h4>${(s.scamper_solutions||[]).map(s=>`<div class="analysis-card" style="margin-bottom:15px"><h5>${s.technique}: ${s.solution.title}</h5><p>${s.solution.description}</p><ul><li><strong>å°æ‡‰è­°é¡Œ:</strong> ${s.strategic_issue}</li><li><strong>é æœŸæ•ˆç›Š:</strong> ${(s.solution.expected_benefits||[]).join(", ")}</li></ul></div>`).join("")}${(s.priority_ranking||[]).length>0?`<h4 style="margin-top:20px">ğŸš€ å„ªå…ˆå¯¦æ–½å»ºè­°</h4><ol>${s.priority_ranking.slice(0,5).map(p=>`<li>${(typeof p === 'object' && p !== null) ? (p.title || 'ç„¡æ¨™é¡Œå»ºè­°') : p}</li>`).join("")}</ol>`:""}</div>`}
            if(diagnosisData.blue_ocean){const b=diagnosisData.blue_ocean,r=a=>(a||[]).map(i=>`<div class="analysis-card" style="padding:15px;margin-bottom:10px"><h5>${i.action}</h5><p style="font-size:.9em;margin:0">${i.rationale}</p></div>`).join("");htmlContent+=`<div class="section"><h3>ğŸŒŠ è—æµ·ç­–ç•¥åˆ†æ (ERRC)</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div style="background:#f8d7da;padding:15px;border-radius:8px"><h4 style="color:#721c24">ğŸš« æ¶ˆé™¤</h4>${r(b.eliminate)}</div><div style="background:#fff3cd;padding:15px;border-radius:8px"><h4 style="color:#856404">ğŸ“‰ æ¸›å°‘</h4>${r(b.reduce)}</div><div style="background:#d1ecf1;padding:15px;border-radius:8px"><h4 style="color:#0c5460">ğŸ“ˆ æå‡</h4>${r(b.raise)}</div><div style="background:#d4edda;padding:15px;border-radius:8px"><h4 style="color:#155724">âœ¨ å‰µé€ </h4>${r(b.create)}</div></div></div>`}
            if(diagnosisData.design_thinking){htmlContent+=`<div class="section"><h3>ğŸ§  è¨­è¨ˆæ€ç¶­æµç¨‹</h3>${(diagnosisData.design_thinking.stages||[]).map(s=>`<div class="analysis-card" style="margin-bottom:15px;border-left:5px solid #00274c"><h4>${s.stage}</h4><p>${s.description}</p><h5>é—œéµè¡Œå‹•/å•é¡Œ:</h5><ul>${(s.actions||[]).map(a=>`<li>${a}</li>`).join("")}</ul></div>`).join("")}</div>`}
            if(diagnosisData.lean_startup){const l=diagnosisData.lean_startup;htmlContent+=`<div class="section"><h3>ğŸš€ ç²¾å¯¦å‰µæ¥­è¡Œå‹•è¨ˆç•«</h3><h4>${l.title||""}</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px"><div class="analysis-card" style="background:#d1ecf1"><h4>1. å»ºç«‹</h4><h5>é—œéµå‡è¨­</h5><p>${l.build?.key_hypothesis||""}</p><h5>MVPå»ºè­°: ${l.build?.mvp_suggestion?.name||""}</h5><p>${l.build?.mvp_suggestion?.description||""}</p><ul>${(l.build?.mvp_suggestion?.features||[]).map(f=>`<li>${f}</li>`).join("")}</ul></div><div class="analysis-card" style="background:#d4edda"><h4>2. è¡¡é‡</h4><h5>é—œéµæŒ‡æ¨™</h5><ul>${(l.measure?.key_metrics||[]).map(m=>`<li><strong>${m.metric}:</strong> ${m.definition}</li>`).join("")}</ul><h5>è¡¡é‡æ–¹æ³•</h5><p>${l.measure?.measurement_method||""}</p></div><div class="analysis-card" style="background:#fff3cd"><h4>3. å­¸ç¿’</h4><h5>æ±ºç­–é»</h5><p>${l.learn?.pivot_or_persevere||""}</p><h5>å­¸ç¿’å•é¡Œ</h5><ul>${(l.learn?.learning_questions||[]).map(q=>`<li>${q}</li>`).join("")}</ul></div></div></div>`}
            if(diagnosisData.ten_types){htmlContent+=`<div class="section"><h3>ğŸ”Ÿ åå¤§å‰µæ–°é¡å‹æ©Ÿæœƒé»</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">${(diagnosisData.ten_types.categories||[]).map(c=>`<div class="analysis-card" style="background:#e8f0f7"><h4>${c.name}</h4><p style="font-size:.9em">${c.description}</p>${(c.types||[]).map(t=>`<div style="background:#fff;padding:10px;border-radius:5px;margin-top:10px"><h5>${t.type_name}</h5><ul>${(t.ideas||[]).map(i=>`<li>${i}</li>`).join("")}</ul></div>`).join("")}</div>`).join("")}</div></div>`}
            if (diagnosisData.finalRecommendations) { const f = diagnosisData.finalRecommendations; htmlContent += `<div class="section page-break"><h2>ğŸš€ æˆ°ç•¥å»ºè­°èˆ‡è¡Œå‹•æ–¹æ¡ˆ</h2><div class="recommendation-box"><h3 style="margin-top:0">âš¡ ç«‹å³è¡Œå‹•æ–¹æ¡ˆ (30å¤©å…§)</h3><div class="action-item"><ol>${(f.immediate_actions || []).map(a => `<li>${a}</li>`).join('')}</ol></div></div><h3>ğŸ—ºï¸ å­£åº¦åŸ·è¡Œè·¯ç·šåœ–</h3><div class="analysis-grid">${(f.quarterly_roadmap || []).map(q => `<div class="analysis-card"><h4>${q.quarter}</h4><p>${q.focus}</p></div>`).join('')}</div><div class="recommendation-box"><h3 style="margin-top:0">ğŸ”® é•·æœŸé¡˜æ™¯</h3><p style="font-size:1.1em;line-height:1.8;margin-bottom:0">${f.long_term_vision || ''}</p></div></div>`; }
            htmlContent += `<div class="footer"><h3>é—œæ–¼ A2PSDM é¡§å•æœå‹™</h3><p><strong>ç‹åšå£«</strong> | A2PSDM</p><p>å¯†è¥¿æ ¹å¤§å­¸åšå£« Ã— 30å¹´ç”¢æ¥­ç¶“é©— Ã— AIå‰µæ–°æ•´åˆ</p><p>æœ¬å ±å‘Šç”± A2PSDM AI è¨ºæ–·å¹³å°ç”Ÿæˆ | Â© 2025 A2PSDM</p><p style="margin-top:20px;font-size:.9em;color:#888">å¦‚éœ€æ·±åº¦è«®è©¢æœå‹™ï¼Œè«‹è¯ç¹«ï¼šdr.cliffwang@a2psdm.com</p></div></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `A2PSDM_æˆ°ç•¥è¨ºæ–·å ±å‘Š_${currentDate.replace(/\//g, '')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function scheduleConsultation() {
            const subject = encodeURIComponent('A2PSDMæ·±åº¦æˆ°ç•¥è«®è©¢é ç´„ç”³è«‹');
            const body = encodeURIComponent(`ç‹åšå£«åœ˜éšŠï¼š\n\næˆ‘å·²é€éAIè¨ºæ–·å¹³å°å®Œæˆåˆæ­¥åˆ†æï¼Œå¸Œæœ›é ç´„æ·±åº¦è«®è©¢ã€‚\n\nè¨ºæ–·æŒ‘æˆ°ï¼š${diagnosisData.context?.problem || 'å¾…å¡«å¯«'}\n\næœŸå¾…æ‚¨çš„å°ˆæ¥­æŒ‡å°ï¼`);
            window.open(`mailto:dr.cliffwang@a2psdm.com?subject=${subject}&body=${body}`);
        }

        window.onload = () => {
            const modelSelectionDiv = document.getElementById('model-selection');
            availableModels.forEach(model => {
                const modelElement = document.createElement('div');
                modelElement.innerHTML = `<input type="checkbox" id="model-${model.id}" value="${model.id}" class="hidden model-checkbox" checked><label for="model-${model.id}" class="block border-2 border-gray-300 rounded-lg p-4 cursor-pointer transition-all duration-200 hover:border-michigan-blue"><h4 class="font-bold text-michigan-blue">${model.name}</h4><p class="text-sm text-gray-600 mt-1">${model.description}</p></label>`;
                modelSelectionDiv.appendChild(modelElement);
            });
            try {
                const s = getSettings();
                if (s.provider) document.getElementById('aiProvider').value = s.provider;
                if (s.apiKey) document.getElementById('apiKey').value = s.apiKey;
                runtimeSettings = s;
            } catch(e){ console.warn('è¨­å®šè¼‰å…¥å¤±æ•—', e); }
            updateProgress(1);
        };
    </script>
</body>
</html>

